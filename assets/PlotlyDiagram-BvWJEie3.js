import{d as z,j as b,B as d,g as D,U as w,n as C}from"./index-D_sw2g-2.js";import{Y as j}from"./index-DFKcNkqO.js";import{V as _}from"./VuePlotly-DYaHLKLL.js";import{i as E,H as F}from"./HTTPFileSystem-ChhivMzi.js";import{D as k}from"./DashboardDataManager-mkjvCydQ.js";import{L as M}from"./ColorsAndWidths-D0mbSer2.js";import"./fxp-DjoqftHf.js";import"./group-hI8ly2Wr.js";import"./index-_doEQLKC.js";import"./cubehelix-BzW-tINw.js";import"./threshold-CrWFx_nu.js";import"./rainbow-DNS2KC2A.js";const I={messages:{en:{total:"total",showChanges:"Only show changes"},de:{total:"Insgesamt",showChanges:"Nur Ã„nderungen zeigen"}}},S=z({name:"PlotlyPlugin",components:{VuePlotly:_},i18n:I,props:{root:{type:String,required:!0},subfolder:{type:String,required:!0},config:{type:Object},datamanager:{type:Object},resize:Object,thumbnail:Boolean,yamlConfig:String},data(){return{globalState:D.state,vizDetails:{title:"",description:""},loadingText:"",jsonChart:{},id:`plotly-id-${Math.floor(1e12*Math.random())}`,traces:[],prevWidth:-1,prevHeight:-1,attributeColorMap:new Map,colorway:["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf"],myDataManager:this.datamanager||new k(this.root,this.subfolder),layout:{margin:{t:8,b:0,l:50,r:0,pad:2},font:{color:"#444444",family:w},xaxis:{automargin:!0,autorange:!0,range:[0,100],title:{text:"",standoff:12},animate:!0},yaxis:{automargin:!0,autorange:!0,range:[0,100],title:{text:"",standoff:16},animate:!0,rangemode:"tozero"},yaxis2:{automargin:!0,autorange:!0,range:[0,100],title:{text:"",standoff:16},animate:!0,rangemode:"tozero",matches:"y",anchor:"x2"},legend:{orientation:"v",x:1,y:1},grid:{rows:1,columns:1}},options:{displaylogo:!1,responsive:!0,modeBarButtonsToRemove:["pan2d","zoom2d","select2d","lasso2d","zoomIn2d","zoomOut2d","autoScale2d","hoverClosestCartesian","hoverCompareCartesian","resetScale2d","toggleSpikelines","resetViewMapbox"],toImageButtonOptions:{format:"png",filename:"chart",width:null,height:null}},minXValue:Number.POSITIVE_INFINITY,minYValue:Number.POSITIVE_INFINITY,maxXValue:Number.NEGATIVE_INFINITY,maxYValue:Number.NEGATIVE_INFINITY,isUsingFacets:!1}},computed:{fileApi(){return new F(this.fileSystem,D)},fileSystem(){const t=this.$store.state.svnProjects.filter(e=>e.slug===this.root);if(t.length===0)throw console.log("no such project"),Error;return t[0]}},watch:{"globalState.resizeEvents"(){this.changeDimensions({})},resize(t){this.changeDimensions(t)},"globalState.isDarkMode"(){this.updateTheme()}},async mounted(){if(this.updateTheme(),await this.getVizDetails(),!this.thumbnail){try{this.vizDetails.datasets&&await this.prepareData(),this.vizDetails.traces&&(this.traces=this.vizDetails.traces),this.vizDetails.layout&&this.mergeLayouts(),this.vizDetails.fixedRatio&&(this.vizDetails.layout.xaxis=Object.assign(this.vizDetails.layout.xaxis,{constrain:"domain"}),this.vizDetails.layout.yaxis=Object.assign(this.vizDetails.layout.yaxis,{constrain:"domain",scaleanchor:"x",scaleration:1})),this.vizDetails.dropdownMenu&&(this.vizDetails.interactive="dropdown"),this.vizDetails.interactive&&this.createMenus(this.vizDetails.interactive),this.vizDetails.interactive&&this.config.interactive==="slider"&&this.setFixedAxis()}catch(t){const e=t;console.error({e}),this.$emit("error",""+e),this.loadingText=""+e}this.updateTheme(),window.addEventListener("resize",this.changeDimensions),this.layout.margin={r:0,t:8,b:0,l:50,pad:2},this.createFacets(),Array.isArray(this.traces[0].x[0])&&(this.layout.xaxis.autotickangles=[0,90])}},beforeDestroy(){window.removeEventListener("resize",this.changeDimensions)},methods:{setFixedAxis(){for(let t=0;t<this.traces.length;t++){const e=Math.min(...this.traces[t].y),i=Math.max(...this.traces[t].y),s=Math.min(...this.traces[t].x),n=Math.max(...this.traces[t].x);n>=this.maxXValue&&(this.maxXValue=n),i>=this.maxYValue&&(this.maxYValue=i),e<=this.minYValue&&(this.minYValue=e),s<=this.minXValue&&(this.minXValue=s)}this.layout.xaxis.range=[this.minXValue,this.maxXValue],this.layout.yaxis.range=[this.minYValue,this.maxYValue],this.layout.xaxis.autorange=!1,this.layout.yaxis.autorange=!1},changeDimensions(t){t?.height&&t?.width&&(t.height!==this.prevHeight||t.width!==this.prevWidth)&&(this.prevHeight=t.height,this.prevWidth=t.width,this.layout=Object.assign({},this.layout,t))},mergeLayouts(){const t={...this.vizDetails.layout};t.margin=this.layout.margin,t.font=this.layout.font,t.legend=this.layout.legend,delete t.height,delete t.width,t.xaxis?(t.xaxis.automargin=!0,t.xaxis.autorange=!0,t.xaxis.animate=!0,t.xaxis.title||(t.xaxis.title=this.layout.xaxis.title)):t.xaxis=this.layout.xaxis,t.yaxis?(t.yaxis.automargin=!0,t.yaxis.autorange=!0,t.yaxis.animate=!0,this.traces.find(e=>e?.type=="scatter")||t.yaxis.rangemode||(t.yaxis.rangemode="tozero"),t.yaxis.title||(t.yaxis.title=this.layout.yaxis.title)):t.yaxis=this.layout.yaxis,t.yaxis2?(t.yaxis2.automargin=!0,t.yaxis2.autorange=!0,t.yaxis2.animate=!0,t.yaxis2.rangemode||(t.yaxis2.rangemode="tozero"),t.yaxis2.title||(t.yaxis2.title=this.layout.yaxis2.title)):t.yaxis2=this.layout.yaxis2,this.layout=t},createFacets(){if(this.traces[0].facet_col==null&&this.traces[0].facet_row==null)return;this.isUsingFacets=!0,this.updateTheme();let t=[],e=[];this.traces[0].facet_col!=null&&(t=this.traces[0].facet_col.filter((i,s)=>this.traces[0].facet_col.indexOf(i)===s)),this.traces[0].facet_row!=null&&(e=this.traces[0].facet_row.filter((i,s)=>this.traces[0].facet_row.indexOf(i)===s)),this.groupTracesByFacets(t,e),this.vizDetails.interactive=="dropdown"&&(this.layout.grid={rows:1,columns:1},this.createMenus(this.vizDetails.interactive))},groupTracesByFacets(t,e){const i=this.layout.yaxis.title,s=this.layout.xaxis.title,n=[];let r=e.length,a=t.length;r==0&&(r=1),a==0&&(a=1),t.length==0?n.push(...this.groupTracesByFacetsForOneColumnOrRow(r,i,e,"y","facet_row")):e.length==0?n.push(...this.groupTracesByFacetsForOneColumnOrRow(a,s,t,"x","facet_col")):n.push(...this.groupTracesByFacetsColumnsAndRows(a,r,t,e,s,i)),this.layout.margin={t:10,b:20,l:60,r:60,pad:2},this.layout.grid={rows:r,columns:a},this.traces=n},assignColor(t){if(this.attributeColorMap.has(t.legendgroup))return this.attributeColorMap.get(t.legendgroup);{const e=this.attributeColorMap.size%this.colorway.length,i=this.colorway[e];return this.attributeColorMap.set(t.legendgroup,i),i}},groupTracesByFacetsColumnsAndRows(t,e,i,s,n,r){const a=[];for(let o=0;o<e;o++)for(let c=0;c<t;c++){const f=s[o],l=i[c],h=[];for(const m of this.traces){const p=[],x=[];for(let v=0;v<m.facet_row.length;v++)m.facet_row[v]===f&&m.facet_col[v]===l&&(p.push(m.x[v]),x.push(m.y[v]));const y={...m,x:p,y:x,xaxis:o>0?"x"+(o+1):"x",yaxis:c>0?"y"+(c+1):"y"};delete y.facet_row,delete y.facet_col,y.showlegend=o===0&&c===0,y.legendgroup=y.group_name,delete y.group_name;const O=this.assignColor(y);y.marker={color:O},h.push(y)}let g=o===0?"xaxis":"xaxis"+(o+1),u=c===0?"yaxis":"yaxis"+(c+1);this.layout[u]==null?this.layout[u]={title:{text:r+"<br>"+this.config.traces[0].facet_row.split(".")[1]+" = "+s[o]},anchor:"y",autorange:!0}:(this.layout[u].title="",this.layout[u].title={text:r+"<br>"+this.config.traces[0].facet_row.split(".")[1]+" = "+s[o]},this.layout[u].anchor="y"),this.layout[g]==null?this.layout[g]={title:{text:n+"<br>"+this.config.traces[0].facet_col.split(".")[1]+" = "+i[c]},anchor:"x",autorange:!0}:(this.layout[g].title="",this.layout[g].title={text:n+"<br>"+this.config.traces[0].facet_col.split(".")[1]+" = "+i[c]},this.layout[g].anchor="x"),a.push(...h)}return a},groupTracesByFacetsForOneColumnOrRow(t,e,i,s,n){e instanceof Object&&"text"in e&&(e=e.text);const r=[];for(let a=0;a<t;a++){const o=i[a],c=[];for(const h of this.traces){const g=[];for(let p=0;p<h[n].length;p++)h[n][p]===o&&g.push(h[s=="x"?"y":"x"][p]);let u={...h};this.vizDetails.interactive=="dropdown"&&this.isUsingFacets?u={...h,x:s=="y"?g:h.x,y:s=="x"?g:h.y,xaxis:s=="y",yaxis:s=="y"}:u={...h,x:s=="y"?g:h.x,y:s=="x"?g:h.y,xaxis:s=="y"?"x":a>0?"x"+(a+1):"x",yaxis:s=="y"&&a>0?"y"+(a+1):"y"},delete u.facet_row,delete u.facet_col,this.vizDetails.interactive=="dropdown"&&this.isUsingFacets?u.showlegend=!0:u.showlegend=a===0,u.legendgroup=u.group_name,delete u.group_name,u.facet_name=o;const m=this.assignColor(u);u.marker={color:m},c.push(u)}let f=this.config.traces[0][n].split(".")[1]+" = "+i[a];if(t*f.length>150&&s=="x"){const h=f.indexOf(" = ");f=f.substring(0,h)+"<br>"+f.substring(h)}const l=a===0?s+"axis":s+"axis"+(a+1);this.layout[l]==null?this.layout[l]={title:{text:e+(e?"<br>":"")+f}}:this.vizDetails.interactive||(this.layout[l].title="",this.layout[l].title={text:e+(e?"<br>":"")+f},this.layout[l].anchor="y"),r.push(...c)}return r},createMenus(t){if(t=="none")return;const e=[],i={},s=Object.values(this.traces).length;let n="group_name";this.vizDetails.interactive=="dropdown"&&this.isUsingFacets&&(n="facet_name"),Object.values(this.traces).forEach((o,c)=>{"original_name"in o&&(o.name=o.original_name),o[n]in i||(i[o[n]]=[]),i[o[n]].push(c),o.visible=!1}),Object.entries(i).forEach(o=>{const[c,f]=o,l=new Array(s);l.fill(!1);for(const h of f)l[h]=!0;e.push({method:"update",args:[{visible:l}],label:c})});const r=Object.values(i)[0];for(const o of r)this.traces[o].visible=!0;const a=this.layout;if(t=="dropdown"){const o=[{buttons:e,y:1,yanchor:"top"}];a.updatemenus=o}else if(t=="slider"){const o=[{pad:{t:10},currentvalue:{visible:!1,xanchor:"left",prefix:""},steps:e}];a.sliders=o}},updateTheme(){const t={paper_bgcolor:d[this.globalState.colorScheme],plot_bgcolor:this.isUsingFacets?b[this.globalState.colorScheme]:d[this.globalState.colorScheme],font:{color:this.globalState.isDarkMode?"#cccccc":"#444444"}};this.layout=Object.assign({},this.layout,t)},async getVizDetails(){if(this.config){this.vizDetails=JSON.parse(JSON.stringify(this.config)),this.$emit("title",this.vizDetails.title||"Chart"),this.vizDetails.traces&&(this.traces=this.vizDetails.traces);return}this.loadingText="Loading config...";const t=this.yamlConfig??"",e=t.indexOf("/")>-1?t:this.subfolder+"/"+t;try{const i=await this.fileApi.getFileText(e),s=j.parse(i);this.vizDetails=s,this.vizDetails.title||(this.vizDetails.title="Chart"),this.$emit("title",this.vizDetails.title)}catch(i){this.$emit("error",""+i)}},async prepareData(){await Promise.all(Object.entries(this.vizDetails.datasets).map(s=>{let[n,r]=s;return typeof r=="string"&&(r={file:r}),this.loadDataset(n,r)})),this.vizDetails.mergeDatasets&&Object.values(this.vizDetails.datasets).length>1&&(this.vizDetails.datasets={dataset:{name:"dataset",file:"none",data:this.mergeDatasets(Object.values(this.vizDetails.datasets))}});const t=Object.values(this.vizDetails.datasets),e=[],i=this.getColors(this.vizDetails,this.vizDetails.traces.length);this.vizDetails.traces.forEach((s,n)=>{let r=!1;t.forEach(a=>{const o="$"+a.name;if(s.name?.startsWith(o)){const c=s.name.replace(o+".",""),f=this.groupDataTable(a.data,c),l=Object.keys(f).length,h=this.getColors(s,l);Object.keys(f).forEach((g,u)=>{const m=JSON.parse(JSON.stringify(s));m.name=g,m.group_name=g,this.recursiveCheckForTemplate(f[g],m,o),h&&("marker"in s||(m.marker={}),m.marker.color=h[u]),e.push(m)}),r=!0}else this.recursiveCheckForTemplate(a.data,s,o)}),r||(i&&("marker"in s||(s.marker={}),s.marker.color=i[n]),e.push(s))}),this.vizDetails.traces=e},async loadDataset(t,e){this.loadingText="Loading datasets...";try{const i=await this.myDataManager.getDataset({dataset:e.file},{highPrecision:!0,subfolder:this.subfolder});return e.data=i.allRows,e.name=t,this.vizDetails.datasets[t]=e,this.transformData(e),e}catch{return this.$emit("error","Error loading "+e.file),{file:t}}},getColors(t,e){if("colorRamp"in t){const i=typeof t.colorRamp=="string"?{ramp:t.colorRamp}:t.colorRamp;return M(i,e>=2?e:2)}return null},transformData(t){"pivot"in t&&this.pivot(t.name,t.data,t.pivot.exclude,t.pivot.valuesTo,t.pivot.namesTo),"rename"in t&&t.pivot&&this.renameColumns(t.data,t.rename,t.pivot.namesTo||"names"),"normalize"in t&&this.normalizeColumns(t.data,t.normalize),"aggregate"in t&&this.aggregateColumns(t.data,t.aggregate.groupBy,t.aggregate.target),"rename"in t&&!t.pivot&&this.renameHeaders(t.data,t.rename),"constant"in t&&Object.entries(t.constant).forEach(e=>{const[i,s]=e,n=new Array(Object.values(t.data)[0].values.length);n.fill(s),t.data[i]={name:i,values:n,type:1}})},countOccurrences(t){let e={};return t.forEach(i=>{e[i]=e[i]?e[i]+1:1}),e},groupDataTable(t,e){let i={},s=t[e],n=this.countOccurrences(s.values);Object.entries(n).forEach(o=>{const[c,f]=o;let l={};Object.entries(t).forEach(h=>{const[g,u]=h;l[g]={...u};let m=Object.getPrototypeOf(u.values).constructor;l[g].values=new m(f)}),i[c]=l});for(var r=0;r<t[e].values.length;r++){var a=t[e].values[r];let o=i[a],c=o[e].values.length-n[a]--;Object.entries(t).forEach(f=>{const[l,h]=f;o[l].values[c]=h.values[r]})}return i},aggregateColumns(t,e,i){const s={},n=t[Object.keys(t)[0]].values.length;for(let a=0;a<n;a++){const o=e.reduce((c,f)=>c+=t[f].values[a],"");o in s?s[o][i]+=t[i].values[a]:(s[o]=Object.fromEntries(e.map(c=>[c,t[c].values[a]])),s[o][i]=t[i].values[a])}Object.keys(t).forEach(a=>{e.indexOf(a)==-1&&a!=i&&delete t[a]});const r=Object.fromEntries([...e,i].map(a=>[a,[]]));Object.values(s).forEach(a=>{Object.entries(a).forEach(o=>{r[o[0]].push(o[1])})}),Object.entries(r).forEach(a=>{t[a[0]].values=a[1]})},renameHeaders(t,e){e&&Object.entries(e).forEach(([i,s])=>{if(i in t){const n=t[i];t[s]={...n,name:s},delete t[i]}})},renameColumns(t,e,i){if(e&&i in t){const s=t[i].values;for(let n=0;n<s.length;n++)s[n]in e&&(s[n]=e[s[n]])}},normalizeColumns(t,e){if(e){const{groupBy:i,target:s}=e,n={};for(let r=0;r<t[s].values.length;r++){let a="";for(let o=0;o<i.length;o++)a+=t[i[o]].values[r];n[a]===void 0?n[a]=t[s].values[r]:n[a]+=t[s].values[r]}for(let r=0;r<t[s].values.length;r++){let a="";for(let o=0;o<i.length;o++)a+=t[i[o]].values[r];t[s].values[r]/=n[a]}}},pivot(t,e,i,s,n){const r=Object.keys(e).filter(l=>i.indexOf(l)==-1);i.forEach(l=>{l in e||this.$emit("error",`Pivot column ${l} not in ${t}`)});const a=Object.fromEntries(i.map(l=>[l,[]])),o=[],c=[],f=e[Object.keys(e)[0]].values.length;for(let l=0;l<f;l++)r.forEach(h=>{i.forEach(g=>a[g].push(e[g].values[l])),c.push(h),o.push(e[h].values[l])});i.forEach(l=>{e[l].values=a[l]}),e[s]={name:s,values:o},e[n]={name:n,values:c}},mergeDatasets(t){const e={},i=t[0].data;return Object.keys(i).forEach(s=>{const n=t.map(a=>(s in a.data||this.$emit("error",`Merged dataset ${a.name} does not contain column ${s}`),a.data[s].values));let r;i[s].values instanceof Float32Array||i[s].values instanceof Float64Array?r=E(n):r=n.flat(),e[s]={name:s,type:i[s].type,values:r}}),e},recursiveCheckForTemplate(t,e,i){Object.entries(e).forEach(s=>{const[n,r]=s;if(typeof r=="string"){if(r.includes(i)){const a=r.substring(r.indexOf(".")+1);a in t?this.vizDetails.multiIndex&&a in this.vizDetails.multiIndex?e[n]=[t[a].values,t[this.vizDetails.multiIndex[a]].values]:e[n]=t[a].values:this.$emit("error",`Column "${a}" not in ${Object.keys(t)}`)}}else Array.isArray(r)?typeof r[0]=="object"&&r.forEach(a=>this.recursiveCheckForTemplate(t,a,i)):typeof r=="object"&&this.recursiveCheckForTemplate(t,r,i)})}}});var A=function(){var e=this,i=e._self._c;return e._self._setupProxy,i("div",{staticClass:"mycomponent",class:{"is-thumbnail":e.thumbnail}},[i("VuePlotly",{staticClass:"myplot",attrs:{data:e.traces,layout:e.layout,options:e.options}})],1)},V=[],R=C(S,A,V,!1,null,"6764a02a");const q=R.exports;export{q as default};
