import{r as V,g as M,R as A,h as O,M as nt,d as at,C as ot,V as N,S as k,n as rt}from"./index-BSRT1qCd.js";import{d as lt}from"./index-CekG0o6j.js";import{Y as ct}from"./index-r3K0jT4B.js";import{H as ut,u as gt}from"./HTTPFileSystem-CM0ZTrcf.js";import{C as ht}from"./CollapsiblePanel-CcdE1mNp.js";import{D as dt}from"./DrawingTool-dnoO3ElB.js";import{Z as mt}from"./ZoomButtons-Bbfm9hHZ.js";import{_ as v,N as pt,O as ft,Q as yt,l as B,k as St,D as vt,S as bt}from"./set-rtl-text-plugin-FQQ7PIy4.js";import{c as xt}from"./index-D0ukNB7A.js";import{A as Dt}from"./arc-layer-DXi9SaHy.js";import{C as Ct}from"./text-layer-MJiJIY2N.js";import{C as At}from"./column-layer-DuzPsvBw.js";import{W as Mt}from"./NewXmlFetcher.worker-CAkY0uO-.js";import"./fxp-DXsl1rlp.js";import"./geojson-layer-DWgix4fB.js";import"./path-layer-BFwL_QuY.js";import"./cut-by-mercator-bounds-B9-kzb9K.js";import"./solid-polygon-layer-3uI3lo6D.js";function zt(i){return new Worker("/simwrapper/assets/CsvGzipParser.worker-DDGvGgFX.js",{name:i?.name})}const z={SUM:1,MEAN:2,MIN:3,MAX:4};function X(i,t){return i+t}function wt(i,t){return t>i?t:i}function _t(i,t){return t<i?t:i}function Pt(i,t){if(Number.isFinite(t))return i.length?t:null;const e=i.map(t).filter(Number.isFinite);return e.length?e.reduce(X,0)/e.length:null}function Tt(i,t){if(Number.isFinite(t))return i.length?i.length*t:null;const e=i.map(t).filter(Number.isFinite);return e.length?e.reduce(X,0):null}function Ft(i,t){if(Number.isFinite(t))return i.length?t:null;const e=i.map(t).filter(Number.isFinite);return e.length?e.reduce(wt,-1/0):null}function kt(i,t){if(Number.isFinite(t))return i.length?t:null;const e=i.map(t).filter(Number.isFinite);return e.length?e.reduce(_t,1/0):null}function Ht(i,t,e){const s=z[i]||z.SUM;switch(t=It(t,e),s){case z.MIN:return n=>kt(n,t);case z.SUM:return n=>Tt(n,t);case z.MEAN:return n=>Pt(n,t);case z.MAX:return n=>Ft(n,t);default:return null}}function It(i,t={}){return Number.isFinite(i)?i:e=>(t.index=e.index,i(e.source,t))}function Lt(i,t={}){return e=>(t.indices=e.map(s=>s.index),i(e.map(s=>s.source),t))}const $t=[[255,255,178],[254,217,118],[254,178,76],[253,141,60],[240,59,32],[189,0,38]];function Bt(i,t){const e={};for(const s in i)t.includes(s)||(e[s]=i[s]);return e}class Z extends Ct{constructor(...t){super(...t),v(this,"state",void 0)}initializeAggregationLayer(t){super.initializeState(this.context),this.setState({ignoreProps:Bt(this.constructor._propTypes,t.data.props),dimensions:t})}updateState(t){super.updateState(t);const{changeFlags:e}=t;if(e.extensionsChanged){const s=this.getShaders({});s&&s.defines&&(s.defines.NON_INSTANCED_MODEL=1),this.updateShaders(s)}this._updateAttributes()}updateAttributes(t){this.setState({changedAttributes:t})}getAttributes(){return this.getAttributeManager().getShaderAttributes()}getModuleSettings(){const{viewport:t,mousePosition:e,gl:s}=this.context;return Object.assign(Object.create(this.props),{viewport:t,mousePosition:e,pickingActive:0,devicePixelRatio:pt(s)})}updateShaders(t){}isAggregationDirty(t,e={}){const{props:s,oldProps:n,changeFlags:a}=t,{compareAll:o=!1,dimension:r}=e,{ignoreProps:l}=this.state,{props:c,accessors:m=[]}=r,{updateTriggersChanged:u}=a;if(a.dataChanged)return!0;if(u){if(u.all)return!0;for(const d of m)if(u[d])return!0}if(o)return a.extensionsChanged?!0:ft({oldProps:n,newProps:s,ignoreProps:l,propTypes:this.constructor._propTypes});for(const d of c)if(s[d]!==n[d])return!0;return!1}isAttributeChanged(t){const{changedAttributes:e}=this.state;return t?e&&e[t]!==void 0:!Et(e)}_getAttributeManager(){return new yt(this.context.gl,{id:this.props.id,stats:this.context.stats})}}v(Z,"layerName","AggregationLayer");function Et(i){let t=!0;for(const e in i){t=!1;break}return t}function $(i,t,e){const s=e;return s.domain=()=>i,s.range=()=>t,s}function j(i,t){return $(i,t,s=>Wt(i,t,s))}function Rt(i,t){return $(i,t,s=>qt(i,t,s))}function Vt(i,t){const e=i.sort(Q);let s=0;const n=Math.max(1,t.length),a=new Array(n-1);for(;++s<n;)a[s-1]=Ot(e,s/n);const o=r=>jt(a,t,r);return o.thresholds=()=>a,$(i,t,o)}function Q(i,t){return i-t}function Ot(i,t){const e=i.length;if(t<=0||e<2)return i[0];if(t>=1)return i[e-1];const s=(e-1)*t,n=Math.floor(s),a=i[n],o=i[n+1];return a+(o-a)*(s-n)}function Nt(i,t){let e=0,s=i.length;for(;e<s;){const n=e+s>>>1;Q(i[n],t)>0?s=n:e=n+1}return e}function jt(i,t,e){return t[Nt(i,e)]}function Ut(i,t,e,s){const n="".concat(s);let a=t.get(n);return a===void 0&&(a=i.push(s),t.set(n,a)),e[(a-1)%e.length]}function Gt(i,t){const e=new Map,s=[];for(const a of i){const o="".concat(a);e.has(o)||e.set(o,s.push(a))}return $(i,t,a=>Ut(s,e,t,a))}function Wt(i,t,e){const s=i[1]-i[0];if(s<=0)return B.warn("quantizeScale: invalid domain, returning range[0]")(),t[0];const n=s/t.length,a=Math.floor((e-i[0])/n),o=Math.max(Math.min(a,t.length-1),0);return t[o]}function qt(i,t,e){return(e-i[0])/(i[1]-i[0])*(t[1]-t[0])+t[0]}function K(i){return i!=null}function Yt(i){const t=[];return i.forEach(e=>{!t.includes(e)&&K(e)&&t.push(e)}),t}function J(i,t){return(typeof t=="function"?i.map(t):i).filter(K)}function Xt(i,t){return J(i,t)}function Zt(i,t){return Yt(J(i,t))}function Qt(i,t,e){return Math.max(t,Math.min(e,i))}function Kt(i){switch(i){case"quantize":return j;case"linear":return Rt;case"quantile":return Vt;case"ordinal":return Gt;default:return j}}const tt=i=>i.length,Jt=3402823466e29,et=i=>i.points,it=i=>i.index,U=(i,t)=>i<t?-1:i>t?1:i>=t?0:NaN,te={getValue:tt,getPoints:et,getIndex:it,filterData:null};class ee{constructor(t=[],e=te){v(this,"maxCount",void 0),v(this,"maxValue",void 0),v(this,"minValue",void 0),v(this,"totalCount",void 0),v(this,"aggregatedBins",void 0),v(this,"sortedBins",void 0),v(this,"binMap",void 0),this.aggregatedBins=this.getAggregatedBins(t,e),this._updateMinMaxValues(),this.binMap=this.getBinMap()}getAggregatedBins(t,e){const{getValue:s=tt,getPoints:n=et,getIndex:a=it,filterData:o}=e,r=typeof o=="function",l=t.length,c=[];let m=0;for(let u=0;u<l;u++){const d=t[u],y=n(d),p=a(d),h=r?y.filter(o):y;d.filteredPoints=r?h:null;const f=h.length?s(h):null;f!=null&&(c[m]={i:Number.isFinite(p)?p:u,value:f,counts:h.length},m++)}return c}_percentileToIndex(t){const e=this.sortedBins.length;if(e<2)return[0,0];const[s,n]=t.map(r=>Qt(r,0,100)),a=Math.ceil(s/100*(e-1)),o=Math.floor(n/100*(e-1));return[a,o]}getBinMap(){const t={};for(const e of this.aggregatedBins)t[e.i]=e;return t}_updateMinMaxValues(){let t=0,e=0,s=Jt,n=0;for(const a of this.aggregatedBins)t=t>a.counts?t:a.counts,e=e>a.value?e:a.value,s=s<a.value?s:a.value,n+=a.counts;this.maxCount=t,this.maxValue=e,this.minValue=s,this.totalCount=n}getValueRange(t){if(this.sortedBins||(this.sortedBins=this.aggregatedBins.sort((n,a)=>U(n.value,a.value))),!this.sortedBins.length)return[];let e=0,s=this.sortedBins.length-1;if(Array.isArray(t)){const n=this._percentileToIndex(t);e=n[0],s=n[1]}return[this.sortedBins[e].value,this.sortedBins[s].value]}getValueDomainByScale(t,[e=0,s=100]=[]){if(this.sortedBins||(this.sortedBins=this.aggregatedBins.sort((a,o)=>U(a.value,o.value))),!this.sortedBins.length)return[];const n=this._percentileToIndex([e,s]);return this._getScaleDomain(t,n)}_getScaleDomain(t,[e,s]){const n=this.sortedBins;switch(t){case"quantize":case"linear":return[n[e].value,n[s].value];case"quantile":return Xt(n.slice(e,s+1),a=>a.value);case"ordinal":return Zt(n,a=>a.value);default:return[n[e].value,n[s].value]}}}function G(){}const W=["getBins","getDomain","getScaleFunc"],q=[{key:"fillColor",accessor:"getFillColor",pickingInfo:"colorValue",getBins:{triggers:{value:{prop:"getColorValue",updateTrigger:"getColorValue"},weight:{prop:"getColorWeight",updateTrigger:"getColorWeight"},aggregation:{prop:"colorAggregation"},filterData:{prop:"_filterData",updateTrigger:"_filterData"}}},getDomain:{triggers:{lowerPercentile:{prop:"lowerPercentile"},upperPercentile:{prop:"upperPercentile"},scaleType:{prop:"colorScaleType"}}},getScaleFunc:{triggers:{domain:{prop:"colorDomain"},range:{prop:"colorRange"}},onSet:{props:"onSetColorDomain"}},nullValue:[0,0,0,0]},{key:"elevation",accessor:"getElevation",pickingInfo:"elevationValue",getBins:{triggers:{value:{prop:"getElevationValue",updateTrigger:"getElevationValue"},weight:{prop:"getElevationWeight",updateTrigger:"getElevationWeight"},aggregation:{prop:"elevationAggregation"},filterData:{prop:"_filterData",updateTrigger:"_filterData"}}},getDomain:{triggers:{lowerPercentile:{prop:"elevationLowerPercentile"},upperPercentile:{prop:"elevationUpperPercentile"},scaleType:{prop:"elevationScaleType"}}},getScaleFunc:{triggers:{domain:{prop:"elevationDomain"},range:{prop:"elevationRange"}},onSet:{props:"onSetElevationDomain"}},nullValue:-1}],ie=i=>i.cellSize;class se{constructor(t){this.state={layerData:{},dimensions:{}},this.changeFlags={},this.dimensionUpdaters={},this._getCellSize=t.getCellSize||ie,this._getAggregator=t.getAggregator,this._addDimension(t.dimensions||q)}static defaultDimensions(){return q}updateState(t,e){const{oldProps:s,props:n,changeFlags:a}=t;this.updateGetValueFuncs(s,n,a);const o=this.needsReProjectPoints(s,n,a);let r=!1;return a.dataChanged||o?(this.getAggregatedData(n,e),r=!0):((this.getDimensionChanges(s,n,a)||[]).forEach(c=>typeof c=="function"&&c()),r=!0),this.setState({aggregationDirty:r}),this.state}setState(t){this.state={...this.state,...t}}setDimensionState(t,e){this.setState({dimensions:{...this.state.dimensions,[t]:{...this.state.dimensions[t],...e}}})}normalizeResult(t={}){return t.hexagons?{data:t.hexagons,...t}:t.layerData?{data:t.layerData,...t}:t}getAggregatedData(t,e){const n=this._getAggregator(t)(t,e);this.setState({layerData:this.normalizeResult(n)}),this.changeFlags={layerData:!0},this.getSortedBins(t)}updateGetValueFuncs(t,e,s){for(const n in this.dimensionUpdaters){const{value:a,weight:o,aggregation:r}=this.dimensionUpdaters[n].getBins.triggers;let l=e[a.prop];this.needUpdateDimensionStep(this.dimensionUpdaters[n].getBins,t,e,s)&&(l?l=Lt(l,{data:e.data}):l=Ht(e[r.prop],e[o.prop],{data:e.data})),l&&this.setDimensionState(n,{getValue:l})}}needsReProjectPoints(t,e,s){return this._getCellSize(t)!==this._getCellSize(e)||this._getAggregator(t)!==this._getAggregator(e)||s.updateTriggersChanged&&(s.updateTriggersChanged.all||s.updateTriggersChanged.getPosition)}addDimension(t){this._addDimension(t)}_addDimension(t=[]){t.forEach(e=>{const{key:s}=e;this.dimensionUpdaters[s]=this.getDimensionUpdaters(e),this.state.dimensions[s]={getValue:null,domain:null,sortedBins:null,scaleFunc:G}})}getDimensionUpdaters({key:t,accessor:e,pickingInfo:s,getBins:n,getDomain:a,getScaleFunc:o,nullValue:r}){return{key:t,accessor:e,pickingInfo:s,getBins:{updater:this.getDimensionSortedBins,...n},getDomain:{updater:this.getDimensionValueDomain,...a},getScaleFunc:{updater:this.getDimensionScale,...o},attributeAccessor:this.getSubLayerDimensionAttribute(t,r)}}needUpdateDimensionStep(t,e,s,n){return Object.values(t.triggers).some(a=>a.updateTrigger?n.dataChanged||n.updateTriggersChanged&&(n.updateTriggersChanged.all||n.updateTriggersChanged[a.updateTrigger]):e[a.prop]!==s[a.prop])}getDimensionChanges(t,e,s){const n=[];for(const a in this.dimensionUpdaters){const o=W.find(r=>this.needUpdateDimensionStep(this.dimensionUpdaters[a][r],t,e,s));o&&n.push(this.dimensionUpdaters[a][o].updater.bind(this,e,this.dimensionUpdaters[a]))}return n.length?n:null}getUpdateTriggers(t){const e=t.updateTriggers||{},s={};for(const n in this.dimensionUpdaters){const{accessor:a}=this.dimensionUpdaters[n];s[a]={},W.forEach(o=>{Object.values(this.dimensionUpdaters[n][o].triggers).forEach(({prop:r,updateTrigger:l})=>{if(l){const c=e[l];typeof c=="object"&&!Array.isArray(c)?Object.assign(s[a],c):c!==void 0&&(s[a][r]=c)}else s[a][r]=t[r]})})}return s}getSortedBins(t){for(const e in this.dimensionUpdaters)this.getDimensionSortedBins(t,this.dimensionUpdaters[e])}getDimensionSortedBins(t,e){const{key:s}=e,{getValue:n}=this.state.dimensions[s],a=new ee(this.state.layerData.data||[],{getValue:n,filterData:t._filterData});this.setDimensionState(s,{sortedBins:a}),this.getDimensionValueDomain(t,e)}getDimensionValueDomain(t,e){const{getDomain:s,key:n}=e,{triggers:{lowerPercentile:a,upperPercentile:o,scaleType:r}}=s,l=this.state.dimensions[n].sortedBins.getValueDomainByScale(t[r.prop],[t[a.prop],t[o.prop]]);this.setDimensionState(n,{valueDomain:l}),this.getDimensionScale(t,e)}getDimensionScale(t,e){const{key:s,getScaleFunc:n,getDomain:a}=e,{domain:o,range:r}=n.triggers,{scaleType:l}=a.triggers,{onSet:c}=n,m=t[r.prop],u=t[o.prop]||this.state.dimensions[s].valueDomain,y=Kt(l&&t[l.prop])(u,m);typeof c=="object"&&typeof t[c.props]=="function"&&t[c.props](y.domain()),this.setDimensionState(s,{scaleFunc:y})}getSubLayerDimensionAttribute(t,e){return s=>{const{sortedBins:n,scaleFunc:a}=this.state.dimensions[t],o=n.binMap[s.index];if(o&&o.counts===0)return e;const r=o&&o.value,l=a.domain();return r>=l[0]&&r<=l[l.length-1]?a(r):e}}getSubLayerAccessors(t){const e={};for(const s in this.dimensionUpdaters){const{accessor:n}=this.dimensionUpdaters[s];e[n]=this.getSubLayerDimensionAttribute(t,s)}return e}getPickingInfo({info:t}){const e=t.picked&&t.index>-1;let s=null;if(e){const n=this.state.layerData.data[t.index],a={};for(const o in this.dimensionUpdaters){const{pickingInfo:r}=this.dimensionUpdaters[o],{sortedBins:l}=this.state.dimensions[o],c=l.binMap[n.index]&&l.binMap[n.index].value;a[r]=c}s=Object.assign(a,n,{points:n.filteredPoints||n.points})}return t.picked=!!s,t.object=s,t}getAccessor(t){return this.dimensionUpdaters.hasOwnProperty(t)?this.dimensionUpdaters[t].attributeAccessor:G}}var w=Math.PI/3,ne=[0,w,2*w,3*w,4*w,5*w];function ae(i){return i[0]}function oe(i){return i[1]}function re(){var i=0,t=0,e=1,s=1,n=ae,a=oe,o,r,l;function c(u){var d={},y=[],p,h=u.length;for(p=0;p<h;++p)if(!(isNaN(S=+n.call(null,f=u[p],p,u))||isNaN(b=+a.call(null,f,p,u)))){var f,S,b,x=Math.round(b=b/l),D=Math.round(S=S/r-(x&1)/2),_=b-x;if(Math.abs(_)*3>1){var H=S-D,P=D+(S<D?-1:1)/2,I=x+(b<x?-1:1),L=S-P,T=b-I;H*H+_*_>L*L+T*T&&(D=P+(x&1?1:-1)/2,x=I)}var F=D+"-"+x,g=d[F];g?g.push(f):(y.push(g=d[F]=[f]),g.x=(D+(x&1)/2)*r,g.y=x*l)}return y}function m(u){var d=0,y=0;return ne.map(function(p){var h=Math.sin(p)*u,f=-Math.cos(p)*u,S=h-d,b=f-y;return d=h,y=f,[S,b]})}return c.hexagon=function(u){return"m"+m(u==null?o:+u).join("l")+"z"},c.centers=function(){for(var u=[],d=Math.round(t/l),y=Math.round(i/r),p=d*l;p<s+o;p+=l,++d)for(var h=y*r+(d&1)*r/2;h<e+r/2;h+=r)u.push([h,p]);return u},c.mesh=function(){var u=m(o).slice(0,4).join("l");return c.centers().map(function(d){return"M"+d+"m"+u}).join("")},c.x=function(u){return arguments.length?(n=u,c):n},c.y=function(u){return arguments.length?(a=u,c):a},c.radius=function(u){return arguments.length?(o=+u,r=o*2*Math.sin(w),l=o*1.5,c):o},c.size=function(u){return arguments.length?(i=t=0,e=+u[0],s=+u[1],c):[e-i,s-t]},c.extent=function(u){return arguments.length?(i=+u[0][0],t=+u[0][1],e=+u[1][0],s=+u[1][1],c):[[i,t],[e,s]]},c.radius(1)}function le(i,t){const{data:e,radius:s}=i,{viewport:n,attributes:a}=t,o=e.length?ce(e,t):null,r=ue(s,n,o),l=[],{iterable:c,objectInfo:m}=St(e),u=a.positions.value,{size:d}=a.positions.getAccessor();for(const h of c){m.index++;const f=m.index*d,S=[u[f],u[f+1]];Number.isFinite(S[0])&&Number.isFinite(S[1])?l.push({screenCoord:n.projectFlat(S),source:h,index:m.index}):B.warn("HexagonLayer: invalid position")()}return{hexagons:re().radius(r).x(h=>h.screenCoord[0]).y(h=>h.screenCoord[1])(l).map((h,f)=>({position:n.unprojectFlat([h.x,h.y]),points:h,index:f})),radiusCommon:r}}function ce(i,t){const{attributes:e}=t,s=e.positions.value,{size:n}=e.positions.getAccessor();let a=1/0,o=1/0,r=-1/0,l=-1/0,c;for(c=0;c<n*i.length;c+=n){const m=s[c],u=s[c+1];Number.isFinite(m)&&Number.isFinite(u)&&(a=Math.min(m,a),r=Math.max(m,r),o=Math.min(u,o),l=Math.max(u,l))}return[a,o,r,l].every(Number.isFinite)?[(a+r)/2,(o+l)/2]:null}function ue(i,t,e){const{unitsPerMeter:s}=t.getDistanceScales(e);return i*s[0]}function Y(){}const ge={colorDomain:null,colorRange:$t,getColorValue:{type:"accessor",value:null},getColorWeight:{type:"accessor",value:1},colorAggregation:"SUM",lowerPercentile:{type:"number",value:0,min:0,max:100},upperPercentile:{type:"number",value:100,min:0,max:100},colorScaleType:"quantize",onSetColorDomain:Y,elevationDomain:null,elevationRange:[0,1e3],getElevationValue:{type:"accessor",value:null},getElevationWeight:{type:"accessor",value:1},elevationAggregation:"SUM",elevationLowerPercentile:{type:"number",value:0,min:0,max:100},elevationUpperPercentile:{type:"number",value:100,min:0,max:100},elevationScale:{type:"number",min:0,value:1},elevationScaleType:"linear",onSetElevationDomain:Y,radius:{type:"number",value:1e3,min:1},coverage:{type:"number",min:0,max:1,value:1},extruded:!1,hexagonAggregator:le,getPosition:{type:"accessor",value:i=>i.position},material:!0,_filterData:{type:"function",value:null,optional:!0}};class E extends Z{constructor(...t){super(...t),v(this,"state",void 0)}initializeState(){const t=new se({getAggregator:s=>s.hexagonAggregator,getCellSize:s=>s.radius});this.state={cpuAggregator:t,aggregatorState:t.state,vertices:null},this.getAttributeManager().add({positions:{size:3,type:5130,accessor:"getPosition"}})}updateState(t){if(super.updateState(t),t.changeFlags.propsOrDataChanged){const e=this.state.cpuAggregator.updateState(t,{viewport:this.context.viewport,attributes:this.getAttributes()});if(this.state.aggregatorState.layerData!==e.layerData){const{hexagonVertices:s}=e.layerData||{};this.setState({vertices:s&&this.convertLatLngToMeterOffset(s)})}this.setState({aggregatorState:e})}}convertLatLngToMeterOffset(t){const{viewport:e}=this.context;if(Array.isArray(t)&&t.length===6){const s=t[0],n=t[3],a=[(s[0]+n[0])/2,(s[1]+n[1])/2],o=e.projectFlat(a),{metersPerUnit:r}=e.getDistanceScales(a);return t.map(c=>{const m=e.projectFlat(c);return[(m[0]-o[0])*r[0],(m[1]-o[1])*r[1]]})}return B.error("HexagonLayer: hexagonVertices needs to be an array of 6 points")(),null}getPickingInfo({info:t}){return this.state.cpuAggregator.getPickingInfo({info:t})}_onGetSublayerColor(t){return this.state.cpuAggregator.getAccessor("fillColor")(t)}_onGetSublayerElevation(t){return this.state.cpuAggregator.getAccessor("elevation")(t)}_getSublayerUpdateTriggers(){return this.state.cpuAggregator.getUpdateTriggers(this.props)}renderLayers(){const{elevationScale:t,extruded:e,coverage:s,material:n,transitions:a}=this.props,{aggregatorState:o,vertices:r}=this.state,l=this.getSubLayerClass("hexagon-cell",At),c=this._getSublayerUpdateTriggers(),m=r?{vertices:r,radius:1}:{radius:o.layerData.radiusCommon||1,radiusUnits:"common",angle:90};return new l({...m,diskResolution:6,elevationScale:t,extruded:e,coverage:s,material:n,getFillColor:this._onGetSublayerColor.bind(this),getElevation:this._onGetSublayerElevation.bind(this),transitions:a&&{getFillColor:a.getColorValue||a.getColorWeight,getElevation:a.getElevationValue||a.getElevationWeight}},this.getSubLayerProps({id:"hexagon-cell",updateTriggers:c}),{data:o.layerData.data})}}v(E,"layerName","HexagonLayer");v(E,"defaultProps",ge);const he={ambient:.64,diffuse:.6,shininess:32,specularColor:[51,51,51]};function de({viewId:i=0,colorRamp:t="chlorophyll",coverage:e=1,dark:s=!1,data:n={},extrude:a=!0,highlights:o=[],mapIsIndependent:r=!1,maxHeight:l=200,metric:c="SUM",radius:m=1e3,selectedHexStats:u={rows:0,numHexagons:0,selectedHexagonIds:[]},upperPercentile:d=100,onClick:y=null,agg:p=0,group:h=""}){const[f,S]=V.useState(M.state.viewState);A[i]=()=>{S(M.state.viewState)};const b=V.useMemo(()=>{let g=[];return o.length?o.map(C=>C[0]):!n||!Object.keys(n).length?g:{length:n[h].positions[p].length/2}},[n,o,p,h,m]);function x(g){g.latitude&&(g.center||(g.center=[0,0]),g.center[0]=g.longitude,g.center[1]=g.latitude,S(g),r||M.commit("setMapCamera",g))}const D=xt({colormap:t,nshades:10,format:"rba",alpha:1}).map(g=>[g[0],g[1],g[2]]);function _({object:g}){if(!g||!g.position||!g.position.length)return null;const C=g.position[1],R=g.position[0],st=g.points.length;return{html:`        <b>${o.length?"Count":c}: ${st} </b><br/>
        ${Number.isFinite(C)?C.toFixed(4):""} / ${Number.isFinite(R)?R.toFixed(4):""}
      `,style:s?{color:"#ccc",backgroundColor:"#2a3c4f"}:{color:"#223",backgroundColor:"white"}}}function H(g,C){y&&y(g,C)}const P=n[h],I=o.length?{getPosition:g=>g}:{getPosition:(g,C)=>P.positions[p].slice(C.index*2,C.index*2+2)},L=P?.positions[p].length/2||0;let T;L<20&&(T=D.slice(4,5));const F=[new Dt({id:"arc-layer",data:o,getSourcePosition:g=>g[0],getTargetPosition:g=>g[1],pickable:!1,opacity:.4,getHeight:0,getWidth:1,getSourceColor:s?[144,96,128]:[192,192,240],getTargetColor:s?[144,96,128]:[192,192,240]})];return F.push(new E(Object.assign(I,{id:"hexlayer",data:b,colorRange:T||(s?D.slice(1):D.reverse().slice(1)),coverage:e,autoHighlight:!0,elevationRange:[0,l],elevationScale:25,extruded:a,gpuAggregation:!0,selectedHexStats:u,pickable:!0,opacity:s&&o.length?.6:.8,radius:m,upperPercentile:d,material:he,positionFormat:"XY",updateTriggers:{},transitions:{elevationScale:{type:"interpolation",duration:1e3},opacity:{type:"interpolation",duration:200}}}))),O.createElement(vt,{layers:F,controller:!0,useDevicePixels:!1,viewState:f,getTooltip:_,onClick:H,onViewStateChange:g=>x(g.viewState)},O.createElement(bt,{mapStyle:M.getters.mapStyle,preventStyleDiffing:!0,mapboxApiAccessToken:nt}))}const me={messages:{en:{loading:"Loading data...",sorting:"Sorting into bins...",aggregate:"Summary",maxHeight:"3D Height",showDetails:"Show Details",selection:"Selection",areas:"Areas",count:"Count"},de:{loading:"Dateien laden...",sorting:"Sortieren...",aggregate:"Daten",maxHeight:"3-D Höhe",showDetails:"Details anzeigen",selection:"Ausgewählt",areas:"Orte",count:"Anzahl"}}},pe=at({name:"XyHexagonsPlugin",i18n:me,components:{CollapsiblePanel:ht,DrawingTool:dt,XyHexDeckMap:de,ToggleButton:lt.ToggleButton,ZoomButtons:mt},props:{root:{type:String,required:!0},subfolder:{type:String,required:!0},yamlConfig:String,config:Object,thumbnail:Boolean},data:()=>{const i=["par","bathymetry","magma","chlorophyll"];return{id:`id-${Math.floor(1e12*Math.random())}`,resolvers:{},resolverId:0,_xmlConfigFetcher:{},standaloneYAMLconfig:{title:"",description:"",file:"",projection:"",thumbnail:"",aggregations:{},radius:250,maxHeight:0,center:null,zoom:9,mapIsIndependent:!1},YAMLrequirementsXY:{file:"",aggregations:{}},colorRamps:i,buttonColors:["#BF7230","#5E8AAE","#9C439C","#269367"],aggregations:{},aggNumber:0,gzipWorker:null,colorRamp:i[0],globalState:M.state,currentGroup:"",vizDetails:{title:"",description:"",file:"",projection:"",thumbnail:"",aggregations:{},radius:250,maxHeight:0,center:null,zoom:9},myState:{statusMessage:"",subfolder:"",yamlConfig:"",thumbnail:!1},requests:{},highlightedTrips:[],searchTerm:"",searchEnabled:!1,isLoaded:!1,activeAggregation:"",isHighlightingZone:!1,multiSelectedHexagons:{},thumbnailUrl:"url('assets/thumbnail.jpg') no-repeat;",hexStats:null,resizer:null}},computed:{fileApi(){return new ut(this.fileSystem,M)},fileSystem(){const i=this.$store.state.svnProjects.filter(t=>t.slug===this.root);if(i.length===0)throw console.log("no such project"),Error;return i[0]},urlThumbnail(){return this.thumbnailUrl},buttonLabel(){const[i,t]=this.activeAggregation.split("~");return this.aggregations[i][t].title},extrudeTowers(){return this.vizDetails.maxHeight>0},mapProps(){return{viewId:this.id,group:this.currentGroup,agg:this.aggNumber,colorRamp:this.colorRamp,coverage:.7,dark:this.$store.state.isDarkMode,data:this.requests,extrude:this.extrudeTowers,highlights:this.highlightedTrips,mapIsIndependent:this.vizDetails.mapIsIndependent,maxHeight:this.vizDetails.maxHeight,metric:this.buttonLabel,radius:this.vizDetails.radius,selectedHexStats:this.hexStats,upperPercentile:100,onClick:this.handleClick}},textColor(){const i={text:"#3498db",bg:"#eeeef480"},t={text:"white",bg:"#181518aa"};return this.$store.state.colorScheme===ot.DarkMode?t:i}},watch:{extrudeTowers(){this.extrudeTowers&&this.globalState.viewState.pitch==0&&M.commit("setMapCamera",Object.assign({},this.globalState.viewState,{pitch:10}))},"$store.state.viewState"(){this.vizDetails.mapIsIndependent||A[this.id]&&A[this.id]()}},methods:{handleClick(i,t){i.layer?this.handleHexClick(i,t):this.handleEmptyClick()},handleEmptyClick(){this.flipViewToShowInvertedData({})},handleHexClick(i,t){if(!t.srcEvent.shiftKey){this.multiSelectedHexagons={},this.hexStats=null,this.flipViewToShowInvertedData(i);return}const e=i?.object?.index;e!==void 0&&(e in this.multiSelectedHexagons?delete this.multiSelectedHexagons[e]:this.multiSelectedHexagons[e]=i.object.points,this.hexStats=this.selectedHexagonStatistics())},flipViewToShowInvertedData(i){this.isHighlightingZone?this.isHighlightingZone=!1:this.isHighlightingZone=!!i.object;const t=this.activeAggregation.split("~");if(!this.isHighlightingZone){this.hexStats=null,this.multiSelectedHexagons={},this.handleOrigDest(t[0],parseInt(t[1])),this.highlightedTrips=[];return}let e=this.aggNumber+(this.aggNumber%2?-1:1);const s=[];for(const n of i.object.points){const a=n.index*2,o=[this.requests[this.currentGroup].positions[e][a],this.requests[this.currentGroup].positions[e][a+1]],r=[this.requests[this.currentGroup].positions[this.aggNumber][a],this.requests[this.currentGroup].positions[this.aggNumber][a+1]];s.push([o,r]),this.highlightedTrips=s}this.hexStats&&(this.hexStats.selectedHexagonIds=[]),this.multiSelectedHexagons={},this.colorRamp=this.colorRamps[e]},async handleOrigDest(i,t){this.currentGroup=i,this.aggNumber=t,this.hexStats=null,this.multiSelectedHexagons={},this.highlightedTrips=[],this.activeAggregation=`${i}~${t}`,this.colorRamp=this.colorRamps[t]},async getVizDetails(){if(this.config){this.validateYAML(),this.vizDetails=Object.assign({},this.config),this.setRadiusAndHeight();return}new RegExp(".*(yml|yaml)$").test(this.myState.yamlConfig)?await this.loadStandaloneYAMLConfig():await this.loadOutputTripsConfig()},fetchXML(i){let t=i.worker;t.onmessage=n=>{const{resolve:a,reject:o}=this.resolvers[n.data.id];t.terminate(),n.data.error&&o(n.data.error),a(n.data.xml)};const e=this.resolverId++;return t.postMessage({id:e,fileSystem:this.fileSystem,filePath:i.filePath,options:i.options}),new Promise((n,a)=>{this.resolvers[e]={resolve:n,reject:a}})},async figureOutProjection(){const{files:i}=await this.fileApi.getDirectory(this.myState.subfolder),t=i.filter(e=>e.indexOf(".output_config.xml")>-1||e.indexOf(".output_config_reduced.xml")>-1);if(t.length&&this.fileSystem)for(const e of t)try{return(await this.fetchXML({worker:this._xmlConfigFetcher,slug:this.fileSystem.slug,filePath:this.myState.subfolder+"/"+e})).config.module.filter(r=>r.$name==="global")[0].param.filter(r=>r.$name==="coordinateSystem")[0].$value}catch{console.warn("Failed parsing",e)}},async loadOutputTripsConfig(){let i=await this.figureOutProjection();!this.myState.thumbnail&&!i&&(i=prompt('Enter projection: e.g. "EPSG:31468"')||"EPSG:31468",parseInt(i,10)&&(i="EPSG:"+i)),this.vizDetails={title:"Output Trips",description:this.myState.yamlConfig,file:this.myState.yamlConfig,projection:i,aggregations:{"Trip Summary":[{title:"Origins",x:"start_x",y:"start_y"},{title:"Destinations",x:"end_x",y:"end_y"}]},radius:this.vizDetails.radius,maxHeight:this.vizDetails.maxHeight,center:this.vizDetails.center,zoom:this.vizDetails.zoom},this.$emit("title",this.vizDetails.title)},setRadiusAndHeight(){this.vizDetails.radius||N.set(this.vizDetails,"radius",250),this.vizDetails.maxHeight||N.set(this.vizDetails,"maxHeight",0)},async loadStandaloneYAMLConfig(){try{const i=this.myState.yamlConfig.indexOf("/")>-1?this.myState.yamlConfig:this.myState.subfolder+"/"+this.myState.yamlConfig,t=await this.fileApi.getFileText(i);this.standaloneYAMLconfig=Object.assign({},ct.parse(t)),this.validateYAML(),this.setVizDetails()}catch(i){console.error("failed",""+i),this.$emit("error",`File not found: ${this.myState.subfolder}/${this.myState.yamlConfig}`)}},validateYAML(){const i=new RegExp(".*(yml|yaml)$").test(this.myState.yamlConfig);let t={};i?(console.log("has yaml"),t=this.standaloneYAMLconfig):(console.log("no yaml"),t=this.config);for(const e in this.YAMLrequirementsXY)e in t||this.$emit("error",{type:k.ERROR,msg:`XYHexagon: ${this.yamlConfig}: missing required key: ${e}`,desc:`XYHexagon requires ${Object.keys(this.YAMLrequirementsXY)}`});t.radius==0&&this.$emit("error",{type:k.WARNING,msg:"Radius set to zero",desc:"Radius can not be zero, preset value used instead. "}),(t.zoom<5||t.zoom>20)&&this.$emit("error",{type:k.WARNING,msg:"Zoom is out of the recommended range ",desc:"Zoom levels should be between 5 and 20. "})},setVizDetails(){this.vizDetails=Object.assign({},this.vizDetails,this.standaloneYAMLconfig),this.setRadiusAndHeight();const i=this.vizDetails.title?this.vizDetails.title:"Hex Aggregation";this.$emit("title",i)},async buildThumbnail(){if(this.thumbnail&&this.vizDetails.thumbnail)try{const t=await(await this.fileApi.getFileBlob(this.myState.subfolder+"/"+this.vizDetails.thumbnail)).arrayBuffer(),e=gt.arrayBufferToBase64(t);e&&(this.thumbnailUrl=`center / cover no-repeat url(data:image/png;base64,${e})`)}catch(i){console.error(i)}},handleShowSelectionButton(){const i=Object.values(this.multiSelectedHexagons);let t=[];i.map(s=>t=t.concat(s));const e={object:{points:t}};this.flipViewToShowInvertedData(e)},selectedHexagonStatistics(){const i=Object.keys(this.multiSelectedHexagons).map(s=>parseInt(s));return i.length?{rows:Object.values(this.multiSelectedHexagons).reduce((s,n)=>s+n.length,0),numHexagons:i.length,selectedHexagonIds:i}:null},async setMapCenter(){if(this.vizDetails.center){typeof this.vizDetails.center=="string"&&(this.vizDetails.center=this.vizDetails.center.split(",").map(Number));const l={longitude:this.vizDetails.center[0],latitude:this.vizDetails.center[1],bearing:0,pitch:0,zoom:this.vizDetails.zoom||10,jump:!1};A[this.id]&&A[this.id](l),this.$store.commit("setMapCamera",Object.assign({},l));return}const i=Object.keys(this.requests);if(!i.length)return;const t=this.requests[i[0]].positions[0];let e=0,s=0,n=0;const a=t.length/2,o=512;for(let l=0;l<a;l+=o)s+=t[l*2],n+=t[l*2+1],e++;s=s/e,n=n/e;const r=this.$store.state.viewState;s&&n&&this.$store.commit("setMapCamera",{longitude:s,latitude:n,bearing:r.bearing,pitch:r.pitch,zoom:this.vizDetails.zoom||r.zoom,jump:!1})},setupLogoMover(){this.resizer=new ResizeObserver(this.moveLogo);const i=document.getElementById(`id-${this.id}`);this.resizer.observe(i)},moveLogo(){const i=document.getElementById(`id-${this.id}`),t=i?.querySelector(".mapboxgl-ctrl-bottom-left");if(t){const e=i.clientWidth>640?"280px":"36px";t.style.right=e}},async parseCSVFile(i){this.myState.statusMessage="Loading file...",this.gzipWorker=new zt,this.gzipWorker.onmessage=async t=>{if(t.data.status)this.myState.statusMessage=t.data.status;else if(t.data.projection)console.log("dataset has a #EPSG:projection, using it",t.data.projection),this.vizDetails.projection=t.data.projection;else if(t.data.error)this.myState.statusMessage=t.data.error,this.$emit("error",{type:k.ERROR,msg:`Error loading: ${this.myState.subfolder}/${this.vizDetails.file}`});else{const{fullRowCache:e}=t.data;this.gzipWorker&&this.gzipWorker.terminate(),this.dataIsLoaded({fullRowCache:e})}},this.gzipWorker.postMessage({filepath:i,fileSystem:this.fileSystem,aggregations:this.vizDetails.aggregations,projection:this.vizDetails.projection})},dataIsLoaded({fullRowCache:i}){this.requests=i,this.setMapCenter(),this.moveLogo(),this.myState.statusMessage=""},async loadFiles(){let i=[];if(!this.fileApi)return{dataArray:i};try{let t=`${this.myState.subfolder}/${this.vizDetails.file}`;await this.parseCSVFile(t)}catch(t){console.error(t),this.myState.statusMessage=""+t,this.$emit("error",{type:k.ERROR,msg:"Loading/Parsing Error",desc:"Error loading/parsing: ${this.myState.subfolder}/${this.vizDetails.file}"})}}},async mounted(){this.$store.commit("setFullScreen",!this.thumbnail),this.myState.thumbnail=this.thumbnail,this.myState.yamlConfig=this.yamlConfig||"",this.myState.subfolder=this.subfolder,this._xmlConfigFetcher=new Mt,await this.getVizDetails(),!this.thumbnail&&(this.setupLogoMover(),this.myState.statusMessage=`${this.$i18n.t("loading")}`,this.aggregations=this.vizDetails.aggregations,await this.loadFiles(),this.buildThumbnail(),this.isLoaded=!0,this.handleOrigDest(Object.keys(this.aggregations)[0],0))},beforeDestroy(){this._xmlConfigFetcher&&this._xmlConfigFetcher.terminate(),this.resizer?.disconnect(),A[this.id]=void 0,delete A[this.id];try{this.gzipWorker&&this.gzipWorker.terminate()}catch(i){console.warn(i)}this.$store.commit("setFullScreen",!1)}});var fe=function(){var t=this,e=t._self._c;return t._self._setupProxy,e("div",{staticClass:"xy-hexagons",class:{"hide-thumbnail":!t.thumbnail},attrs:{oncontextmenu:"return false",id:`id-${t.id}`}},[!t.thumbnail&&t.isLoaded?e("xy-hex-deck-map",t._b({staticClass:"hex-layer"},"xy-hex-deck-map",t.mapProps,!1)):t._e(),t.thumbnail?t._e():e("zoom-buttons"),t.isLoaded&&!t.thumbnail&&t.vizDetails.title?e("div",{staticClass:"left-side"},[e("collapsible-panel",{attrs:{direction:"left",locked:!0}},[t.hexStats?e("div",{staticClass:"panel-items",staticStyle:{color:"#c0f"}},[e("p",{staticClass:"big",staticStyle:{"margin-top":"2rem"}},[t._v(t._s(t.$t("selection"))+":")]),e("h3",{staticStyle:{"margin-top":"-1rem"}},[t._v(t._s(t.$t("areas"))+": "+t._s(t.hexStats.numHexagons)+", "+t._s(t.$t("count"))+": "+t._s(t.hexStats.rows))]),e("button",{staticClass:"button",staticStyle:{color:"#c0f","border-color":"#c0f"},on:{click:t.handleShowSelectionButton}},[t._v(t._s(t.$t("showDetails")))])]):t._e()])],1):t._e(),t.isLoaded&&!t.thumbnail&&!t.myState.statusMessage?e("div",{staticClass:"control-panel",attrs:{"data-testid":"xy-hexagons-control-panel"}},[t._l(Object.keys(t.aggregations),function(s){return e("div",{key:s,staticClass:"panel-item"},[e("p",{staticClass:"ui-label"},[t._v(t._s(s))]),t._l(t.aggregations[s],function(n,a){return e("button",{key:a,staticClass:"button is-small aggregation-button",style:{"margin-bottom":"0.25rem",color:t.activeAggregation===`${s}~${a}`?"white":t.buttonColors[a],border:`1px solid ${t.buttonColors[a]}`,"border-right":`0.4rem solid ${t.buttonColors[a]}`,"border-radius":"4px","background-color":t.activeAggregation===`${s}~${a}`?t.buttonColors[a]:t.$store.state.isDarkMode?"#333":"white"},on:{click:function(o){return t.handleOrigDest(s,a)}}},[t._v(t._s(n.title))])})],2)}),e("div",{staticClass:"panel-item"},[e("p",{staticClass:"ui-label"},[t._v(t._s(t.$t("maxHeight"))+": "+t._s(t.vizDetails.maxHeight))]),e("b-slider",{staticClass:"ui-slider",attrs:{size:"is-small",min:0,max:250,step:5,duration:0,dotSize:12,tooltip:!1},model:{value:t.vizDetails.maxHeight,callback:function(s){t.$set(t.vizDetails,"maxHeight",s)},expression:"vizDetails.maxHeight"}}),e("p",{staticClass:"ui-label"},[t._v("Hex Radius: "+t._s(t.vizDetails.radius))]),e("b-slider",{staticClass:"ui-slider",attrs:{size:"is-small",min:50,max:1e3,step:5,duration:0,dotSize:12,tooltip:!1},model:{value:t.vizDetails.radius,callback:function(s){t.$set(t.vizDetails,"radius",s)},expression:"vizDetails.radius"}})],1)],2):t._e(),!t.thumbnail&&t.myState.statusMessage?e("div",{staticClass:"message"},[e("p",{staticClass:"status-message"},[t._v(t._s(t.myState.statusMessage))])]):t._e()],1)},ye=[],Se=rt(pe,fe,ye,!1,null,"1ac90ce1");const Be=Se.exports;export{Be as default};
