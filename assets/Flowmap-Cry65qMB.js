import{d as te,g as $t,m as Ci,n as ee}from"./index-D_sw2g-2.js";import{c as xi}from"./turf.es-BzqbG201.js";import{Y as de}from"./index-DFKcNkqO.js";import{W as Si}from"./NewXmlFetcher.worker-DdEXgVTv.js";import{Z as Fi}from"./ZoomButtons-B4PrQ7mG.js";import{d as Di}from"./index-CCqgbF9K.js";import{r as Ke}from"./range-OtVwhkKS.js";import{s as _i,a as Mi}from"./sequential-pySAYR1V.js";import{j as Ti,e as ie,b as Je,r as Ei,p as Ii,q as Qe,s as Pi,t as Ht}from"./cubehelix-BzW-tINw.js";import{p as Ai,l as Oi,b as zi}from"./pow-RbZoge3Z.js";import{Q as Bi,R as ki,T as Ri,U as $i,V as Hi,W as Ni,X as Gi,Y as Ui,Z as ji,_ as Wi,$ as Yi,a0 as Zi,a1 as qi,a2 as Xi,a3 as Vi,a4 as Ki,a5 as Ji,a6 as Qi,D as tn,A as en,B as nn,C as on}from"./ColorsAndWidths-D0mbSer2.js";import{w as sn,c as rn}from"./rainbow-DNS2KC2A.js";import{c as an,u as ln,H as cn}from"./HTTPFileSystem-ChhivMzi.js";import{e as Nt}from"./extent-Ccx1MofX.js";import{m as ti,A as xt}from"./min-C6O82vcA.js";import{r as ei}from"./group-hI8ly2Wr.js";import{Z as fe,_ as un,$ as ge,n as ct,a0 as Ft,a1 as hn,a as pe,f as dn,a2 as fn,a3 as gn,a4 as pn,a5 as mn,a6 as vn,a7 as yn,a8 as Dt,a9 as _t,aa as wn,ab as bn,ac as Ln,ad as me,ae as Cn,af as ii,ag as xn,v as ne,G as oe,H as se,I as re,J as ae}from"./layer-T9N9JmIf.js";import{t as B,a as tt}from"./defaultLocale-Zq5WfVW0.js";import{s as Sn,h as Fn,i as Dn,j as _n,g as Mn,t as Tn}from"./year-Cg8DRz0f.js";import{C as En,S as In,T as Pn}from"./geojson-layer-DvtTfj7b.js";import{e as ve,d as An}from"./threeDBuildings-eDgufgS4.js";import{M as On}from"./mapbox-overlay-HS93bZkL.js";import{D as ye}from"./DashboardDataManager-mkjvCydQ.js";import{C as zn}from"./Coords-C-Mhj230.js";import{B as Bn}from"./BackgroundLayers-Dp9DDZZa.js";import"./threshold-CrWFx_nu.js";import"./index-_doEQLKC.js";import"./precisionRound-CRsIqO1V.js";import"./fxp-DjoqftHf.js";import"./geo-utils-DZRrIAx0.js";var dt={exports:{}},kn=dt.exports,we;function Rn(){return we||(we=1,(function(i){(function(e,t,n){function o(s){var c=this,h=a();c.next=function(){var u=2091639*c.s0+c.c*23283064365386963e-26;return c.s0=c.s1,c.s1=c.s2,c.s2=u-(c.c=u|0)},c.c=1,c.s0=h(" "),c.s1=h(" "),c.s2=h(" "),c.s0-=h(s),c.s0<0&&(c.s0+=1),c.s1-=h(s),c.s1<0&&(c.s1+=1),c.s2-=h(s),c.s2<0&&(c.s2+=1),h=null}function r(s,c){return c.c=s.c,c.s0=s.s0,c.s1=s.s1,c.s2=s.s2,c}function l(s,c){var h=new o(s),u=c&&c.state,d=h.next;return d.int32=function(){return h.next()*4294967296|0},d.double=function(){return d()+(d()*2097152|0)*11102230246251565e-32},d.quick=d,u&&(typeof u=="object"&&r(u,h),d.state=function(){return r(h,{})}),d}function a(){var s=4022871197,c=function(h){h=String(h);for(var u=0;u<h.length;u++){s+=h.charCodeAt(u);var d=.02519603282416938*s;s=d>>>0,d-=s,d*=s,s=d>>>0,d-=s,s+=d*4294967296}return(s>>>0)*23283064365386963e-26};return c}t&&t.exports?t.exports=l:this.alea=l})(kn,i)})(dt)),dt.exports}var ft={exports:{}},$n=ft.exports,be;function Hn(){return be||(be=1,(function(i){(function(e,t,n){function o(a){var s=this,c="";s.x=0,s.y=0,s.z=0,s.w=0,s.next=function(){var u=s.x^s.x<<11;return s.x=s.y,s.y=s.z,s.z=s.w,s.w^=s.w>>>19^u^u>>>8},a===(a|0)?s.x=a:c+=a;for(var h=0;h<c.length+64;h++)s.x^=c.charCodeAt(h)|0,s.next()}function r(a,s){return s.x=a.x,s.y=a.y,s.z=a.z,s.w=a.w,s}function l(a,s){var c=new o(a),h=s&&s.state,u=function(){return(c.next()>>>0)/4294967296};return u.double=function(){do var d=c.next()>>>11,f=(c.next()>>>0)/4294967296,g=(d+f)/(1<<21);while(g===0);return g},u.int32=c.next,u.quick=u,h&&(typeof h=="object"&&r(h,c),u.state=function(){return r(c,{})}),u}t&&t.exports?t.exports=l:this.xor128=l})($n,i)})(ft)),ft.exports}var gt={exports:{}},Nn=gt.exports,Le;function Gn(){return Le||(Le=1,(function(i){(function(e,t,n){function o(a){var s=this,c="";s.next=function(){var u=s.x^s.x>>>2;return s.x=s.y,s.y=s.z,s.z=s.w,s.w=s.v,(s.d=s.d+362437|0)+(s.v=s.v^s.v<<4^(u^u<<1))|0},s.x=0,s.y=0,s.z=0,s.w=0,s.v=0,a===(a|0)?s.x=a:c+=a;for(var h=0;h<c.length+64;h++)s.x^=c.charCodeAt(h)|0,h==c.length&&(s.d=s.x<<10^s.x>>>4),s.next()}function r(a,s){return s.x=a.x,s.y=a.y,s.z=a.z,s.w=a.w,s.v=a.v,s.d=a.d,s}function l(a,s){var c=new o(a),h=s&&s.state,u=function(){return(c.next()>>>0)/4294967296};return u.double=function(){do var d=c.next()>>>11,f=(c.next()>>>0)/4294967296,g=(d+f)/(1<<21);while(g===0);return g},u.int32=c.next,u.quick=u,h&&(typeof h=="object"&&r(h,c),u.state=function(){return r(c,{})}),u}t&&t.exports?t.exports=l:this.xorwow=l})(Nn,i)})(gt)),gt.exports}var pt={exports:{}},Un=pt.exports,Ce;function jn(){return Ce||(Ce=1,(function(i){(function(e,t,n){function o(a){var s=this;s.next=function(){var h=s.x,u=s.i,d,f;return d=h[u],d^=d>>>7,f=d^d<<24,d=h[u+1&7],f^=d^d>>>10,d=h[u+3&7],f^=d^d>>>3,d=h[u+4&7],f^=d^d<<7,d=h[u+7&7],d=d^d<<13,f^=d^d<<9,h[u]=f,s.i=u+1&7,f};function c(h,u){var d,f=[];if(u===(u|0))f[0]=u;else for(u=""+u,d=0;d<u.length;++d)f[d&7]=f[d&7]<<15^u.charCodeAt(d)+f[d+1&7]<<13;for(;f.length<8;)f.push(0);for(d=0;d<8&&f[d]===0;++d);for(d==8?f[7]=-1:f[d],h.x=f,h.i=0,d=256;d>0;--d)h.next()}c(s,a)}function r(a,s){return s.x=a.x.slice(),s.i=a.i,s}function l(a,s){a==null&&(a=+new Date);var c=new o(a),h=s&&s.state,u=function(){return(c.next()>>>0)/4294967296};return u.double=function(){do var d=c.next()>>>11,f=(c.next()>>>0)/4294967296,g=(d+f)/(1<<21);while(g===0);return g},u.int32=c.next,u.quick=u,h&&(h.x&&r(h,c),u.state=function(){return r(c,{})}),u}t&&t.exports?t.exports=l:this.xorshift7=l})(Un,i)})(pt)),pt.exports}var mt={exports:{}},Wn=mt.exports,xe;function Yn(){return xe||(xe=1,(function(i){(function(e,t,n){function o(a){var s=this;s.next=function(){var h=s.w,u=s.X,d=s.i,f,g;return s.w=h=h+1640531527|0,g=u[d+34&127],f=u[d=d+1&127],g^=g<<13,f^=f<<17,g^=g>>>15,f^=f>>>12,g=u[d]=g^f,s.i=d,g+(h^h>>>16)|0};function c(h,u){var d,f,g,v,w,m=[],C=128;for(u===(u|0)?(f=u,u=null):(u=u+"\0",f=0,C=Math.max(C,u.length)),g=0,v=-32;v<C;++v)u&&(f^=u.charCodeAt((v+32)%u.length)),v===0&&(w=f),f^=f<<10,f^=f>>>15,f^=f<<4,f^=f>>>13,v>=0&&(w=w+1640531527|0,d=m[v&127]^=f+w,g=d==0?g+1:0);for(g>=128&&(m[(u&&u.length||0)&127]=-1),g=127,v=512;v>0;--v)f=m[g+34&127],d=m[g=g+1&127],f^=f<<13,d^=d<<17,f^=f>>>15,d^=d>>>12,m[g]=f^d;h.w=w,h.X=m,h.i=g}c(s,a)}function r(a,s){return s.i=a.i,s.w=a.w,s.X=a.X.slice(),s}function l(a,s){a==null&&(a=+new Date);var c=new o(a),h=s&&s.state,u=function(){return(c.next()>>>0)/4294967296};return u.double=function(){do var d=c.next()>>>11,f=(c.next()>>>0)/4294967296,g=(d+f)/(1<<21);while(g===0);return g},u.int32=c.next,u.quick=u,h&&(h.X&&r(h,c),u.state=function(){return r(c,{})}),u}t&&t.exports?t.exports=l:this.xor4096=l})(Wn,i)})(mt)),mt.exports}var vt={exports:{}},Zn=vt.exports,Se;function qn(){return Se||(Se=1,(function(i){(function(e,t,n){function o(a){var s=this,c="";s.next=function(){var u=s.b,d=s.c,f=s.d,g=s.a;return u=u<<25^u>>>7^d,d=d-f|0,f=f<<24^f>>>8^g,g=g-u|0,s.b=u=u<<20^u>>>12^d,s.c=d=d-f|0,s.d=f<<16^d>>>16^g,s.a=g-u|0},s.a=0,s.b=0,s.c=-1640531527,s.d=1367130551,a===Math.floor(a)?(s.a=a/4294967296|0,s.b=a|0):c+=a;for(var h=0;h<c.length+20;h++)s.b^=c.charCodeAt(h)|0,s.next()}function r(a,s){return s.a=a.a,s.b=a.b,s.c=a.c,s.d=a.d,s}function l(a,s){var c=new o(a),h=s&&s.state,u=function(){return(c.next()>>>0)/4294967296};return u.double=function(){do var d=c.next()>>>11,f=(c.next()>>>0)/4294967296,g=(d+f)/(1<<21);while(g===0);return g},u.int32=c.next,u.quick=u,h&&(typeof h=="object"&&r(h,c),u.state=function(){return r(c,{})}),u}t&&t.exports?t.exports=l:this.tychei=l})(Zn,i)})(vt)),vt.exports}var yt={exports:{}},Xn=yt.exports,Fe;function Vn(){return Fe||(Fe=1,(function(i){(function(e,t,n){var o=256,r=6,l=52,a="random",s=n.pow(o,r),c=n.pow(2,l),h=c*2,u=o-1,d;function f(y,b,F){var x=[];b=b==!0?{entropy:!0}:b||{};var p=m(w(b.entropy?[y,E(t)]:y??C(),3),x),S=new g(x),M=function(){for(var _=S.g(r),I=s,O=0;_<c;)_=(_+O)*o,I*=o,O=S.g(1);for(;_>=h;)_/=2,I/=2,O>>>=1;return(_+O)/I};return M.int32=function(){return S.g(4)|0},M.quick=function(){return S.g(4)/4294967296},M.double=M,m(E(S.S),t),(b.pass||F||function(_,I,O,R){return R&&(R.S&&v(R,S),_.state=function(){return v(S,{})}),O?(n[a]=_,I):_})(M,p,"global"in b?b.global:this==n,b.state)}function g(y){var b,F=y.length,x=this,p=0,S=x.i=x.j=0,M=x.S=[];for(F||(y=[F++]);p<o;)M[p]=p++;for(p=0;p<o;p++)M[p]=M[S=u&S+y[p%F]+(b=M[p])],M[S]=b;(x.g=function(_){for(var I,O=0,R=x.i,D=x.j,T=x.S;_--;)I=T[R=u&R+1],O=O*o+T[u&(T[R]=T[D=u&D+I])+(T[D]=I)];return x.i=R,x.j=D,O})(o)}function v(y,b){return b.i=y.i,b.j=y.j,b.S=y.S.slice(),b}function w(y,b){var F=[],x=typeof y,p;if(b&&x=="object")for(p in y)try{F.push(w(y[p],b-1))}catch{}return F.length?F:x=="string"?y:y+"\0"}function m(y,b){for(var F=y+"",x,p=0;p<F.length;)b[u&p]=u&(x^=b[u&p]*19)+F.charCodeAt(p++);return E(b)}function C(){try{var y;return d&&(y=d.randomBytes)?y=y(o):(y=new Uint8Array(o),(e.crypto||e.msCrypto).getRandomValues(y)),E(y)}catch{var b=e.navigator,F=b&&b.plugins;return[+new Date,e,F,e.screen,E(t)]}}function E(y){return String.fromCharCode.apply(0,y)}if(m(n.random(),t),i.exports){i.exports=f;try{d=an}catch{}}else n["seed"+a]=f})(typeof self<"u"?self:Xn,[],Math)})(yt)),yt.exports}var Mt,De;function Kn(){if(De)return Mt;De=1;var i=Rn(),e=Hn(),t=Gn(),n=jn(),o=Yn(),r=qn(),l=Vn();return l.alea=i,l.xor128=e,l.xorwow=t,l.xorshift7=n,l.xor4096=o,l.tychei=r,Mt=l,Mt}var Jn=Kn();class wt{constructor(e={width:1,height:1}){this.equals=m=>m instanceof wt?m.width===this.width&&m.height===this.height&&fe(m.projectionMatrix,this.projectionMatrix)&&fe(m.viewMatrix,this.viewMatrix):!1,this.project=(m,C={})=>{const{topLeft:E=!0}=C,y=this.projectPosition(m),b=un(y,this.pixelProjectionMatrix),[F,x]=b,p=E?x:this.height-x;return m.length===2?[F,p]:[F,p,b[2]]},this.unproject=(m,C={})=>{const{topLeft:E=!0,targetZ:y=void 0}=C,[b,F,x]=m,p=E?F:this.height-F,S=y&&y*this.distanceScales.unitsPerMeter[2],M=ge([b,p,x],this.pixelUnprojectionMatrix,S),[_,I,O]=this.unprojectPosition(M);return Number.isFinite(x)?[_,I,O]:Number.isFinite(y)?[_,I,y]:[_,I]},this.projectPosition=m=>{const[C,E]=ct(m),y=(m[2]||0)*this.distanceScales.unitsPerMeter[2];return[C,E,y]},this.unprojectPosition=m=>{const[C,E]=Ft(m),y=(m[2]||0)*this.distanceScales.metersPerUnit[2];return[C,E,y]};let{width:t,height:n,altitude:o=null,fovy:r=null}=e;const{latitude:l=0,longitude:a=0,zoom:s=0,pitch:c=0,bearing:h=0,position:u=null,nearZMultiplier:d=.02,farZMultiplier:f=1.01}=e;t=t||1,n=n||1,r===null&&o===null?(o=hn,r=pe(o)):r===null?r=pe(o):o===null&&(o=dn(r));const g=yn(s);o=Math.max(.75,o);const v=fn({longitude:a,latitude:l}),w=ct([a,l]);w.push(0),u&&gn(w,w,pn([],u,v.unitsPerMeter)),this.projectionMatrix=mn({width:t,height:n,scale:g,center:w,pitch:c,fovy:r,nearZMultiplier:d,farZMultiplier:f}),this.viewMatrix=vn({height:n,scale:g,center:w,pitch:c,bearing:h,altitude:o}),this.width=t,this.height=n,this.scale=g,this.latitude=l,this.longitude=a,this.zoom=s,this.pitch=c,this.bearing=h,this.altitude=o,this.fovy=r,this.center=w,this.meterOffset=u||[0,0,0],this.distanceScales=v,this._initMatrices(),Object.freeze(this)}_initMatrices(){const{width:e,height:t,projectionMatrix:n,viewMatrix:o}=this,r=_t();Dt(r,r,n),Dt(r,r,o),this.viewProjectionMatrix=r;const l=_t();wn(l,l,[e/2,-t/2,1]),bn(l,l,[1,-1,0]),Dt(l,l,r);const a=Ln(_t(),l);if(!a)throw new Error("Pixel project matrix not invertible");this.pixelProjectionMatrix=l,this.pixelUnprojectionMatrix=a}projectFlat(e){return ct(e)}unprojectFlat(e){return Ft(e)}getMapCenterByLngLatPosition({lngLat:e,pos:t}){const n=ge(t,this.pixelUnprojectionMatrix),o=ct(e),r=me([],o,Cn([],n)),l=me([],this.center,r);return Ft(l)}fitBounds(e,t={}){const{width:n,height:o}=this,{longitude:r,latitude:l,zoom:a}=ii(Object.assign({width:n,height:o,bounds:e},t));return new wt({width:n,height:o,longitude:r,latitude:l,zoom:a})}getBounds(e){const t=this.getBoundingRegion(e),n=Math.min(...t.map(a=>a[0])),o=Math.max(...t.map(a=>a[0])),r=Math.min(...t.map(a=>a[1])),l=Math.max(...t.map(a=>a[1]));return[[n,r],[o,l]]}getBoundingRegion(e={}){return xn(this,e.z||0)}getLocationAtPoint({lngLat:e,pos:t}){return this.getMapCenterByLngLatPosition({lngLat:e,pos:t})}}function le(i){const{children:e}=i;return e&&e.length>0}function nt(i){const{zoom:e}=i;return e!==void 0}function Tt(i){return i&&!!i.aggregate}var K;(function(i){i.ALL="ALL",i.INCOMING="INCOMING",i.OUTGOING="OUTGOING",i.BETWEEN="BETWEEN"})(K||(K={}));const Qn="#fff",to=.4,ce="rgba(240,240,240,0.5)",eo=[ce,"#137CBD"],io="rgba(220,220,220,0.5)",no=[ce,"#f6654e"],oo=[ce,"#00a9cc"],so=[255,255,255,255];function ro(i){return Math.round(i*255)}function _e(i,e){const t=Je(i);if(!t)return console.warn("Invalid color: ",i),`rgba(255, 255, 255, ${e})`;const n=t.rgb();return`rgba(${n.r}, ${n.g}, ${n.b}, ${e})`}function G(i){if(Array.isArray(i))return i;const e=Je(i);if(!e)return console.warn("Invalid color: ",i),so;const t=e.rgb();return[Math.floor(t.r),Math.floor(t.g),Math.floor(t.b),ro(e.opacity)]}function N(i,e){return i?G(i):typeof e=="string"?G(e):e}const z=i=>i[i.length-1];var Gt;(function(i){i.primary="#162d3c"})(Gt||(Gt={}));const Me=20,V=i=>Ke(0,Me+1).map(e=>i(e/Me)).reverse(),Ut="rgba(240,240,240,0.5)",ao=[Ut,Gt.primary],lo=["#f7feae","#b7e6a5","#7ccba2","#46aea0","#089099","#00718b","#045275"],co=["#d3f2a3","#97e196","#6cc08b","#4c9b82","#217a79","#105965","#074050"],ni=["#d1eeea","#a8dbd9","#85c4c9","#68abb8","#4f90a6","#3b738f","#2a5674"],uo=ni,ho={Blues:z(Qi),BluGrn:["#c4e6c3","#96d2a4","#6dbc90","#4da284","#36877a","#266b6e","#1d4f60"],BluYl:lo,BrwnYl:["#ede5cf","#e0c2a2","#d39c83","#c1766f","#a65461","#813753","#541f3f"],BuGn:z(Ji),BuPu:z(Ki),Burg:["#ffc6c4","#f4a3a8","#e38191","#cc607d","#ad466c","#8b3058","#672044"],BurgYl:["#fbe6c5","#f5ba98","#ee8a82","#dc7176","#c8586c","#9c3f5d","#70284a"],Cool:V(rn),DarkMint:["#d2fbd4","#a5dbc2","#7bbcb0","#559c9e","#3a7c89","#235d72","#123f5a"],Emrld:co,GnBu:z(Vi),Grayish:ao,Greens:z(Xi),Greys:z(qi),Inferno:V(on),Magenta:["#f3cbd3","#eaa9bd","#dd88ac","#ca699d","#b14d8e","#91357d","#6c2167"],Magma:V(nn),Mint:["#e4f1e1","#b4d9cc","#89c0b6","#63a6a0","#448c8a","#287274","#0d585f"],Oranges:z(Zi),OrRd:z(Yi),OrYel:["#ecda9a","#efc47e","#f3ad6a","#f7945d","#f97b57","#f66356","#ee4d5a"],Peach:["#fde0c5","#facba6","#f8b58b","#f59e72","#f2855d","#ef6a4c","#eb4a40"],Plasma:V(en),PinkYl:["#fef6b5","#ffdd9a","#ffc285","#ffa679","#fa8a76","#f16d7a","#e15383"],PuBu:z(Wi),PuBuGn:z(ji),PuRd:z(Ui),Purp:["#f3e0f7","#e4c7f1","#d1afe8","#b998dd","#9f82ce","#826dba","#63589f"],Purples:z(Gi),PurpOr:["#f9ddda","#f2b9c4","#e597b9","#ce78b3","#ad5fad","#834ba0","#573b88"],RdPu:z(Ni),RedOr:["#f6d2a9","#f5b78e","#f19c7c","#ea8171","#dd686c","#ca5268","#b13f64"],Reds:z(Hi),Sunset:["#f3e79b","#fac484","#f8a07e","#eb7f86","#ce6693","#a059a0","#5c53a5"],SunsetDark:["#fcde9c","#faa476","#f0746e","#e34f6f","#dc3977","#b9257a","#7c1d6f"],Teal:ni,TealGrn:["#b0f2bc","#89e8ac","#67dba5","#4cc8a3","#38b2a3","#2c98a0","#257d98"],Viridis:V(tn),Warm:V(sn),YlGn:z($i),YlGnBu:z(Ri),YlOrBr:z(ki),YlOrRd:z(Bi)},fo="#f52020",go="#17a5be",po={negative:{flows:{scheme:[Ut,go]}},positive:{flows:{scheme:[Ut,fo]}},locationAreas:{outline:"rgba(92,112,128,0.5)",normal:"rgba(220,220,220,0.5)"},outlineColor:"rgb(230,233,237)"};function mo(i){return oi(!1,i.colorScheme,i.darkMode,i.fadeEnabled,i.fadeOpacityEnabled,i.fadeAmount,i.animationEnabled)}function oi(i,e,t,n,o,r,l){if(i)return po;let a;Array.isArray(e)?a=e:(a=e&&ho[e]||uo,t&&(a=a.slice().reverse()));{const s=Ke(0,Math.max(10,a.length)),c=s.length-1,h=_i(Ti(a)).domain([0,c]);if(!n||r===0)a=s.map((u,d)=>h(d));else{const u=Ai().exponent(1.5).domain([c,0]).range([0,2*r/100]);a=s.map((d,f)=>{const g=h(f),v=u(f);if(g==null||v==null)return"#000";const w=ie(g);return w.l=t?w.l-w.l*v:w.l+(100-w.l)*v,w.c=w.c-w.c*(v/4),o&&(w.opacity=w.opacity*(1-v)),w.toString()})}}return{darkMode:t,flows:{scheme:a},locationCircles:{outgoing:t?"#000":"#fff"},outlineColor:t?"#000":"rgba(255, 255, 255, 0.5)"}}function vo(i){const e=Ii,t=i.length;let n=new Array(t),o=new Array(t),r=new Array(t),l=new Array(t),a,s;for(a=0;a<t;++a)s=Ei(i[a]),n[a]=s.r||0,o[a]=s.g||0,r[a]=s.b||0,l[a]=s.opacity||0;return n=e(n),o=e(o),r=e(r),l=e(l),function(c){return s.r=n(c),s.g=o(c),s.b=r(c),s.opacity=l(c),s+""}}function Et(i,e,t){const n=Mi(vo(e)).exponent(.3333333333333333).domain(i);return o=>G(n(o))}function yo(i,e,t){const n=e?e[0]:0,o=e?e[1]:0;if(si(i)){const l=Et([0,o],i.positive.flows.scheme),a=Et([0,n],i.negative.flows.scheme);return s=>s>=0?l(s):a(s)}const r=Et([0,o||0],i.flows.scheme);return l=>r(l)}function wo(i){return i.positive!==void 0}function si(i){return i.positive!==void 0}function bo(i,e){const t=i&&i.normal||io,n=ie(t),o=G(t);return{normal:o,connected:N(i&&i.connected,o),highlighted:N(i&&i.highlighted,_e(n[e?"brighter":"darker"](1).toString(),.5)),selected:N(i&&i.selected,_e(n[e?"brighter":"darker"](2).toString(),.8)),outline:N(i&&i.outline,G(n[e?"brighter":"darker"](4).toString()))}}function jt(i,e,t){const n=i&&i.flows&&i.flows.scheme||e,o=ie(n[n.length-1]),r=N(i&&i.flows&&i.flows.highlighted,G(o[t?"brighter":"darker"](.7).toString())),l=N(i?.locationCircles?.empty,t?"#000":"#fff"),a=N(i&&i.locationCircles&&i.locationCircles.inner,o.toString());return{flows:{scheme:n,highlighted:r},locationCircles:{inner:a,outgoing:N(i&&i.locationCircles&&i.locationCircles.outgoing,t?"#000":"#fff"),incoming:N(i&&i.locationCircles&&i.locationCircles.incoming,o[t?"brighter":"darker"](1.25).toString()),highlighted:N(i&&i.locationCircles&&i.locationCircles.highlighted,r),empty:l,outlineEmptyMix:i?.locationCircles?.outlineEmptyMix??.4}}}function ri(i){const e=!!(i&&i.darkMode);return{darkMode:e,locationAreas:bo(i&&i.locationAreas,e),outlineColor:G(i&&i.outlineColor||Qn),dimmedOpacity:i&&i.dimmedOpacity!=null?i.dimmedOpacity:to}}function Lo(i){const e=ri(i);return{...e,...jt(i,eo,e.darkMode)}}function Co(i){const e=ri(i);return{...e,positive:jt(i&&i.positive,no,e.darkMode),negative:jt(i&&i.negative,oo,e.darkMode)}}const Te=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array],It=1,et=8;class St{static from(e){if(!(e instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[t,n]=new Uint8Array(e,0,2);if(t!==219)throw new Error("Data does not appear to be in a KDBush format.");const o=n>>4;if(o!==It)throw new Error(`Got v${o} data when expected v${It}.`);const r=Te[n&15];if(!r)throw new Error("Unrecognized array type.");const[l]=new Uint16Array(e,2,1),[a]=new Uint32Array(e,4,1);return new St(a,l,r,e)}constructor(e,t=64,n=Float64Array,o){if(isNaN(e)||e<0)throw new Error(`Unpexpected numItems value: ${e}.`);this.numItems=+e,this.nodeSize=Math.min(Math.max(+t,2),65535),this.ArrayType=n,this.IndexArrayType=e<65536?Uint16Array:Uint32Array;const r=Te.indexOf(this.ArrayType),l=e*2*this.ArrayType.BYTES_PER_ELEMENT,a=e*this.IndexArrayType.BYTES_PER_ELEMENT,s=(8-a%8)%8;if(r<0)throw new Error(`Unexpected typed array class: ${n}.`);o&&o instanceof ArrayBuffer?(this.data=o,this.ids=new this.IndexArrayType(this.data,et,e),this.coords=new this.ArrayType(this.data,et+a+s,e*2),this._pos=e*2,this._finished=!0):(this.data=new ArrayBuffer(et+l+a+s),this.ids=new this.IndexArrayType(this.data,et,e),this.coords=new this.ArrayType(this.data,et+a+s,e*2),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,(It<<4)+r]),new Uint16Array(this.data,2,1)[0]=t,new Uint32Array(this.data,4,1)[0]=e)}add(e,t){const n=this._pos>>1;return this.ids[n]=n,this.coords[this._pos++]=e,this.coords[this._pos++]=t,n}finish(){const e=this._pos>>1;if(e!==this.numItems)throw new Error(`Added ${e} items when expected ${this.numItems}.`);return Wt(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(e,t,n,o){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:r,coords:l,nodeSize:a}=this,s=[0,r.length-1,0],c=[];for(;s.length;){const h=s.pop()||0,u=s.pop()||0,d=s.pop()||0;if(u-d<=a){for(let w=d;w<=u;w++){const m=l[2*w],C=l[2*w+1];m>=e&&m<=n&&C>=t&&C<=o&&c.push(r[w])}continue}const f=d+u>>1,g=l[2*f],v=l[2*f+1];g>=e&&g<=n&&v>=t&&v<=o&&c.push(r[f]),(h===0?e<=g:t<=v)&&(s.push(d),s.push(f-1),s.push(1-h)),(h===0?n>=g:o>=v)&&(s.push(f+1),s.push(u),s.push(1-h))}return c}within(e,t,n){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:o,coords:r,nodeSize:l}=this,a=[0,o.length-1,0],s=[],c=n*n;for(;a.length;){const h=a.pop()||0,u=a.pop()||0,d=a.pop()||0;if(u-d<=l){for(let w=d;w<=u;w++)Ee(r[2*w],r[2*w+1],e,t)<=c&&s.push(o[w]);continue}const f=d+u>>1,g=r[2*f],v=r[2*f+1];Ee(g,v,e,t)<=c&&s.push(o[f]),(h===0?e-n<=g:t-n<=v)&&(a.push(d),a.push(f-1),a.push(1-h)),(h===0?e+n>=g:t+n>=v)&&(a.push(f+1),a.push(u),a.push(1-h))}return s}}function Wt(i,e,t,n,o,r){if(o-n<=t)return;const l=n+o>>1;ai(i,e,l,n,o,r),Wt(i,e,t,n,l-1,1-r),Wt(i,e,t,l+1,o,1-r)}function ai(i,e,t,n,o,r){for(;o>n;){if(o-n>600){const c=o-n+1,h=t-n+1,u=Math.log(c),d=.5*Math.exp(2*u/3),f=.5*Math.sqrt(u*d*(c-d)/c)*(h-c/2<0?-1:1),g=Math.max(n,Math.floor(t-h*d/c+f)),v=Math.min(o,Math.floor(t+(c-h)*d/c+f));ai(i,e,t,g,v,r)}const l=e[2*t+r];let a=n,s=o;for(it(i,e,n,t),e[2*o+r]>l&&it(i,e,n,o);a<s;){for(it(i,e,a,s),a++,s--;e[2*a+r]<l;)a++;for(;e[2*s+r]>l;)s--}e[2*n+r]===l?it(i,e,n,s):(s++,it(i,e,s,o)),s<=t&&(n=s+1),t<=s&&(o=s-1)}}function it(i,e,t,n){Pt(i,t,n),Pt(e,2*t,2*n),Pt(e,2*t+1,2*n+1)}function Pt(i,e,t){const n=i[e];i[e]=i[t],i[t]=n}function Ee(i,e,t,n){const o=i-t,r=e-n;return o*o+r*r}var bt="NOT_FOUND";function xo(i){var e;return{get:function(n){return e&&i(e.key,n)?e.value:bt},put:function(n,o){e={key:n,value:o}},getEntries:function(){return e?[e]:[]},clear:function(){e=void 0}}}function So(i,e){var t=[];function n(a){var s=t.findIndex(function(h){return e(a,h.key)});if(s>-1){var c=t[s];return s>0&&(t.splice(s,1),t.unshift(c)),c.value}return bt}function o(a,s){n(a)===bt&&(t.unshift({key:a,value:s}),t.length>i&&t.pop())}function r(){return t}function l(){t=[]}return{get:n,put:o,getEntries:r,clear:l}}var Fo=function(e,t){return e===t};function Do(i){return function(t,n){if(t===null||n===null||t.length!==n.length)return!1;for(var o=t.length,r=0;r<o;r++)if(!i(t[r],n[r]))return!1;return!0}}function li(i,e){var t=typeof e=="object"?e:{equalityCheck:e},n=t.equalityCheck,o=n===void 0?Fo:n,r=t.maxSize,l=r===void 0?1:r,a=t.resultEqualityCheck,s=Do(o),c=l===1?xo(s):So(l,s);function h(){var u=c.get(arguments);if(u===bt){if(u=i.apply(null,arguments),a){var d=c.getEntries(),f=d.find(function(g){return a(g.value,u)});f&&(u=f.value)}c.put(arguments,u)}return u}return h.clearCache=function(){return c.clear()},h}function _o(i){var e=Array.isArray(i[0])?i[0]:i;if(!e.every(function(n){return typeof n=="function"})){var t=e.map(function(n){return typeof n=="function"?"function "+(n.name||"unnamed")+"()":typeof n}).join(", ");throw new Error("createSelector expects all input-selectors to be functions, but received the following types: ["+t+"]")}return e}function ci(i){for(var e=arguments.length,t=new Array(e>1?e-1:0),n=1;n<e;n++)t[n-1]=arguments[n];var o=function(){for(var l=arguments.length,a=new Array(l),s=0;s<l;s++)a[s]=arguments[s];var c=0,h,u={memoizeOptions:void 0},d=a.pop();if(typeof d=="object"&&(u=d,d=a.pop()),typeof d!="function")throw new Error("createSelector expects an output function after the inputs, but received: ["+typeof d+"]");var f=u,g=f.memoizeOptions,v=g===void 0?t:g,w=Array.isArray(v)?v:[v],m=_o(a),C=i.apply(void 0,[function(){return c++,d.apply(null,arguments)}].concat(w)),E=i(function(){for(var b=[],F=m.length,x=0;x<F;x++)b.push(m[x].apply(null,arguments));return h=C.apply(null,b),h});return Object.assign(E,{resultFunc:d,memoizedResultFunc:C,dependencies:m,lastResult:function(){return h},recomputations:function(){return c},resetRecomputations:function(){return c=0}}),E};return o}var L=ci(li);class Yt{constructor(e){this.getLocationId=t=>nt(t)?t.id:this.accessors.getLocationId(t),this.getLocationName=t=>{let n;return nt(t)&&le(t)?n=t.name:this.accessors.getLocationName&&(n=this.accessors.getLocationName(t)),n||(n=`${this.getLocationId(t)}`),n},this.getLocationLat=t=>nt(t)?t.lat:this.accessors.getLocationLat(t),this.getLocationLon=t=>nt(t)?t.lon:this.accessors.getLocationLon(t),this.getFlowOriginId=t=>Tt(t)?t.origin:this.accessors.getFlowOriginId(t),this.getFlowDestId=t=>Tt(t)?t.dest:this.accessors.getFlowDestId(t),this.getFlowMagnitude=t=>Tt(t)?t.count:this.accessors.getFlowMagnitude(t),this.getFlowTime=t=>{const{getFlowTime:n}=this.accessors;return n?n(t):void 0},this.accessors=e}setAccessors(e){this.accessors=e}getFlowmapDataAccessors(){return this.accessors}}function Mo(i){const e=new Map,t=new Map,n=new Map;for(const{zoom:u,nodes:d}of i){e.set(u,d);for(const f of d)if(le(f))t.set(f.id,f);else{const{id:g}=f,v=n.get(g);(v==null||v>u)&&n.set(g,u)}}const[o,r]=Nt(i,u=>u.zoom);if(o==null||r==null)throw new Error("Could not determine minZoom or maxZoom");const l=new Map;for(const u of t.values()){const{zoom:d}=u;let f=l.get(d);f||(f=new Map,l.set(d,f)),a(u,g=>{f?.set(g,u)})}function a(u,d){for(const f of u.children){const g=t.get(f);g?a(g,d):d(f)}}const s=(u,d=r)=>{const f=[],g=(v,w)=>{if(d>v.zoom)for(const m of v.children){const C=t.get(m);C?g(C,w):w.push(m)}else w.push(v.id)};return g(u,f),f};function c(u,d){const f=l.get(d);if(!f)return;const g=f.get(u);return g?g.id:void 0}return{availableZoomLevels:i.map(u=>+u.zoom).sort((u,d)=>Qe(u,d)),getClusterNodesFor:u=>{if(u!==void 0)return e.get(u)},getClusterById:u=>t.get(u),getMinZoomForLocation:u=>n.get(u)||o,expandCluster:s,findClusterFor:c,aggregateFlows:(u,d,{getFlowOriginId:f,getFlowDestId:g,getFlowMagnitude:v},w={})=>{if(d>r)return u;const m=[],C=new Map,E=(b,F)=>`${b}:${F}`,{flowCountsMapReduce:y={map:v,reduce:(b,F)=>(b||0)+F}}=w;for(const b of u){const F=f(b),x=g(b),p=c(F,d)||F,S=c(x,d)||x,M=E(p,S);if(p===F&&S===x)m.push(b);else{let _=C.get(M);_?_.count=y.reduce(_.count,y.map(b)):(_={origin:p,dest:S,count:y.map(b),aggregate:!0},m.push(_),C.set(M,_))}}return m}}}function To(i,{getFlowOriginId:e,getFlowDestId:t,getFlowMagnitude:n}){const o={incoming:new Map,outgoing:new Map};for(const r of i){const l=e(r),a=t(r),s=n(r);o.incoming.set(a,(o.incoming.get(a)||0)+s),o.outgoing.set(l,(o.outgoing.get(l)||0)+s)}return r=>Math.max(Math.abs(o.incoming.get(r)||0),Math.abs(o.outgoing.get(r)||0))}function Eo(i,e){if(!i.length)throw new Error("No available zoom levels");return i[Math.min(Pi(i,Math.floor(e)),i.length-1)]}const Io={minZoom:0,maxZoom:16,radius:40,extent:512,nodeSize:64,makeClusterName:(i,e)=>{},makeClusterId:i=>`{[${i}]}`};function Po(i){const{index:e}=i;return e!=null}function ui(i){const{id:e}=i;return e!=null}function Ao(i,e,t,n){const{getLocationLon:o,getLocationLat:r,getLocationId:l}=e,a={...Io,...n},{minZoom:s,maxZoom:c,nodeSize:h,makeClusterName:u,makeClusterId:d}=a,f=new Array(c+1);let g=new Array,v=0;for(const p of i){const S=o(p),M=r(p);g.push({x:Ro(S),y:$o(M),weight:t(l(p)),zoom:1/0,index:v,parentId:-1,location:p}),v++}const w=p=>{const S=new St(p.length,h,Float32Array);for(let M=0;M<p.length;M++)S.add(p[M].x,p[M].y);return S.finish(),S.points=p,S};f[c+1]=w(g);let m=c+1;for(let p=c;p>=s;p--){const S=zo(g,p,f[m],a);S.length===g.length?(f[p]=f[m],f[m]=void 0,m=p,g=S):(m=p,g=S,f[p]=w(g))}if(f.length===0)return[];const C=f.map(p=>p?.points.length),E=ti(C.filter(p=>p>0));let y=No(C)??C.length-1;const b=Ho(i,e);if(b<v){const p=Go(C,S=>S<=b);p>=0&&(p<y&&(f[p+1]=f[y],f.splice(p+2)),y=p+1)}const F=Math.min(y,E?C.lastIndexOf(E):y),x=new Array;m=NaN;for(let p=y;p>=F;p--){let S;const M=f[p];if(!M)continue;f[m]&&p<y&&(S=ei(f[m].points,I=>I.map(O=>O.id?d(O.id):l(O.location)),I=>I.parentId));const _=[];for(const I of M.points){const{x:O,y:R,numPoints:D,location:T}=I;if(Po(I))_.push({id:l(T),zoom:p,lat:r(T),lon:o(T)});else if(ui(I)){const{id:X}=I,he=S&&S.get(X);if(!he){console.warn("Omitting cluster with no children, point:",I);continue}const Li={id:d(X),name:u(X,D),zoom:p,lat:ko(R),lon:Bo(O),children:he??[]};_.push(Li)}}x.push({zoom:p,nodes:_}),m=p}return x}function Oo(i,e,t,n,o){return{x:i,y:e,zoom:1/0,id:t,parentId:-1,numPoints:n,weight:o}}function zo(i,e,t,n){const o=[],{radius:r,extent:l}=n,a=r/(l*Math.pow(2,e));for(let s=0;s<i.length;s++){const c=i[s];if(c.zoom<=e)continue;c.zoom=e;const h=t.within(c.x,c.y,a);let u=c.weight||1,d=ui(c)?c.numPoints:1,f=c.x*u,g=c.y*u;const v=(s<<5)+(e+1);for(const w of h){const m=t.points[w];if(m.zoom<=e)continue;m.zoom=e;const C=m.weight||1,E=m.numPoints||1;f+=m.x*C,g+=m.y*C,u+=C,d+=E,m.parentId=v}d===1?o.push(c):(c.parentId=v,o.push(Oo(f/u,g/u,v,d,u)))}return o}function Bo(i){return(i-.5)*360}function ko(i){const e=(180-i*360)*Math.PI/180;return 360*Math.atan(Math.exp(e))/Math.PI-90}function Ro(i){return i/360+.5}function $o(i){const e=Math.sin(i*Math.PI/180),t=.5-.25*Math.log((1+e)/(1-e))/Math.PI;return t<0?0:t>1?1:t}function Ho(i,e){const{getLocationLon:t,getLocationLat:n}=e,o=new Map;let r=0;for(const l of i){const a=t(l),s=n(l),c=`${a},${s}`,h=o.get(c);h||r++,o.set(c,h?h+1:1)}return r}function No(i){let e=-1/0,t;for(let n=0;n<i.length;n++){const o=i[n];typeof o=="number"&&o>e&&(e=o,t=n)}return t}function Go(i,e){for(let t=i.length-1;t>=0;t--)if(e(i[t],t,i))return t;return-1}const Uo=(i,e=0)=>{const t=e,n=new wt({...i,width:i.width+t*2,height:i.height+t*2}).getBounds();return[n[0][0],n[0][1],n[1][0],n[1][1]]},jo=i=>{if(i)return Oi().range([.025,.5]).domain([0,Math.max.apply(null,i.map(e=>Math.abs(e||0)))])};function Wo(i,e,t,n,o){const{getLocationId:r,getLocationName:l,getLocationClusterName:a}=n,s=c=>{const h=t.get(c);return h?l?l(h):r(h)||c:`"${c}"`};for(const c of e)for(const h of c.nodes)if(le(h)){const u=i.expandCluster(h);if(u.sort((d,f)=>Ht(o(d),o(f))),a)h.name=a(u);else{const d=u[0],f=u.length===2?u[1]:void 0;h.name=`"${s(d)}" and ${f?`"${s(f)}"`:`${u.length-1} others`}`}}else h.name=s(h.id)}tt("%Y-%m-%d"),tt("%Y-%m-%d %H:%M"),tt("%Y-%m-%d %H:%M:%S"),tt("%Y"),tt("%Y-%m");var Y;(function(i){i.SECOND="SECOND",i.MINUTE="MINUTE",i.HOUR="HOUR",i.DAY="DAY",i.MONTH="MONTH",i.YEAR="YEAR"})(Y||(Y={}));B(".%L");const Yo=B(":%S"),Zo=B("%I:%M"),qo=B("%I %p"),Xo=B("%a %d");B("%b %d");const Vo=B("%b"),Ko=B("%Y"),ot=[{order:0,key:Y.SECOND,interval:Sn,format:Yo,formatFull:B("%Y-%m-%d %H:%M:%S")},{order:1,key:Y.MINUTE,interval:Fn,format:Zo,formatFull:B("%Y-%m-%d %H:%M")},{order:2,key:Y.HOUR,interval:Dn,format:qo,formatFull:B("%a %d %b %Y, %I %p")},{order:3,key:Y.DAY,interval:_n,format:Xo,formatFull:B("%a %d %b %Y")},{order:4,key:Y.MONTH,interval:Mn,format:Vo,formatFull:B("%b %Y")},{order:5,key:Y.YEAR,interval:Tn,format:Ko,formatFull:B("%Y")}];function Ie(i){return ot.find(e=>e.key===i)}function Jo(i){return ot.find(e=>e.order===i)}function Qo(i){let e;for(const t of ot){const{interval:n}=t;if(n(i)<i)return e||t;e=t}return ot[ot.length-1]}const ts=20;class es{constructor(e){this.getFlowsFromProps=(t,n)=>n.flows,this.getLocationsFromProps=(t,n)=>n.locations,this.getClusterLevelsFromProps=(t,n)=>n.clusterLevels,this.getMaxTopFlowsDisplayNum=(t,n)=>t.settings.maxTopFlowsDisplayNum,this.getSelectedLocations=(t,n)=>t.filter?.selectedLocations,this.getLocationFilterMode=(t,n)=>t.filter?.locationFilterMode,this.getClusteringEnabled=(t,n)=>t.settings.clusteringEnabled,this.getLocationTotalsEnabled=(t,n)=>t.settings.locationTotalsEnabled,this.getLocationLabelsEnabled=(t,n)=>t.settings.locationLabelsEnabled,this.getZoom=(t,n)=>t.viewport.zoom,this.getViewport=(t,n)=>t.viewport,this.getSelectedTimeRange=(t,n)=>t.filter?.selectedTimeRange,this.getColorScheme=(t,n)=>t.settings.colorScheme,this.getDarkMode=(t,n)=>t.settings.darkMode,this.getFadeEnabled=(t,n)=>t.settings.fadeEnabled,this.getFadeOpacityEnabled=(t,n)=>t.settings.fadeOpacityEnabled,this.getFadeAmount=(t,n)=>t.settings.fadeAmount,this.getAnimate=(t,n)=>t.settings.animationEnabled,this.getInvalidLocationIds=L(this.getLocationsFromProps,t=>{if(!t)return;const n=[];for(const o of t){const r=this.accessors.getLocationId(o),l=this.accessors.getLocationLon(o),a=this.accessors.getLocationLat(o);(!(-90<=a&&a<=90)||!(-180<=l&&l<=180))&&n.push(r)}return n.length>0?n:void 0}),this.getLocations=L(this.getLocationsFromProps,this.getInvalidLocationIds,(t,n)=>{if(!t)return;if(!n||n.length===0)return t;const o=new Set(n),r=[];for(const l of t){const a=this.accessors.getLocationId(l);o.has(a)||r.push(l)}return r}),this.getLocationIds=L(this.getLocations,t=>{if(!t)return;const n=new Set;for(const o of t)n.add(this.accessors.getLocationId(o));return n}),this.getSelectedLocationsSet=L(this.getSelectedLocations,t=>t&&t.length>0?new Set(t):void 0),this.getSortedFlowsForKnownLocations=L(this.getFlowsFromProps,this.getLocationIds,(t,n)=>{if(!n||!t)return;const o=[];for(const r of t){const l=this.accessors.getFlowOriginId(r),a=this.accessors.getFlowDestId(r);n.has(l)&&n.has(a)&&o.push(r)}return o.sort((r,l)=>Ht(Math.abs(this.accessors.getFlowMagnitude(r)),Math.abs(this.accessors.getFlowMagnitude(l))))}),this.getActualTimeExtent=L(this.getSortedFlowsForKnownLocations,t=>{if(!t)return;let n=null,o=null;for(const r of t){const l=this.accessors.getFlowTime(r);l&&((n==null||n>l)&&(n=l),(o==null||o<l)&&(o=l))}if(!(!n||!o))return[n,o]}),this.getTimeGranularityKey=L(this.getSortedFlowsForKnownLocations,this.getActualTimeExtent,(t,n)=>{if(!t||!n)return;const o=ti(t,l=>{const a=this.accessors.getFlowTime(l);return a?Qo(a).order:null});if(o==null)return;const r=Jo(o);return r?r.key:void 0}),this.getTimeExtent=L(this.getActualTimeExtent,this.getTimeGranularityKey,(t,n)=>{const o=n?Ie(n):void 0;if(!t||!o?.interval)return;const{interval:r}=o;return[t[0],r.offset(r.floor(t[1]),1)]}),this.getSortedFlowsForKnownLocationsFilteredByTime=L(this.getSortedFlowsForKnownLocations,this.getTimeExtent,this.getSelectedTimeRange,(t,n,o)=>{if(t)return!n||!o||n[0]===o[0]&&n[1]===o[1]?t:t.filter(r=>{const l=this.accessors.getFlowTime(r);return l&&o[0]<=l&&l<o[1]})}),this.getLocationsHavingFlows=L(this.getSortedFlowsForKnownLocations,this.getLocations,(t,n)=>{if(!n||!t)return n;const o=new Set;for(const l of t)o.add(this.accessors.getFlowOriginId(l)),o.add(this.accessors.getFlowDestId(l));const r=[];for(const l of n)o.has(this.accessors.getLocationId(l))&&r.push(l);return r}),this.getLocationsById=L(this.getLocationsHavingFlows,t=>{if(!t)return;const n=new Map;for(const o of t)n.set(this.accessors.getLocationId(o),o);return n}),this.getLocationWeightGetter=L(this.getSortedFlowsForKnownLocations,t=>t?To(t,this.accessors.getFlowmapDataAccessors()):void 0),this.getClusterLevels=L(this.getClusterLevelsFromProps,this.getLocationsHavingFlows,this.getLocationWeightGetter,(t,n,o)=>t||(!n||!o?void 0:Ao(n,this.accessors.getFlowmapDataAccessors(),o,{maxZoom:ts}))),this.getClusterIndex=L(this.getLocationsById,this.getLocationWeightGetter,this.getClusterLevels,(t,n,o)=>{if(!t||!n||!o)return;const r=Mo(o);return Wo(r,o,t,this.accessors.getFlowmapDataAccessors(),n),r}),this.getAvailableClusterZoomLevels=L(this.getClusterIndex,this.getSelectedLocations,(t,n)=>{if(!t)return;let o=Number.POSITIVE_INFINITY,r=Number.NEGATIVE_INFINITY;const l=a=>{const s=t.getClusterById(a);if(s)r=Math.max(r,s.zoom),o=Math.min(o,s.zoom);else{const c=t.getMinZoomForLocation(a);r=Math.max(r,c)}};if(n)for(const a of n)l(a);return t.availableZoomLevels.filter(a=>r<=a&&a<=o)}),this._getClusterZoom=L(this.getClusterIndex,this.getZoom,this.getAvailableClusterZoomLevels,(t,n,o)=>!t||!o||n==null?void 0:Eo(o,n)),this.getClusterZoom=(t,n)=>{const{settings:o}=t;if(o.clusteringEnabled)return o.clusteringAuto||o.clusteringLevel==null?this._getClusterZoom(t,n):o.clusteringLevel},this.getLocationsForSearchBox=L(this.getClusteringEnabled,this.getLocationsHavingFlows,this.getSelectedLocations,this.getClusterZoom,this.getClusterIndex,(t,n,o,r,l)=>{if(!n)return;let a=Array.from(n);if(l&&o){const s=[];for(const c of o){const h=l.getClusterById(c);h&&!a.find(u=>(nt(u)?u.id:this.accessors.getLocationId(u))===c)&&s.push(h)}s.length>0&&(a=a.concat(s))}return a}),this.getDiffMode=L(this.getFlowsFromProps,t=>{if(t){for(const n of t)if(this.accessors.getFlowMagnitude(n)<0)return!0}return!1}),this._getFlowmapColors=L(this.getDiffMode,this.getColorScheme,this.getDarkMode,this.getFadeEnabled,this.getFadeOpacityEnabled,this.getFadeAmount,this.getAnimate,oi),this.getFlowmapColorsRGBA=L(this._getFlowmapColors,t=>wo(t)?Co(t):Lo(t)),this.getUnknownLocations=L(this.getLocationIds,this.getFlowsFromProps,this.getSortedFlowsForKnownLocations,(t,n,o)=>{if(!t||!n||o)return;const r=new Set;for(const l of n)t.has(this.accessors.getFlowOriginId(l))||r.add(this.accessors.getFlowOriginId(l)),t.has(this.accessors.getFlowDestId(l))||r.add(this.accessors.getFlowDestId(l));return r}),this.getSortedAggregatedFilteredFlows=L(this.getClusterIndex,this.getClusteringEnabled,this.getSortedFlowsForKnownLocationsFilteredByTime,this.getClusterZoom,this.getTimeExtent,(t,n,o,r,l)=>{if(!o)return;let a;return n&&t&&r!=null?a=t.aggregateFlows(o,r,this.accessors.getFlowmapDataAccessors()):a=is(o,this.accessors.getFlowmapDataAccessors()),a.sort((s,c)=>Ht(Math.abs(this.accessors.getFlowMagnitude(s)),Math.abs(this.accessors.getFlowMagnitude(c)))),a}),this.getExpandedSelectedLocationsSet=L(this.getClusteringEnabled,this.getSelectedLocationsSet,this.getClusterIndex,(t,n,o)=>{if(!n||!o)return n;const r=new Set;for(const l of n){const a=o.getClusterById(l);if(a){const s=o.expandCluster(a);for(const c of s)r.add(c)}else r.add(l)}return r}),this.getTotalCountsByTime=L(this.getSortedFlowsForKnownLocations,this.getTimeGranularityKey,this.getTimeExtent,this.getExpandedSelectedLocationsSet,this.getLocationFilterMode,(t,n,o,r,l)=>{const a=n?Ie(n):void 0;if(!t||!a||!o)return;const s=t.reduce((c,h)=>{if(this.isFlowInSelection(h,r,l)){const u=a.interval(this.accessors.getFlowTime(h)).getTime();c.set(u,(c.get(u)??0)+this.accessors.getFlowMagnitude(h))}return c},new Map);return Array.from(s.entries()).map(([c,h])=>({time:new Date(c),count:h}))}),this.getMaxLocationCircleSize=L(this.getLocationTotalsEnabled,t=>t?17:1),this.getViewportBoundingBox=L(this.getViewport,this.getMaxLocationCircleSize,Uo),this.getLocationsForZoom=L(this.getClusteringEnabled,this.getLocationsHavingFlows,this.getClusterIndex,this.getClusterZoom,(t,n,o,r)=>t&&o?o.getClusterNodesFor(r):n),this.getLocationTotals=L(this.getLocationsForZoom,this.getSortedAggregatedFilteredFlows,this.getSelectedLocationsSet,this.getLocationFilterMode,(t,n,o,r)=>{if(!n)return;const l=new Map,a=(s,c)=>{const h=l.get(s)??{incomingCount:0,outgoingCount:0,internalCount:0};return c.incomingCount!=null&&(h.incomingCount+=c.incomingCount),c.outgoingCount!=null&&(h.outgoingCount+=c.outgoingCount),c.internalCount!=null&&(h.internalCount+=c.internalCount),h};for(const s of n)if(this.isFlowInSelection(s,o,r)){const c=this.accessors.getFlowOriginId(s),h=this.accessors.getFlowDestId(s),u=this.accessors.getFlowMagnitude(s);c===h?l.set(c,a(c,{internalCount:u})):(l.set(c,a(c,{outgoingCount:u})),l.set(h,a(h,{incomingCount:u})))}return l}),this.getLocationsTree=L(this.getLocationsForZoom,t=>{if(!t)return;const n=Array.isArray(t)?t:Array.from(t),o=new St(n.length,64,Float32Array);for(let r=0;r<n.length;r++){const l=n[r];o.add(At(this.accessors.getLocationLon(l)),Ot(this.accessors.getLocationLat(l)))}return o.finish(),o.points=n,o}),this._getLocationIdsInViewport=L(this.getLocationsTree,this.getViewportBoundingBox,(t,n)=>{const o=this._getLocationsInBboxIndices(t,n);if(o)return new Set(o.map(r=>this.accessors.getLocationId(t.points[r])))}),this.getLocationIdsInViewport=ci(li,(t,n,o)=>{if(t===n)return!0;if(t==null||n==null||t.size!==n.size)return!1;for(const r of t)if(!n.has(r))return!1;return!0})(this._getLocationIdsInViewport,t=>{if(t)return t}),this.getTotalUnfilteredCount=L(this.getSortedFlowsForKnownLocations,t=>{if(t)return t.reduce((n,o)=>n+this.accessors.getFlowMagnitude(o),0)}),this.getTotalFilteredCount=L(this.getSortedAggregatedFilteredFlows,this.getSelectedLocationsSet,this.getLocationFilterMode,(t,n,o)=>t?t.reduce((l,a)=>this.isFlowInSelection(a,n,o)?l+this.accessors.getFlowMagnitude(a):l,0):void 0),this._getLocationTotalsExtent=L(this.getLocationTotals,t=>Pe(t,void 0)),this._getLocationTotalsForViewportExtent=L(this.getLocationTotals,this.getLocationIdsInViewport,(t,n)=>Pe(t,n)),this.getLocationTotalsExtent=(t,n)=>t.settings.adaptiveScalesEnabled?this._getLocationTotalsForViewportExtent(t,n):this._getLocationTotalsExtent(t,n),this.getFlowsForFlowmapLayer=L(this.getSortedAggregatedFilteredFlows,this.getLocationIdsInViewport,this.getSelectedLocationsSet,this.getLocationFilterMode,this.getMaxTopFlowsDisplayNum,(t,n,o,r,l)=>{if(!t||!n)return;const a=[];let s=0;for(const c of t){const h=this.accessors.getFlowOriginId(c),u=this.accessors.getFlowDestId(c);if((n.has(h)||n.has(u))&&this.isFlowInSelection(c,o,r)&&h!==u&&(a.push(c),s++),s>l)break}return a.reverse()}),this._getFlowMagnitudeExtent=L(this.getSortedAggregatedFilteredFlows,this.getSelectedLocationsSet,this.getLocationFilterMode,(t,n,o)=>{if(!t)return;let r;for(const l of t)if(this.accessors.getFlowOriginId(l)!==this.accessors.getFlowDestId(l)&&this.isFlowInSelection(l,n,o)){const a=this.accessors.getFlowMagnitude(l);r==null?r=[a,a]:(a<r[0]&&(r[0]=a),a>r[1]&&(r[1]=a))}return r}),this._getAdaptiveFlowMagnitudeExtent=L(this.getFlowsForFlowmapLayer,t=>{if(!t)return;const n=Nt(t,this.accessors.getFlowMagnitude);return n[0]!==void 0&&n[1]!==void 0?n:void 0}),this.getFlowMagnitudeExtent=(t,n)=>t.settings.adaptiveScalesEnabled?this._getAdaptiveFlowMagnitudeExtent(t,n):this._getFlowMagnitudeExtent(t,n),this.getLocationMaxAbsTotalGetter=L(this.getLocationTotals,t=>n=>{const o=t?.get(n);if(o)return Math.max(Math.abs(o.incomingCount+o.internalCount),Math.abs(o.outgoingCount+o.internalCount))}),this.getFlowThicknessScale=L(this.getFlowMagnitudeExtent,jo),this.getCircleSizeScale=L(this.getMaxLocationCircleSize,this.getLocationTotalsEnabled,this.getLocationTotalsExtent,(t,n,o)=>{if(!n)return()=>t;if(o)return zi().range([0,t]).domain([0,Math.max.apply(null,o.map(r=>Math.abs(r||0)))])}),this.getInCircleSizeGetter=L(this.getCircleSizeScale,this.getLocationTotals,(t,n)=>o=>{const r=n?.get(o);return r&&t&&t(Math.abs(r.incomingCount+r.internalCount))||0}),this.getOutCircleSizeGetter=L(this.getCircleSizeScale,this.getLocationTotals,(t,n)=>o=>{const r=n?.get(o);return r&&t&&t(Math.abs(r.outgoingCount+r.internalCount))||0}),this.getSortedLocationsForZoom=L(this.getLocationsForZoom,this.getInCircleSizeGetter,this.getOutCircleSizeGetter,(t,n,o)=>t?[...t].sort((l,a)=>{const s=this.accessors.getLocationId(l),c=this.accessors.getLocationId(a);return Qe(Math.max(n(s),o(s)),Math.max(n(c),o(c)))}):void 0),this.getLocationsForFlowmapLayer=L(this.getSortedLocationsForZoom,t=>t),this.getLocationsForFlowmapLayerById=L(this.getLocationsForFlowmapLayer,t=>{if(t)return t.reduce((n,o)=>(n.set(this.accessors.getLocationId(o),o),n),new Map)}),this.getLocationOrClusterByIdGetter=L(this.getClusterIndex,this.getLocationsById,(t,n)=>o=>t?.getClusterById(o)??n?.get(o)),this.getLayersData=L(this.getLocationsForFlowmapLayer,this.getFlowsForFlowmapLayer,this.getFlowmapColorsRGBA,this.getLocationsForFlowmapLayerById,this.getLocationIdsInViewport,this.getInCircleSizeGetter,this.getOutCircleSizeGetter,this.getFlowThicknessScale,this.getAnimate,this.getLocationLabelsEnabled,(t,n,o,r,l,a,s,c,h,u)=>this._prepareLayersData(t,n,o,r,l,a,s,c,h,u)),this.accessors=new Yt(e),this.setAccessors(e)}setAccessors(e){this.accessors=new Yt(e)}getAggregateAccessors(){return this.accessors}prepareLayersData(e,t){const n=this.getLocationsForFlowmapLayer(e,t)||[],o=this.getFlowsForFlowmapLayer(e,t)||[],r=this.getFlowmapColorsRGBA(e,t),l=this.getLocationsForFlowmapLayerById(e,t),a=this.getLocationIdsInViewport(e,t),s=this.getInCircleSizeGetter(e,t),c=this.getOutCircleSizeGetter(e,t),h=this.getFlowThicknessScale(e,t),u=this.getLocationLabelsEnabled(e,t);return this._prepareLayersData(n,o,r,l,a,s,c,h,e.settings.animationEnabled,u)}_prepareLayersData(e,t,n,o,r,l,a,s,c,h){e||(e=[]),t||(t=[]);const{getFlowOriginId:u,getFlowDestId:d,getFlowMagnitude:f,getLocationId:g,getLocationLon:v,getLocationLat:w,getLocationName:m}=this.accessors,C=Nt(t,D=>f(D)),E=yo(n,C),y=Float32Array.from((function*(){for(const D of e)yield v(D),yield w(D)})()),b=si(n)?n.positive.locationCircles.inner:n.locationCircles.inner,F=Uint8Array.from((function*(){for(const D of e)yield*b})()),x=Float32Array.from((function*(){for(const D of e){const T=g(D);yield r?.has(T)?l(T):1}})()),p=Float32Array.from((function*(){for(const D of e){const T=g(D);yield r?.has(T)?a(T):1}})()),S=Float32Array.from((function*(){for(const D of t){const T=o?.get(u(D));yield T?v(T):0,yield T?w(T):0}})()),M=Float32Array.from((function*(){for(const D of t){const T=o?.get(d(D));yield T?v(T):0,yield T?w(T):0}})()),_=Float32Array.from((function*(){for(const D of t)yield s&&s(f(D))||0})()),I=Float32Array.from((function*(){for(const D of t){const T=u(D),X=d(D);yield Math.max(l(T),a(T)),yield Math.max(l(X),a(X))}})()),O=Uint8Array.from((function*(){for(const D of t)yield*E(f(D))})()),R=c?Float32Array.from((function*(){for(const D of t)yield new Jn.alea(`${u(D)}-${d(D)}`)()})()):void 0;return{circleAttributes:{length:e.length,attributes:{getPosition:{value:y,size:2},getColor:{value:F,size:4},getInRadius:{value:x,size:1},getOutRadius:{value:p,size:1}}},lineAttributes:{length:t.length,attributes:{getSourcePosition:{value:S,size:2},getTargetPosition:{value:M,size:2},getThickness:{value:_,size:1},getColor:{value:O,size:4},getEndpointOffsets:{value:I,size:2},...R?{getStaggering:{value:R,size:1}}:{}}},...h?{locationLabels:e.map(m)}:void 0}}getLocationsInBbox(e,t){if(e)return this._getLocationsInBboxIndices(e,t).map(n=>e.points[n])}_getLocationsInBboxIndices(e,t){if(!e)return;const[n,o,r,l]=t,[a,s,c,h]=[At(n),Ot(o),At(r),Ot(l)];return e.range(Math.min(a,c),Math.min(s,h),Math.max(a,c),Math.max(s,h))}isFlowInSelection(e,t,n){const o=this.accessors.getFlowOriginId(e),r=this.accessors.getFlowDestId(e);if(t)switch(n){case K.ALL:return t.has(o)||t.has(r);case K.BETWEEN:return t.has(o)&&t.has(r);case K.INCOMING:return t.has(r);case K.OUTGOING:return t.has(o)}return!0}}function Pe(i,e){if(!i)return;let t;for(const[n,{incomingCount:o,outgoingCount:r,internalCount:l}]of i.entries())if(e==null||e.has(n)){const a=Math.min(o+l,r+l,l),s=Math.max(o+l,r+l,l);t?(a<t[0]&&(t[0]=a),s>t[1]&&(t[1]=s)):t=[a,s]}return t}function At(i){return i/360+.5}function Ot(i){const e=Math.sin(i*Math.PI/180),t=.5-.25*Math.log((1+e)/(1-e))/Math.PI;return t<0?0:t>1?1:t}function is(i,e){const t=ei(i,o=>{const r=e.getFlowOriginId(o[0]),l=e.getFlowDestId(o[0]);return{aggregate:!0,origin:r,dest:l,count:o.reduce((s,c)=>{const h=e.getFlowMagnitude(c);return h&&!isNaN(h)&&isFinite(h)?s+h:s},0)}},e.getFlowOriginId,e.getFlowDestId),n=[];for(const o of t.values())for(const r of o.values())n.push(r);return n}function zt(i,e){const{getInRadius:t,getOutRadius:n}=i.attributes;return Math.max(t.value[e],n.value[e])}function Ae(i,e){const{getPosition:t}=i.attributes;return[t.value[e*2],t.value[e*2+1]]}function ns(i,e){const{getColor:t,getEndpointOffsets:n,getSourcePosition:o,getTargetPosition:r,getThickness:l,getStaggering:a}=i.attributes;return{length:1,attributes:{getColor:{value:t.value.subarray(e*4,(e+1)*4),size:4},getEndpointOffsets:{value:n.value.subarray(e*2,(e+1)*2),size:2},getSourcePosition:{value:o.value.subarray(e*2,(e+1)*2),size:2},getTargetPosition:{value:r.value.subarray(e*2,(e+1)*2),size:2},getThickness:{value:l.value.subarray(e,e+1),size:1},...a?{getStaggering:{value:a.value.subarray(e,e+1),size:1}}:void 0}}}var Zt=1e-6,lt=Math.PI,Oe=lt/2,hi=lt/4,ze=lt*2,Bt=180/lt,Q=lt/180,ue=Math.abs,di=Math.atan2,rt=Math.cos,at=Math.sin,os=Math.sqrt;function ss(i){return i>1?Oe:i<-1?-Oe:Math.asin(i)}function ut(){}function Lt(i,e){i&&ke.hasOwnProperty(i.type)&&ke[i.type](i,e)}var Be={Feature:function(i,e){Lt(i.geometry,e)},FeatureCollection:function(i,e){for(var t=i.features,n=-1,o=t.length;++n<o;)Lt(t[n].geometry,e)}},ke={Sphere:function(i,e){e.sphere()},Point:function(i,e){i=i.coordinates,e.point(i[0],i[1],i[2])},MultiPoint:function(i,e){for(var t=i.coordinates,n=-1,o=t.length;++n<o;)i=t[n],e.point(i[0],i[1],i[2])},LineString:function(i,e){qt(i.coordinates,e,0)},MultiLineString:function(i,e){for(var t=i.coordinates,n=-1,o=t.length;++n<o;)qt(t[n],e,0)},Polygon:function(i,e){Re(i.coordinates,e)},MultiPolygon:function(i,e){for(var t=i.coordinates,n=-1,o=t.length;++n<o;)Re(t[n],e)},GeometryCollection:function(i,e){for(var t=i.geometries,n=-1,o=t.length;++n<o;)Lt(t[n],e)}};function qt(i,e,t){var n=-1,o=i.length-t,r;for(e.lineStart();++n<o;)r=i[n],e.point(r[0],r[1],r[2]);e.lineEnd()}function Re(i,e){var t=-1,n=i.length;for(e.polygonStart();++t<n;)qt(i[t],e,1);e.polygonEnd()}function rs(i,e){i&&Be.hasOwnProperty(i.type)?Be[i.type](i,e):Lt(i,e)}var Ct=new xt,$e=new xt,fi,gi,Xt,Vt,Kt,j={point:ut,lineStart:ut,lineEnd:ut,polygonStart:function(){Ct=new xt,j.lineStart=as,j.lineEnd=ls},polygonEnd:function(){var i=+Ct;$e.add(i<0?ze+i:i),this.lineStart=this.lineEnd=this.point=ut},sphere:function(){$e.add(ze)}};function as(){j.point=cs}function ls(){pi(fi,gi)}function cs(i,e){j.point=pi,fi=i,gi=e,i*=Q,e*=Q,Xt=i,Vt=rt(e=e/2+hi),Kt=at(e)}function pi(i,e){i*=Q,e*=Q,e=e/2+hi;var t=i-Xt,n=t>=0?1:-1,o=n*t,r=rt(e),l=at(e),a=Kt*l,s=Vt*r+a*rt(o),c=a*n*at(o);Ct.add(di(c,s)),Xt=i,Vt=r,Kt=l}function us(i){return[di(i[1],i[0]),ss(i[2])]}function hs(i){var e=i[0],t=i[1],n=rt(t);return[n*rt(e),n*at(e),at(t)]}function He(i,e){return[i[1]*e[2]-i[2]*e[1],i[2]*e[0]-i[0]*e[2],i[0]*e[1]-i[1]*e[0]]}function ds(i){var e=os(i[0]*i[0]+i[1]*i[1]+i[2]*i[2]);i[0]/=e,i[1]/=e,i[2]/=e}var P,k,A,H,q,mi,vi,J,st,Z,W,U={point:Jt,lineStart:Ne,lineEnd:Ge,polygonStart:function(){U.point=wi,U.lineStart=fs,U.lineEnd=gs,st=new xt,j.polygonStart()},polygonEnd:function(){j.polygonEnd(),U.point=Jt,U.lineStart=Ne,U.lineEnd=Ge,Ct<0?(P=-(A=180),k=-(H=90)):st>Zt?H=90:st<-Zt&&(k=-90),W[0]=P,W[1]=A},sphere:function(){P=-(A=180),k=-(H=90)}};function Jt(i,e){Z.push(W=[P=i,A=i]),e<k&&(k=e),e>H&&(H=e)}function yi(i,e){var t=hs([i*Q,e*Q]);if(J){var n=He(J,t),o=[n[1],-n[0],0],r=He(o,n);ds(r),r=us(r);var l=i-q,a=l>0?1:-1,s=r[0]*Bt*a,c,h=ue(l)>180;h^(a*q<s&&s<a*i)?(c=r[1]*Bt,c>H&&(H=c)):(s=(s+360)%360-180,h^(a*q<s&&s<a*i)?(c=-r[1]*Bt,c<k&&(k=c)):(e<k&&(k=e),e>H&&(H=e))),h?i<q?$(P,i)>$(P,A)&&(A=i):$(i,A)>$(P,A)&&(P=i):A>=P?(i<P&&(P=i),i>A&&(A=i)):i>q?$(P,i)>$(P,A)&&(A=i):$(i,A)>$(P,A)&&(P=i)}else Z.push(W=[P=i,A=i]);e<k&&(k=e),e>H&&(H=e),J=t,q=i}function Ne(){U.point=yi}function Ge(){W[0]=P,W[1]=A,U.point=Jt,J=null}function wi(i,e){if(J){var t=i-q;st.add(ue(t)>180?t+(t>0?360:-360):t)}else mi=i,vi=e;j.point(i,e),yi(i,e)}function fs(){j.lineStart()}function gs(){wi(mi,vi),j.lineEnd(),ue(st)>Zt&&(P=-(A=180)),W[0]=P,W[1]=A,J=null}function $(i,e){return(e-=i)<0?e+360:e}function ps(i,e){return i[0]-e[0]}function Ue(i,e){return i[0]<=i[1]?i[0]<=e&&e<=i[1]:e<i[0]||i[1]<e}function ms(i){var e,t,n,o,r,l,a;if(H=A=-(P=k=1/0),Z=[],rs(i,U),t=Z.length){for(Z.sort(ps),e=1,n=Z[0],r=[n];e<t;++e)o=Z[e],Ue(n,o[0])||Ue(n,o[1])?($(n[0],o[1])>$(n[0],n[1])&&(n[1]=o[1]),$(o[0],n[1])>$(n[0],n[1])&&(n[0]=o[0])):r.push(n=o);for(l=-1/0,t=r.length-1,e=0,n=r[t];e<=t;n=o,++e)o=r[e],(a=$(n[1],o[0]))>l&&(l=a,P=o[0],A=n[1])}return Z=W=null,P===1/0||k===1/0?[[NaN,NaN],[NaN,NaN]]:[[P,k],[A,H]]}function vs(i,e,t){const{pad:n=.05,maxZoom:o=100}=t||{},r=ms(i),[[l,a],[s,c]]=r,h=n?[[l-n*(s-l),a-n*(c-a)],[s+n*(s-l),c+n*(c-a)]]:r,[u,d]=e;return{...ii({width:u,height:d,bounds:h,padding:t?.padding,maxZoom:o}),width:u,height:d,bearing:0,pitch:0}}function ys(i,e,t,n){const o=l=>({type:"Point",coordinates:e(l)});let r;if(Array.isArray(i))r=i.map(o);else{r=[];for(const l of i)r.push(o(l))}return vs({type:"GeometryCollection",geometries:r},t,n)}function ws(i){return i&&i.locations&&i.flows}function bs(i){return i&&typeof i.setFlowmapState=="function"&&typeof i.getViewportForLocations=="function"&&typeof i.getFlowByIndex=="function"&&typeof i.getLocationById=="function"&&typeof i.getLocationByIndex=="function"&&typeof i.getLayersData=="function"}class Ls{constructor(e){this.selectors=new es(e),this.flowmapData=void 0,this.flowmapState=void 0}setAccessors(e){this.selectors.setAccessors(e)}setFlowmapData(e){this.flowmapData=e}getSelectors(){return this.selectors}getFlowmapData(){return this.flowmapData}async setFlowmapState(e){this.flowmapState=e}getFlowmapState(){return this.flowmapState}async getFlowByIndex(e){return!this.flowmapState||!this.flowmapData?void 0:this.selectors.getFlowsForFlowmapLayer(this.flowmapState,this.flowmapData)?.[e]}async getLocationByIndex(e){return!this.flowmapState||!this.flowmapData?void 0:this.selectors.getLocationsForFlowmapLayer(this.flowmapState,this.flowmapData)?.[e]}async getLayersData(){if(!(!this.flowmapState||!this.flowmapData))return this.selectors.getLayersData(this.flowmapState,this.flowmapData)}async getLocationById(e){if(!this.flowmapState||!this.flowmapData)return;const t=this.selectors.getClusterIndex(this.flowmapState,this.flowmapData);if(t){const o=t.getClusterById(e);if(o)return o}return this.selectors.getLocationsById(this.flowmapState,this.flowmapData)?.get(e)}async getTotalsForLocation(e){if(!(!this.flowmapState||!this.flowmapData))return this.selectors.getLocationTotals(this.flowmapState,this.flowmapData)?.get(e)}async getViewportForLocations(e,t){if(this.flowmapData?.locations)return ys(this.flowmapData.locations,n=>[this.selectors.accessors.getLocationLon(n),this.selectors.accessors.getLocationLat(n)],e,t)}async updateLayersData(e){e(await this.getLayersData())}getClusterZoom(){return this.flowmapState&&this.flowmapData?this.selectors.getClusterZoom(this.flowmapState,this.flowmapData):void 0}getClusterIndex(){return this.flowmapState&&this.flowmapData?this.selectors.getClusterIndex(this.flowmapState,this.flowmapData):void 0}getLocationsById(){return this.flowmapState&&this.flowmapData?this.selectors.getLocationsById(this.flowmapState,this.flowmapData):void 0}getLocationTotals(){return this.flowmapState&&this.flowmapData?this.selectors.getLocationTotals(this.flowmapState,this.flowmapData):void 0}getFlowsForFlowmapLayer(){return this.flowmapState&&this.flowmapData?this.selectors.getFlowsForFlowmapLayer(this.flowmapState,this.flowmapData):void 0}}const Cs=`#version 300 es
/*
 * Copyright (c) Flowmap.gl contributors
 * Copyright (c) 2018-2020 Teralytics
 * SPDX-License-Identifier: Apache-2.0
 */

#define SHADER_NAME animated-flow-lines-layer-fragment-shader

precision highp float;

in vec4 vColor;
in float sourceToTarget;
in vec2 uv;

out vec4 fragColor;

void main(void) {
  geometry.uv = uv;

  fragColor = vec4(vColor.xyz, vColor.w * smoothstep(1.0 - uni.animationTailLength, 1.0, fract(sourceToTarget)));

  DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,xs=`#version 300 es
/*
 * Copyright (c) Flowmap.gl contributors
 * Copyright (c) 2018-2020 Teralytics
 * SPDX-License-Identifier: Apache-2.0
 */
#define SHADER_NAME animated-flow-lines-layer-vertex-shader
#define SPEED 0.015
#define NUM_PARTS 5.0

in vec3 positions;
in vec3 instanceSourcePositions;
in vec3 instanceTargetPositions;
in vec3 instanceSourcePositions64Low;
in vec3 instanceTargetPositions64Low;
in vec4 instanceColors;
in vec3 instancePickingColors;
in float instanceWidths;
in float instancePickable;
in float instanceStaggering;

out vec4 vColor;
out float sourceToTarget;
out vec2 uv;

// offset vector by strokeWidth pixels
// offset_direction is -1 (left) or 1 (right)
vec2 getExtrusionOffset(vec2 line_clipspace, float offset_direction, float width) {
  // normalized direction of the line
  vec2 dir_screenspace = normalize(line_clipspace * project.viewportSize);
  // rotate by 90 degrees
  dir_screenspace = vec2(-dir_screenspace.y, dir_screenspace.x);

  return dir_screenspace * offset_direction * width / 2.0;
}

void main(void) {
  geometry.worldPosition = instanceSourcePositions;
  geometry.worldPositionAlt = instanceTargetPositions;

  // Position
  vec4 source_commonspace;
  vec4 target_commonspace;
  vec4 source = project_position_to_clipspace(instanceSourcePositions, instanceSourcePositions64Low, vec3(0.), source_commonspace);
  vec4 target = project_position_to_clipspace(instanceTargetPositions, instanceTargetPositions64Low, vec3(0.), target_commonspace);

  float widthPixels = instanceWidths * uni.thicknessUnit;

  // linear interpolation of source & target to pick right coord
  float segmentIndex = positions.x;
  vec4 p = mix(source, target, segmentIndex);
  geometry.position = mix(source_commonspace, target_commonspace, segmentIndex);
  uv = positions.xy;
  geometry.uv = uv;
  if (instancePickable > 0.5) {
    geometry.pickingColor = instancePickingColors;
  }

  // extrude
  vec3 offset = vec3(
    getExtrusionOffset(target.xy - source.xy, positions.y, widthPixels * 2.),
    0.0);
  DECKGL_FILTER_SIZE(offset, geometry);
  gl_Position = p + vec4(project_pixel_size_to_clipspace(offset.xy), 0.0, 0.0);
  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);

  // Color
  vColor = vec4(instanceColors.rgb, instanceColors.a * uni.opacity) / 255.;
  DECKGL_FILTER_COLOR(vColor, geometry);

  sourceToTarget = positions.x * length(source - target) * NUM_PARTS - uni.currentTime * SPEED + instanceStaggering;
}
`,Ss=[0,132,193,255],bi=1800,Fs=20,je=bi/Fs,We=`uniform uniUniforms {
  float opacity;
  float currentTime;
  float thicknessUnit;
  float animationTailLength;
} uni;
`,Ds={name:"uni",vs:We,fs:We,uniformTypes:{opacity:"f32",currentTime:"f32",thicknessUnit:"f32",animationTailLength:"f32"}};class kt extends ne{static defaultProps={currentTime:0,animationTailLength:.7,getSourcePosition:{type:"accessor",value:e=>[0,0]},getTargetPosition:{type:"accessor",value:e=>[0,0]},getPickable:{type:"accessor",value:e=>1},getStaggering:{type:"accessor",value:(e,{index:t})=>Math.random()},getColor:{type:"accessor",value:Ss},getThickness:{type:"accessor",value:1},thicknessUnit:30,parameters:{depthTest:!1}};constructor(e){super(e)}getShaders(){return super.getShaders({vs:xs,fs:Cs,modules:[oe,se,Ds],shaderCache:this.context.shaderCache})}initializeState(){this.getAttributeManager()?.addInstanced({instanceSourcePositions:{size:3,type:"float64",transition:!0,accessor:"getSourcePosition"},instanceTargetPositions:{size:3,type:"float64",transition:!0,accessor:"getTargetPosition"},instanceColors:{size:4,type:"uint8",transition:!0,accessor:"getColor",defaultValue:[0,0,0,255]},instanceWidths:{size:1,transition:!0,accessor:"getThickness",defaultValue:1},instanceStaggering:{accessor:"getStaggering",size:1,transition:!1},instancePickable:{accessor:"getPickable",size:1,transition:!1}})}getNeedsRedraw(){return!0}updateState({props:e,oldProps:t,changeFlags:n}){super.updateState({props:e,oldProps:t,changeFlags:n}),n.extensionsChanged&&(this.state.model?.delete(),this.state.model=this._getModel(),this.getAttributeManager()?.invalidateAll())}draw(){const{thicknessUnit:e,animationTailLength:t,currentTime:n,opacity:o}=this.props,l=Date.now()/1e3%je/je*bi,a={opacity:o,thicknessUnit:e,animationTailLength:t,currentTime:l},s=this.state.model;s?.shaderInputs.setProps({uni:a}),s?.draw(this.context.renderPass)}_getModel(){const e=[0,-1,0,0,1,0,1,-1,0,1,1,0];return new re(this.context.device,{...this.getShaders(),id:this.props.id,geometry:new ae({topology:"triangle-list",attributes:{positions:{size:3,value:new Float32Array(e)}}}),isInstanced:!0})}}const _s=`#version 300 es
/*
 * Copyright (c) Flowmap.gl contributors
 * Copyright (c) 2018-2020 Teralytics
 * SPDX-License-Identifier: Apache-2.0
 */
#define SHADER_NAME flow-circles-layer-vertex-shader
#define radiusScale 100

in vec3 positions;

in vec3 instancePositions;
in vec3 instancePositions64Low;
in float instanceInRadius;
in float instanceOutRadius;
in vec4 instanceColors;
in vec3 instancePickingColors;

out vec4 vColor;
out vec2 unitPosition;
out float unitInRadius;
out float unitOutRadius;

void main(void) {
  geometry.worldPosition = instancePositions;

  float outerRadiusPixels = max(instanceInRadius, instanceOutRadius);
  unitInRadius = instanceInRadius / outerRadiusPixels;
  unitOutRadius = instanceOutRadius / outerRadiusPixels;

  // position on the containing square in [-1, 1] space
  unitPosition = positions.xy;
  geometry.uv = unitPosition;
  geometry.pickingColor = instancePickingColors;

  // Find the center of the point and add the current vertex
  vec3 offset = positions * project_pixel_size(outerRadiusPixels);
  DECKGL_FILTER_SIZE(offset, geometry);
  gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset, geometry.position);
  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);

  // Apply opacity to instance color, or return instance picking color
  vColor = vec4(instanceColors.rgb / 255., instanceColors.a / 255. * uni.opacity);

  DECKGL_FILTER_COLOR(vColor, geometry);
}
`,Ms=`#version 300 es
/*
 * Copyright (c) Flowmap.gl contributors
 * Copyright (c) 2018-2020 Teralytics
 * SPDX-License-Identifier: Apache-2.0
 */
#define SHADER_NAME flow-circles-layer-fragment-shader
#define SOFT_OUTLINE 0.05

precision highp float;

in vec4 vColor;
in vec2 unitPosition;
in float unitInRadius;
in float unitOutRadius;

out vec4 fragColor;

void main(void) {
  geometry.uv = unitPosition;
  float distToCenter = length(unitPosition);

  // Discard fragments outside the circle
  if (distToCenter > 1.0) {
    discard;
  }

  vec4 finalColor = vColor;
  float alpha = vColor.a;

  // // Determine if this is a filled circle or a ring
  // bool isRing = unitInRadius < unitOutRadius;
  // float innerRadius = min(unitInRadius, unitOutRadius);
  // float outerRadius = max(unitInRadius, unitOutRadius);


  // if (isRing) {
  //   // Ring mode: hollow in the center
  //   if (distToCenter < innerRadius - SOFT_OUTLINE) {
  //     // Inside the inner circle - use empty color
  //     finalColor = vec4(uni.emptyColor.rgb / 255.0, 0.0);
  //     alpha = 0.0;
  //   } else if (distToCenter < innerRadius) {
  //     // Soft transition at inner edge
  //     float t = smoothstep(innerRadius - SOFT_OUTLINE, innerRadius, distToCenter);
  //     finalColor = mix(vec4(0., 0., 0., 0.0), vColor, t);
  //     alpha = vColor.a * t;
  //   } else if (distToCenter <= outerRadius) {
  //     // In the ring area
  //     finalColor = vColor;
  //     alpha = vColor.a;
  //   } else {
  //     // Outside the outer radius
  //     alpha = 0.0;
  //   }
  // } else {
  //   // Filled circle mode
  //   finalColor = vColor;
  //   alpha = vColor.a;
  // }

  // Apply soft edge anti-aliasing at the outer boundary
  if (distToCenter > 1.0 - SOFT_OUTLINE) {
    alpha *= smoothstep(1.0, 1.0 - SOFT_OUTLINE, distToCenter);
  }

  fragColor = vec4(finalColor.rgb, alpha);
  DECKGL_FILTER_COLOR(fragColor, geometry);
}`,Ye=`uniform uniUniforms {
  float opacity;
  vec4 emptyColor;
  float outlineEmptyMix;
} uni;
`,Ts={name:"uni",vs:Ye,fs:Ye,uniformTypes:{opacity:"f32",emptyColor:"vec4<f32>",outlineEmptyMix:"f32"}},Ze=[0,0,0,255],Es=[255,255,255,255],Is=.4;class Rt extends ne{static layerName="FlowCirclesLayer";static defaultProps={getColor:{type:"accessor",value:Ze},emptyColor:{type:"accessor",value:Es},outlineEmptyMix:{type:"accessor",value:Is},getPosition:{type:"accessor",value:e=>e.position},getInRadius:{type:"accessor",value:1},getOutRadius:{type:"accessor",value:1},parameters:{depthTest:!1}};constructor(e){super(e)}getShaders(){return super.getShaders({vs:_s,fs:Ms,modules:[oe,se,Ts],shaderCache:this.context.shaderCache})}initializeState(){this.getAttributeManager()?.addInstanced({instancePositions:{size:3,type:"float64",fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceInRadius:{size:1,transition:!0,accessor:"getInRadius",defaultValue:1},instanceOutRadius:{size:1,transition:!0,accessor:"getOutRadius",defaultValue:1},instanceColors:{size:4,transition:!0,type:"uint8",accessor:"getColor",defaultValue:Ze}})}updateState({props:e,oldProps:t,changeFlags:n}){super.updateState({props:e,oldProps:t,changeFlags:n}),n.extensionsChanged&&(this.state.model&&this.state.model.delete(),this.setState({model:this._getModel()}),this.getAttributeManager()?.invalidateAll())}draw(){const{opacity:e,emptyColor:t,outlineEmptyMix:n}=this.props,o={opacity:e,emptyColor:t,outlineEmptyMix:n},r=this.state.model;r?.shaderInputs.setProps({uni:o}),r?.draw(this.context.renderPass)}_getModel(){const e=[-1,-1,1,-1,-1,1,1,1];return new re(this.context.device,{...this.getShaders(),id:this.props.id,geometry:new ae({topology:"triangle-strip",attributes:{positions:{size:2,value:new Float32Array(e)}}}),isInstanced:!0})}}const Ps=`#version 300 es
/*
 * Copyright (c) Flowmap.gl contributors
 * Copyright (c) 2018-2020 Teralytics
 * SPDX-License-Identifier: Apache-2.0
 */
#define SHADER_NAME flow-line-layer-fragment-shader

precision highp float;

in vec4 vColor;
in vec2 uv;

out vec4 fragColor;

void main(void) {
  if (vColor.a == 0.0) {
    discard;
  }

  geometry.uv = uv;
  fragColor = vColor;
  DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,As=`#version 300 es
/*
 * Copyright (c) Flowmap.gl contributors
 * Copyright (c) 2018-2020 Teralytics
 * SPDX-License-Identifier: Apache-2.0
 */
#define SHADER_NAME flow-line-layer-vertex-shader

in vec3 positions;
in vec3 normals;
in vec4 instanceColors;
in float instanceThickness;    // 0..0.5
in vec3 instanceSourcePositions;
in vec3 instanceTargetPositions;
in vec3 instanceSourcePositions64Low;
in vec3 instanceTargetPositions64Low;
in vec3 instancePickingColors;
in vec2 instanceEndpointOffsets;
in float instancePickable;

// uniform vec4 outlineColor;
// uniform float thicknessUnit;
// uniform float gap;
// uniform float opacity;

out vec4 vColor;
out vec2 uv;

void main(void) {
  geometry.worldPosition = instanceSourcePositions;
  geometry.worldPositionAlt = instanceTargetPositions;

  // Position
  vec4 source_commonspace;
  vec4 target_commonspace;
  vec4 source = project_position_to_clipspace(instanceSourcePositions, instanceSourcePositions64Low, vec3(0.), source_commonspace);
  vec4 target = project_position_to_clipspace(instanceTargetPositions, instanceTargetPositions64Low, vec3(0.), target_commonspace);

  // linear interpolation of source & target to pick right coord
  float sourceOrTarget = positions.x;
  geometry.position = mix(source_commonspace, target_commonspace, sourceOrTarget);
  uv = positions.xy;
  geometry.uv = uv;
  if (instancePickable > 0.5) {
    geometry.pickingColor = instancePickingColors;
  }

  // set the clamp limits in pixel size
  float lengthCommon = length(target_commonspace - source_commonspace);
  vec2 offsetDistances = project_pixel_size(positions.yz) * uni.thicknessUnit;

  vec2 limitedOffsetDistances = clamp(
    project_pixel_size(positions.yz) * uni.thicknessUnit,
    -lengthCommon*.8, lengthCommon*.8
  );
  float startOffsetCommon = project_pixel_size(instanceEndpointOffsets[0]);
  float endOffsetCommon = project_pixel_size(instanceEndpointOffsets[1]);
  float endpointOffset = mix(
    clamp(startOffsetCommon, 0.0, lengthCommon*.2),
    -clamp(endOffsetCommon, 0.0, lengthCommon*.2),
    positions.x
  );

  vec2 flowlineDir = normalize(target_commonspace.xy - source_commonspace.xy);
  vec2 perpendicularDir = vec2(-flowlineDir.y, flowlineDir.x);
  vec2 normalsCommon = project_pixel_size(normals.xy);
  float gapCommon = project_pixel_size(uni.gap);
  vec3 offsetCommon = vec3(
    flowlineDir * (instanceThickness * limitedOffsetDistances[1] + normalsCommon.y + endpointOffset * 1.05) -
    perpendicularDir * (instanceThickness * limitedOffsetDistances[0] + gapCommon + normalsCommon.x),
    0.0
  );

  DECKGL_FILTER_SIZE(offsetCommon, geometry);
  vec4 position_commonspace = mix(source_commonspace, target_commonspace, sourceOrTarget);
  vec4 offset_commonspace = vec4(offsetCommon, 0.0);
  gl_Position = project_common_position_to_clipspace(position_commonspace + offset_commonspace);

  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);

  vec4 fillColor = vec4(instanceColors.rgb, instanceColors.a * uni.opacity) / 255.;
  vColor = mix(fillColor, vec4(uni.outlineColor.xyz, uni.outlineColor.w * fillColor.w), normals.z);
  DECKGL_FILTER_COLOR(vColor, geometry);
}
`,Os=[0,132,193,255],qe=`uniform uniUniforms {
  vec4 outlineColor;
  float thicknessUnit;
  float gap;
  float opacity;
} uni;
`,zs={name:"uni",vs:qe,fs:qe,uniformTypes:{outlineColor:"vec4<f32>",thicknessUnit:"f32",gap:"f32",opacity:"f32"}},Xe=[1,0,0,1,2,-3,1,1,-3,1,0,0,1,1,-3,0,1,0,1,0,0,0,1,0,0,0,0];function Bs(i,e){return[-1,2*i,1,2*i,-i,1,i,-i,1,-1,2*i,1,i,-i,1,i,-i,1,-1,2*i,1,i,-i,1,-1,-i,1]}const ks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];class ht extends ne{static layerName="FlowLinesLayer";static defaultProps={getSourcePosition:{type:"accessor",value:e=>[0,0]},getTargetPosition:{type:"accessor",value:e=>[0,0]},getColor:{type:"accessor",value:Os},getThickness:{type:"accessor",value:e=>e.count},getPickable:{type:"accessor",value:e=>1},drawOutline:!0,thicknessUnit:12,outlineThickness:1,outlineColor:[255,255,255,255],parameters:{depthTest:!1}};constructor(e){super(e)}getShaders(){return super.getShaders({vs:As,fs:Ps,modules:[oe,se,zs],shaderCache:this.context.shaderCache})}initializeState(){this.getAttributeManager()?.addInstanced({instanceSourcePositions:{accessor:"getSourcePosition",size:3,transition:!1,type:"float64"},instanceTargetPositions:{accessor:"getTargetPosition",size:3,transition:!1,type:"float64"},instanceThickness:{accessor:"getThickness",size:1,transition:!1},instanceEndpointOffsets:{accessor:"getEndpointOffsets",size:2,transition:!1},instanceColors:{accessor:"getColor",size:4,type:"uint8",transition:!1},instancePickable:{accessor:"getPickable",size:1,transition:!1}})}updateState({props:e,oldProps:t,changeFlags:n}){super.updateState({props:e,oldProps:t,changeFlags:n}),n.extensionsChanged&&(this.state.model&&this.state.model.delete(),this.setState({model:this._getModel()}),this.getAttributeManager()?.invalidateAll())}draw(){const{outlineColor:e,thicknessUnit:t,gap:n,opacity:o}=this.props,r={outlineColor:e.map(a=>a/255),thicknessUnit:t*2,gap:n,opacity:o},l=this.state.model;l?.shaderInputs.setProps({uni:r}),l?.draw(this.context.renderPass)}_getModel(){let e=[],t=[];const{drawOutline:n,outlineThickness:o}=this.props;if(n){e=e.concat(Xe);const r=o;t=t.concat(Bs(r))}return e=e.concat(Xe),t=t.concat(ks),new re(this.context.device,{...this.getShaders(),id:this.props.id,geometry:new ae({topology:"triangle-list",attributes:{positions:{size:3,value:new Float32Array(e)},normals:{size:3,value:new Float32Array(t)}}}),isInstanced:!0})}}var Qt=(i=>(i.LOCATION="location",i.FLOW="flow",i))(Qt||{});const Rs=["filter","locationsEnabled","locationTotalsEnabled","locationLabelsEnabled","adaptiveScalesEnabled","animationEnabled","clusteringEnabled","clusteringLevel","fadeEnabled","fadeOpacityEnabled","clusteringAuto","darkMode","fadeAmount","colorScheme","highlightColor","maxTopFlowsDisplayNum"];class $s extends En{static defaultProps={darkMode:!0,fadeAmount:50,locationsEnabled:!0,locationTotalsEnabled:!0,locationLabelsEnabled:!1,animationEnabled:!1,clusteringEnabled:!0,fadeEnabled:!0,fadeOpacityEnabled:!1,clusteringAuto:!0,clusteringLevel:void 0,adaptiveScalesEnabled:!0,colorScheme:"Teal",highlightColor:"orange",maxTopFlowsDisplayNum:5e3};state;constructor(e){super({...e,onHover:(t,n)=>{const o=Date.now();this.setState({highlightedObject:this._getHighlightedObject(t),lastHoverTime:o});const{onHover:r}=e;r&&this._getFlowmapLayerPickingInfo(t).then(l=>{(this.state?.lastHoverTime??0)<=o&&(this.setState({pickingInfo:l}),r(l,n))})},onClick:(t,n)=>{const{onClick:o}=e,r=Date.now();this.setState({lastClickTime:r}),o&&this._getFlowmapLayerPickingInfo(t).then(l=>{(this.state?.lastClickTime??0)<=r&&(this.setState({pickingInfo:l}),l&&o(l,n))})}})}initializeState(){this.state={accessors:new Yt(this.props),dataProvider:this._getOrMakeDataProvider(),layersData:void 0,highlightedObject:void 0,pickingInfo:void 0,lastHoverTime:void 0,lastClickTime:void 0}}getPickingInfo({info:e}){if(!e.object){const t=this.state?.pickingInfo?.object;if(t)return{...e,object:t,picked:!0}}return e}_getOrMakeDataProvider(){const{data:e,dataProvider:t}=this.props;if(bs(t))return t;if(ws(e)){const n=new Ls(this.props);return n.setFlowmapData(e),n}throw new Error("FlowmapLayer: data must be a FlowmapDataProvider or FlowmapData")}_updateDataProvider(){this.setState({dataProvider:this._getOrMakeDataProvider()})}shouldUpdateState(e){const{changeFlags:t}=e;return t.viewportChanged?!0:super.shouldUpdateState(e)}updateState({oldProps:e,props:t,changeFlags:n}){if(n.propsChanged,n.dataChanged&&this._updateDataProvider(),(n.viewportChanged||n.dataChanged)&&this.setState({highlightedObject:void 0}),n.viewportChanged||n.dataChanged||n.propsChanged&&Rs.some(o=>e[o]!==t[o])){const{dataProvider:o}=this.state||{};o&&(o.setFlowmapState(this._getFlowmapState()),o.updateLayersData(r=>{this.setState({layersData:r,highlightedObject:void 0})},n))}}_getSettingsState(){const{locationsEnabled:e,locationTotalsEnabled:t,locationLabelsEnabled:n,adaptiveScalesEnabled:o,animationEnabled:r,clusteringEnabled:l,clusteringLevel:a,fadeEnabled:s,fadeOpacityEnabled:c,clusteringAuto:h,darkMode:u,fadeAmount:d,colorScheme:f,highlightColor:g,maxTopFlowsDisplayNum:v}=this.props;return{locationsEnabled:e,locationTotalsEnabled:t,locationLabelsEnabled:n,adaptiveScalesEnabled:o,animationEnabled:r,clusteringEnabled:l,clusteringLevel:a,fadeEnabled:s,fadeOpacityEnabled:c,clusteringAuto:h,darkMode:u,fadeAmount:d,colorScheme:f,highlightColor:g,maxTopFlowsDisplayNum:v}}_getFlowmapState(){return{viewport:Hs(this.context.viewport),filter:this.props.filter,settings:this._getSettingsState()}}async _getFlowmapLayerPickingInfo(e){const{index:t,sourceLayer:n}=e,{dataProvider:o,accessors:r}=this.state||{};if(!o||!r)return;const l={...e,picked:e.picked,layer:e.layer,index:e.index,x:e.x,y:e.y,coordinate:e.coordinate,event:e.event};if(n instanceof ht||n instanceof kt){const a=t===-1?void 0:await o.getFlowByIndex(t);if(a){const s=await o.getLocationById(r.getFlowOriginId(a)),c=await o.getLocationById(r.getFlowDestId(a));if(s&&c)return{...l,object:{type:Qt.FLOW,flow:a,origin:s,dest:c,count:r.getFlowMagnitude(a)}}}}else if(n instanceof Rt){const a=t===-1?void 0:await o.getLocationByIndex(t);if(a){const s=r.getLocationId(a),c=r.getLocationName(a),h=await o.getTotalsForLocation(s),{circleAttributes:u}=this.state?.layersData||{};if(h&&u){const d=zt(u,e.index);return{...l,object:{type:Qt.LOCATION,location:a,id:s,name:c,totals:h,circleRadius:d}}}}}}_getHighlightedObject(e){const{index:t,sourceLayer:n}=e;if(!(t<0)){if(n instanceof ht||n instanceof kt){const{lineAttributes:o}=this.state?.layersData||{};if(o){let r=ns(o,t);return this.props.fadeOpacityEnabled&&(r={...r,attributes:{...r.attributes,getColor:{...r.attributes.getColor,value:new Uint8Array([...r.attributes.getColor.value.slice(0,3),255])}}}),{type:"flow",lineAttributes:r}}}else if(n instanceof Rt){const{circleAttributes:o}=this.state?.layersData||{};if(o)return{type:"location",coords:Ae(o,t),radius:zt(o,t)}}}}renderLayers(){const e=[];if(this.state?.layersData){const{layersData:t,highlightedObject:n}=this.state,{circleAttributes:o,lineAttributes:r,locationLabels:l}=t||{};if(o&&r){const a=mo(this._getSettingsState()),s=G(a.outlineColor||(this.props.darkMode?"#000":"#fff")),c={data:r,parameters:{...this.props.parameters,depthTest:!1}};if(this.props.animationEnabled?e.push(new kt({...this.getSubLayerProps({...c,id:"animated-flow-lines",drawOutline:!1,thicknessUnit:20})})):e.push(new ht({...this.getSubLayerProps({...c,id:"flow-lines",drawOutline:!0,outlineColor:s})})),e.push(new Rt(this.getSubLayerProps({id:"circles",data:o,emptyColor:this.props.darkMode?[0,0,0,255]:[255,255,255,255],outlineEmptyMix:.4}))),n)switch(n.type){case"location":e.push(new In({...this.getSubLayerProps({id:"location-highlight",data:[n],pickable:!1,antialiasing:!0,stroked:!0,filled:!1,lineWidthUnits:"pixels",getLineWidth:2,radiusUnits:"pixels",getRadius:h=>h.radius,getLineColor:G(this.props.highlightColor),getPosition:h=>h.coords})}));break;case"flow":e.push(new ht({...this.getSubLayerProps({id:"flow-highlight",data:n.lineAttributes,drawOutline:!0,pickable:!1,outlineColor:G(this.props.highlightColor),outlineThickness:1,parameters:{depthTest:!1}})}));break}}l&&e.push(new Pn(this.getSubLayerProps({id:"location-labels",data:l,maxWidth:1e3,pickable:!1,fontFamily:"Helvetica",getPixelOffset:(a,{index:s})=>[0,zt(o,s)+5],getPosition:(a,{index:s})=>Ae(o,s),getText:a=>a,getSize:10,getColor:[255,255,255,255],getAngle:0,getTextAnchor:"middle",getAlignmentBaseline:"top"})))}return e}}function Hs(i){const{width:e,height:t,longitude:n,latitude:o,zoom:r,pitch:l,bearing:a}=i;return{width:e,height:t,longitude:n,latitude:o,zoom:r,pitch:l,bearing:a}}const Ve="/simwrapper/",Ns=te({name:"FlowmapDeckComponent",props:{viewId:{type:Number,required:!0},dark:{type:Boolean,required:!0},vizDetails:{type:Object,required:!0},mapIsIndependent:{type:Boolean,required:!0},locations:{type:Array,required:!0},flows:{type:Array,required:!0},elapsed:{type:Number,required:!0},bgLayers:{type:Object},show3dBuildings:{type:Boolean,required:!1,default:!1}},data(){return{mymap:null,deckOverlay:null,globalState:$t.state,debounceTooltip:null,tooltipHTML:"",tooltipStyle:{position:"absolute",top:0,left:0,pointerEvents:"none",padding:"0.25rem","z-index":0}}},watch:{layers(){this.deckOverlay?.setProps({layers:this.layers})},dark(){const i=`${Ve}map-styles/${this.globalState.isDarkMode?"dark":"positron"}.json`;this.mymap?.setStyle(i)},show3dBuildings(){this.mymap&&(this.show3dBuildings?ve(this.mymap):An(this.mymap))},"globalState.viewState"(){if(this.mapIsIndependent)return;const i=this.globalState.viewState,e=this.mymap?.getCenter();(i.longitude!==e.lng||i.latitude!==e.lat||i.zoom!==this.mymap?.getZoom()||i.pitch!==this.mymap?.getPitch()||i.bearing!==this.mymap?.getBearing())&&this.mymap?.jumpTo(i)}},computed:{layers(){const i=[],e=this.bgLayers?.layers();return e&&i.push(...e.layersBelow),i.push(new $s({data:{locations:this.locations,flows:this.flows},id:"my-flowmap-"+this.viewId,getLocationId:t=>t.id,getLocationName:t=>t.id,getLocationLon:t=>t.lon,getLocationLat:t=>t.lat,getFlowOriginId:t=>t.o,getFlowDestId:t=>t.d,getFlowMagnitude:t=>t.v||null,adaptiveScalesEnabled:!0,colorScheme:this.vizDetails.colorScheme,animationEnabled:this.vizDetails.animationEnabled,clusteringEnabled:this.vizDetails.clustering,clusteringAuto:this.vizDetails.clustering,clusteringLevel:this.vizDetails.clusteringLevel,darkMode:this.dark,drawOutline:!1,fadeEnabled:!0,opacity:1,parameters:{depthTest:!0},pickable:!0,onHover:this.getTooltip})),e&&i.push(...e.layersOnTop),i}},mounted(){this.debounceTooltip=Di.debounce(this.clearTooltip,1e3);const i=`${Ve}map-styles/${this.globalState.isDarkMode?"dark":"positron"}.json`,e=`map-${this.viewId}`,t=this.globalState.viewState;this.mymap=new Ci.Map({container:e,style:i,...t}),this.mymap.on("move",this.handleMove),this.mymap.on("style.load",()=>{this.show3dBuildings&&this.mymap&&ve(this.mymap),this.deckOverlay=new On({interleaved:!0,layers:this.layers,onClick:this.handleClick}),this.mymap?.addControl(this.deckOverlay)})},beforeDestroy(){this.deckOverlay&&this.mymap?.removeControl(this.deckOverlay),this.mymap?.remove()},methods:{clearTooltip(){this.tooltipHTML=""},handleMove(){if(this.mapIsIndependent)return;const i=this.mymap?.getCenter(),e={latitude:i.lat,longitude:i.lng,zoom:this.mymap?.getZoom(),bearing:this.mymap?.getBearing(),pitch:this.mymap?.getPitch(),jump:!0};$t.commit("setMapCamera",e)},getTooltip(i){if(this.debounceTooltip(),!i||!i.object)return;const{x:e,y:t,object:n}=i;let o=`        <b>${n.type||"id"}: ${n.id||""}</b>       `;n.type=="flow"&&(o+=`<br/>
          Station&nbsp;IDs:&nbsp;${n?.origin.id}&nbsp;&nbsp;${n?.dest.id}<br />
          ${this.vizDetails.selectedMetricLabel}: ${n.count||0}
        `),this.tooltipStyle.display="block",this.tooltipStyle.top=`${t+12}px`,this.tooltipStyle.left=`${e+12}px`,this.tooltipHTML=o},handleClick(i,e){this.tooltipStyle.display="none"}}});var Gs=function(){var e=this,t=e._self._c;return e._self._setupProxy,t("div",{staticClass:"deck-map flex-col"},[t("div",{staticClass:"map-container",attrs:{id:`map-${e.viewId}`}}),t("div",{directives:[{name:"show",rawName:"v-show",value:!!e.tooltipHTML,expression:"!!tooltipHTML"}],staticClass:"deck-tooltip",style:e.tooltipStyle,domProps:{innerHTML:e._s(e.tooltipHTML)}})])},Us=[],js=ee(Ns,Gs,Us,!1,null,null);const Ws=js.exports,Ys=te({name:"TimeSlider",components:{},props:{numHours:Number,hourlyTotals:{type:Object,default:()=>new Float32Array(0)},initial:{type:Array,default:()=>[]},labels:{type:Array,default:()=>[]},isDarkMode:Boolean},data:()=>({leftside:0,rightside:0,isDraggingDivider:0,isDragHappening:!1,dragStartWidth:100,thumbLeft:100,thumbWidth:0,pctStart:0,pctEnd:1,selectedhour:0,maxFlows:1,side:"",activeHour:0,useInitial:!0}),computed:{},watch:{hourlyTotals:function(i,e){this.updateHours(),this.numHours?(this.getWeekHeight(this.numHours),this.activeHour=this.numHours/2):this.activeHour=0,this.showHour(this.activeHour)}},mounted(){this.rightside=this.numHours||0,this.updateHours(),this.numHours?this.activeHour=this.numHours/2:this.activeHour=0,this.showHour(this.activeHour);const e=document.getElementById("hourlybar").clientWidth;this.thumbLeft=Math.floor(this.initial[0]*e),this.thumbWidth=Math.ceil(e);const t=new ResizeObserver(o=>{const l=document.getElementById("hourlybar").clientWidth;let a=this.useInitial?this.initial[0]:this.pctStart;this.useInitial?this.initial[1]:this.pctEnd,this.useInitial=!1,this.thumbLeft=Math.floor(a*l),this.thumbWidth=Math.ceil(l)}),n=document.getElementById("hourlybar");n&&t.observe(n)},methods:{updateHours(){this.maxFlows=Math.max(...this.hourlyTotals.headwayPerHour)},getWeekHeight(i){return Math.max(10,Math.floor(100*i/this.maxFlows))},dividerDragStart(i,e){this.isDraggingDivider=i.clientX,this.dragStartWidth=this.thumbLeft,this.side=e},dividerDragEnd(i){this.isDraggingDivider=0,this.side=""},showHour(i){this.selectedhour=i,this.activeHour=i,this.$emit("hourSelected",this.selectedhour)},dividerDragging(i){if(!this.isDraggingDivider)return;if(this.side=="left")return this.adjustLeftSide(i);if(this.side=="right")return this.adjustRightSide(i);const t=document.getElementById("hourlybar").clientWidth,n=i.clientX-this.isDraggingDivider;this.thumbLeft=Math.max(0,this.dragStartWidth+n),this.thumbLeft=Math.min(this.thumbLeft,t-this.thumbWidth),this.pctStart=this.thumbLeft/t,this.pctEnd=(this.thumbLeft+this.thumbWidth)/t},adjustLeftSide(i){const t=document.getElementById("hourlybar").clientWidth,n=i.clientX-this.isDraggingDivider,o=this.thumbLeft+n;o<0||o>=this.thumbLeft+this.thumbWidth-16||(this.isDraggingDivider+=n,this.thumbLeft+=n,this.thumbWidth-=n,this.thumbLeft=Math.max(0,this.thumbLeft),this.pctStart=this.thumbLeft/t,this.pctEnd=(this.thumbLeft+this.thumbWidth)/t,console.log(this.pctStart,this.pctEnd),this.$emit("range",{start:this.pctStart,end:this.pctEnd}))},adjustRightSide(i){const t=document.getElementById("hourlybar").clientWidth,n=i.clientX-this.isDraggingDivider,o=this.thumbWidth+n;o<16||this.thumbLeft+o>t||(this.thumbWidth+=n,this.isDraggingDivider=i.clientX,this.pctStart=this.thumbLeft/t,this.pctEnd=(this.thumbLeft+this.thumbWidth)/t,this.$emit("range",{start:this.pctStart,end:this.pctEnd}))},sizerDragStart(i){console.log("dragStart",i),this.isDraggingDivider=i.clientX,this.dragStartWidth=this.thumbLeft},sizerDragEnd(i){this.isDraggingDivider=0},sizerDragging(i){if(!this.isDraggingDivider)return;console.log("sizer",this.isDraggingDivider,i.clientX,this.thumbLeft,this.thumbWidth);const t=document.getElementById("hourlybar").clientWidth,n=i.clientX-this.isDraggingDivider;console.log({deltaX:n});let o=n;console.log(o),console.log("oldwidth",this.thumbWidth,"newwidth",this.thumbWidth-o),console.log("oldleft",this.thumbLeft,"newleft",this.thumbLeft+o),this.thumbWidth-=o,this.thumbLeft+=o,this.pctStart=this.thumbLeft/t,this.pctEnd=(this.thumbLeft+this.thumbWidth)/t,this.$emit("range",{start:this.pctStart,end:this.pctEnd})},filterByDate(){}}});var Zs=function(){var e=this,t=e._self._c;return e._self._setupProxy,t("div",{staticClass:"time-slider",on:{mousemove:function(n){return n.stopPropagation(),e.dividerDragging.apply(null,arguments)},mouseup:e.dividerDragEnd}},[t("div",{attrs:{id:"hourlybar"}},[t("div",{staticClass:"bars"},e._l(e.hourlyTotals.headwayPerHour,function(n,o){return t("div",{staticClass:"week",style:{height:`${e.getWeekHeight(n)}%`,"background-color":e.activeHour==o?"#7957d5":"#e24986"},on:{click:function(r){return e.showHour(o)}}},[t("div",{staticClass:"weektooltiptext"},[e._v(e._s(o+":00"))])])}),0),e.labels?t("div",{staticClass:"labels"},e._l(e.labels,function(n){return t("div",{staticClass:"date-label",style:{left:`${n.leftPct}%`,right:`${n.rightPct}%`,color:e.isDarkMode?"#C6C1B9":"#363636"}},[e._v(e._s(n.text))])}),0):e._e()])])},qs=[],Xs=ee(Ys,Zs,qs,!1,null,"e64c46a9");const Vs=Xs.exports,Ks=te({name:"FlowMap",components:{FlowMapLayer:Ws,ZoomButtons:Fi,TimeSlider:Vs},props:{config:Object,datamanager:{type:Object},root:{type:String,required:!0},subfolder:{type:String,required:!0},thumbnail:Boolean,yamlConfig:String,configFromDashboard:Object},computed:{fileApi(){return new cn(this.fileSystem,$t)},fileSystem(){const i=this.$store.state.svnProjects.filter(e=>e.slug===this.root);if(i.length===0)throw console.log("no such project"),Error;return i[0]},mapProps(){return{viewId:this.viewId,bgLayers:this.backgroundLayers,locations:this.centroids,flows:this.filteredFlows,dark:this.$store.state.isDarkMode,elapsed:this.elapsed,vizDetails:this.vizDetails,slider:this.slider,mapIsIndependent:!1,show3dBuildings:this.show3dBuildings}},urlThumbnail(){return this.thumbnailUrl}},watch:{"$store.state.isDarkMode"(){this.isDarkMode=this.$store.state.isDarkMode},vizDetails:function(i){console.log("color changed"),this.vizDetails=i}},data(){return{isLoaded:!1,hasHours:!0,stopFacilities:{},centroids:[],flows:[],filteredFlows:[],viewId:Math.floor(1e12*Math.random()),statusText:"Loading...",needsInitialMapExtent:!0,myDataManager:this.datamanager||new ye(this.root,this.subfolder),thumbnailUrl:"url('assets/thumbnail.jpg') no-repeat;",backgroundLayers:null,resolvers:{},resolverId:0,_roadFetcher:{},startTime:Date.now(),elapsed:0,animator:null,myState:{statusMessage:"",fileApi:void 0,fileSystem:void 0,subfolder:"",thumbnail:!1},crs:"",hourlyTotals:{headwayPerHour:new Float32Array(0)},hours:[],labels:[],numHours:0,selectedHour:0,datasets:[],isDarkMode:this.$store.state.isDarkMode,slider:{map:{},isLoaded:!1,population:[],numInfections:0,coordinates:new Float64Array(1),deckOverlay:{},startDate:"",filterStartHour:0,filterEndHour:24,filteredFlows:[],labels:["",""],csvStreamer:null,useMeters:!0,radiusSlider:250,range:[20,1e3],path:"",updating:!0},vizDetails:{title:"test",description:"",thumbnail:"",zoom:9.5,center:null,pitch:0,bearing:0,stopFacilitiesFile:"",network:"",dataset:"",colorScheme:"",loadTransit:!1,metrics:[{label:"",dataset:"",origin:"",destination:"",flow:"",transformValue:"",colorScheme:""}],boundaries:"",boundariesJoinCol:"",origin:"",destination:"",flow:"",selectedMetric:{},selectedMetricLabel:"",highlightColor:"orange",fadeEnabled:!0,fadeAmount:50,animationEnabled:!0,clustering:!0,clusteringLevel:null,clusteringEnabled:!0,locationLabelsEnabled:!0,locationTotalsEnabled:!0,pickable:!0,opacity:null,fadeOpacityEnabled:!0,outlineThickness:0,showOnlyTopFlows:null,maxTopFlowsDisplayNum:null},show3dBuildings:!1}},async mounted(){try{this.$store.commit("setFullScreen",!this.thumbnail),this.myState.thumbnail=this.thumbnail,this.myState.subfolder=this.subfolder,this.myDataManager=this.datamanager||new ye(this.root,this.subfolder),this._roadFetcher=new Si,await this.getVizDetails(),this.vizDetails.title&&this.$emit("title",this.vizDetails.title),this.needsInitialMapExtent&&(this.vizDetails.center||this.vizDetails.zoom)&&(this.$store.commit("setMapCamera",{center:this.vizDetails.center,zoom:this.vizDetails.zoom||9,bearing:this.vizDetails.bearing||0,pitch:this.vizDetails.pitch||0,longitude:this.vizDetails.center?this.vizDetails.center[0]:0,latitude:this.vizDetails.center?this.vizDetails.center[1]:0}),this.needsInitialMapExtent=!1),await this.loadBoundaries(),this.vizDetails.metrics||(this.vizDetails.metrics=[{dataset:this.vizDetails.dataset,origin:this.vizDetails.origin,destination:this.vizDetails.destination,flow:this.vizDetails.flow,label:this.vizDetails.flow,colorScheme:"Warm"}]),this.vizDetails=Object.assign({},this.vizDetails),this.vizDetails.selectedMetricLabel=this.vizDetails.metrics[0].flow,this.vizDetails.selectedMetric=this.vizDetails.metrics[0],this.slider.labels=["test","test"],this.slider=Object.assign({},this.slider),await this.configureData(this.vizDetails.metrics[0]);try{this.backgroundLayers=new Bn({vizDetails:this.vizDetails,fileApi:this.fileApi,subfolder:this.subfolder}),await this.backgroundLayers.initialLoad()}catch{this.$emit("error","Error loading background layers")}this.$emit("isLoaded"),this.statusText=""}catch(i){this.$emit("error","Flowmap"+i)}},beforeDestroy(){this._roadFetcher&&this._roadFetcher.terminate(),this.animator&&window.cancelAnimationFrame(this.animator)},methods:{async getVizDetails(){if(this.configFromDashboard){console.log("we have a dashboard"),console.log(this.configFromDashboard),this.vizDetails=Object.assign({},this.configFromDashboard),this.sync3dBuildingsSetting();return}new RegExp(".*(yml|yaml)$").test(this.yamlConfig??"")&&(console.log("has yaml"),await this.loadStandaloneYAMLConfig()),this.sync3dBuildingsSetting()},sync3dBuildingsSetting(){this.show3dBuildings=!!(this.vizDetails.buildings3d??this.vizDetails.show3dBuildings)},toggle3dBuildings(){this.show3dBuildings=!this.show3dBuildings},async buildThumbnail(){if(console.log(this.myState.fileApi),!!this.myState.fileApi&&this.thumbnail&&this.vizDetails.thumbnail)try{const e=await(await this.myState.fileApi.getFileBlob(this.myState.subfolder+"/"+this.vizDetails.thumbnail)).arrayBuffer(),t=ln.arrayBufferToBase64(e);t&&(this.thumbnailUrl=`center / cover no-repeat url(data:image/png;base64,${t})`)}catch(i){console.error(i)}},handleClickedMetric(i){this.vizDetails.selectedMetric=i,this.configureData(i)},async loadStandaloneYAMLConfig(){if(!this.fileApi)return{};const i=this.yamlConfig??"",e=i.indexOf("/")>-1?i:this.subfolder+"/"+this.yamlConfig;try{const n=await this.fileApi.getFileText(e);this.vizDetails=Object.assign({},de.parse(n));return}catch(n){const o=""+n;o.startsWith("YAMLSemantic")&&this.$emit("error",`${e}: ${o}`),console.log(`${e} not found, trying config folders`)}const{vizes:t}=await this.fileApi.findAllYamlConfigs(this.subfolder);if(t[i])try{const n=await this.fileApi.getFileText(t[i]);this.vizDetails=Object.assign({},de.parse(n))}catch{console.error(`Also failed to load ${t[i]}`)}},fetchXML(i){let e=i.worker;e.onmessage=o=>{const{resolve:r,reject:l}=this.resolvers[o.data.id];e.terminate(),o.data.error&&l(o.data.error),r(o.data.xml)};const t=this.resolverId++;return e.postMessage({id:t,fileSystem:this.fileSystem,filePath:i.filePath,options:i.options}),new Promise((o,r)=>{this.resolvers[t]={resolve:o,reject:r}})},setupHourlyTotals(){this.numHours=this.getMaxHour(),this.slider.filterStartHour=0,this.slider.filterEndHour=this.numHours,this.hourlyTotals={headwayPerHour:new Float32Array(this.numHours+1)},this.flows.forEach(t=>{this.hourlyTotals.headwayPerHour[t.h]+=1});const i="00:00",e=this.numHours+":00";this.labels.push({leftPct:"0",rightPct:"auto",top:"2px",text:i.toString()}),this.labels.push({leftPct:"auto",rightPct:"0",top:"2px",text:e.toString()})},getMaxHour(){return this.flows?this.flows.reduce((i,e)=>e.h>i?e.h:i,this.flows[0].h):0},async loadBoundaries(){if(this.vizDetails.loadTransit){await this.loadTransitBoundaries();return}await this.loadGeojsonBoundaries()},async loadGeojsonBoundaries(){const i=`${this.subfolder}/${this.vizDetails.boundaries}`,e=await this.fileApi.getFileJson(i);this.stopFacilities=e.features;for(const t of e.features)try{const n=xi(t);this.centroids.push({id:`${t.properties[this.vizDetails.boundariesJoinCol||t.id||t.properties.id]}`,lon:n?.geometry?.coordinates[0]||0,lat:n?.geometry?.coordinates[1]||0})}catch{console.warn("skipping feature:",t)}this.setMapCenter()},async loadTransitBoundaries(){let i={};try{const{files:e}=await this.fileApi.getDirectory(this.myState.subfolder),t=e.filter(n=>n.endsWith("transitSchedule.xml.gz")&&!n.startsWith("._"));this.stopFacilities=t,t?(this.vizDetails.stopFacilitiesFile=t[0],i=await this.fetchXML({worker:this._roadFetcher,slug:this.fileSystem.slug,filePath:this.myState.subfolder+"/"+this.vizDetails.stopFacilitiesFile,options:{attributeNamePrefix:""}}),i&&i.transitSchedule?this.stopFacilities=i.transitSchedule:console.error("fetched xml didn't have transit schedule")):(console.error("no transit schedule found."),this.vizDetails.stopFacilitiesFile="")}catch(e){this.$emit("error","Boundaries: "+e),console.error(e);return}this.calculateCentroids(),this.setMapCenter()},filterByHour(i){let e=this.flows.reduce((t,n)=>(n.h==i&&t.push(n),t),[]);this.filteredFlows=e},calculateCentroids(){if(this.stopFacilities!==void 0){this.stopFacilities?.attributes&&this.stopFacilities?.attributes?.attribute?.name==="coordinateReferenceSystem"?(this.crs=this.stopFacilities?.attributes?.attribute?.["#text"],console.log(this.crs)):(console.log("no crs found in transit schedule, reverting to WGS 84"),this.crs="EPSG:4326");for(const i of this.stopFacilities.transitStops.stopFacility){const[e,t]=zn.toLngLat(this.crs,[parseFloat(i.x),parseFloat(i.y)]);this.centroids.push({id:i.id,lon:e,lat:t})}}else console.error("transit schedule from xml is undefined.")},setMapCenter(){if(this.vizDetails.center){typeof this.vizDetails.center=="string"&&(this.vizDetails.center=this.vizDetails.center.split(",").map(Number)),this.$store.commit("setMapCamera",{longitude:this.vizDetails.center[0],latitude:this.vizDetails.center[1],bearing:0,pitch:0,zoom:this.vizDetails.zoom||10,jump:!1});return}if(!this.centroids.length)return;let i=0,e=0,t=0;const n=this.centroids.length,o=256;for(let l=0;l<n;l+=o)e+=this.centroids[l].lon,t+=this.centroids[l].lat,i++;e=e/i,t=t/i;const r=this.$store.state.viewState;e&&t&&this.$store.commit("setMapCamera",{longitude:e,latitude:t,bearing:r.bearing,pitch:r.pitch,zoom:this.vizDetails.zoom||r.zoom,jump:!1})},async configureData(i){this.vizDetails.colorScheme=i.colorScheme,this.vizDetails.selectedMetricLabel=i.flow;const e=i.origin||"origin",t=i.destination||"destination",n=i.flow||"flow",o=i.hour||"departureHour";try{this.vizDetails.dataset=i.dataset;const l=(await this.myDataManager.getDataset(this.vizDetails,{subfolder:this.subfolder})).allRows||{};e in l||this.$emit("error",`Column ${e} not found`),t in l||this.$emit("error",`Column ${t} not found`),n in l||this.$emit("error",`Column ${n} not found`);const a=l[e].values,s=l[t].values,c=l[n].values;this.hasHours=o in l;const h=this.hasHours?l[o].values:null,u=[],d=i.valueTransform?.enum?.[0]=="inverse";for(let f=0;f<a.length;f++)try{u.push({o:`${a[f]}`,d:`${s[f]}`,v:d?1/c[f]:c[f],h:this.hasHours?h[f]:0})}catch{}this.flows=u,this.filteredFlows=this.flows,this.hasHours&&this.setupHourlyTotals(),this.isLoaded=!0}catch(r){console.log(""+r),this.flows=[],this.$emit("error",""+r)}}}});var Js=function(){var e=this,t=e._self._c;return e._self._setupProxy,t("div",{staticClass:"flowmap-page"},[t("div",{staticClass:"flowmap",class:{"hide-thumbnail":!e.thumbnail},style:{background:e.urlThumbnail},attrs:{oncontextmenu:"return false"}},[t("div",{staticClass:"map-layout"},[e.centroids.length?t("flow-map-layer",e._b({staticClass:"map-layer"},"flow-map-layer",e.mapProps,!1)):e._e()],1),t("zoom-buttons",{attrs:{corner:"top-left",show3dToggle:!0,is3dBuildings:e.show3dBuildings,onToggle3dBuildings:e.toggle3dBuildings}}),e.hasHours?t("div",{staticClass:"bottom-panel"},[t("h1",[e._v(e._s(`Hours ${e.slider.filterStartHour} - ${e.slider.filterEndHour}`))]),t("div",{staticClass:"button-row"},[e.isLoaded?t("time-slider",{staticClass:"time-slider",attrs:{numHours:e.numHours,hourlyTotals:e.hourlyTotals,initial:[0,e.getMaxHour()],labels:e.labels,isDarkMode:e.isDarkMode},on:{hourSelected:e.filterByHour}}):e._e()],1)]):e._e()],1),t("div",{staticClass:"right-side-panel"},[t("div",{staticClass:"metric-label"},[e._v("Metrics")]),t("div",{staticClass:"metric-buttons"},e._l(e.vizDetails.metrics,function(n,o){return t("button",{key:o,staticClass:"button is-small metric-button",on:{click:function(r){return e.handleClickedMetric(n)}}},[e._v(e._s(n.label))])}),0),t("br"),t("div",{staticClass:"metric-label"},[e._v("Color scheme")]),t("b-select",{staticClass:"form-select is-small",on:{input:function(n){e.vizDetails={...e.vizDetails}}},model:{value:e.vizDetails.colorScheme,callback:function(n){e.$set(e.vizDetails,"colorScheme",n)},expression:"vizDetails.colorScheme"}},[t("option",{attrs:{value:"Blues"}},[e._v("Blues")]),t("option",{attrs:{value:"BluGrn"}},[e._v("BluGrn")]),t("option",{attrs:{value:"BluYl"}},[e._v("BluYl")]),t("option",{attrs:{value:"BrwnYl"}},[e._v("BrwnYl")]),t("option",{attrs:{value:"BuGn"}},[e._v("BuGn")]),t("option",{attrs:{value:"BuPu"}},[e._v("BuPu")]),t("option",{attrs:{value:"Burg"}},[e._v("Burg")]),t("option",{attrs:{value:"BurgYl"}},[e._v("BurgYl")]),t("option",{attrs:{value:"Cool"}},[e._v("Cool")]),t("option",{attrs:{value:"DarkMint"}},[e._v("DarkMint")]),t("option",{attrs:{value:"Emrld"}},[e._v("Emrld")]),t("option",{attrs:{value:"GnBu"}},[e._v("GnBu")]),t("option",{attrs:{value:"Grayish"}},[e._v("Grayish")]),t("option",{attrs:{value:"Greens"}},[e._v("Greens")]),t("option",{attrs:{value:"Greys"}},[e._v("Greys")]),t("option",{attrs:{value:"Inferno"}},[e._v("Inferno")]),t("option",{attrs:{value:"Magenta"}},[e._v("Magenta")]),t("option",{attrs:{value:"Magma"}},[e._v("Magma")]),t("option",{attrs:{value:"Mint"}},[e._v("Mint")]),t("option",{attrs:{value:"Oranges"}},[e._v("Oranges")]),t("option",{attrs:{value:"OrRd"}},[e._v("OrRd")]),t("option",{attrs:{value:"OrYel"}},[e._v("OrYel")]),t("option",{attrs:{value:"Peach"}},[e._v("Peach")]),t("option",{attrs:{value:"Plasma"}},[e._v("Plasma")]),t("option",{attrs:{value:"PinkYl"}},[e._v("PinkYl")]),t("option",{attrs:{value:"PuBu"}},[e._v("PuBu")]),t("option",{attrs:{value:"PuBuGn"}},[e._v("PuBuGn")]),t("option",{attrs:{value:"PuRd"}},[e._v("PuRd")]),t("option",{attrs:{value:"Purp"}},[e._v("Purp")]),t("option",{attrs:{value:"Purples"}},[e._v("Purples")]),t("option",{attrs:{value:"PurpOr"}},[e._v("PurpOr")]),t("option",{attrs:{value:"RdPu"}},[e._v("RdPu")]),t("option",{attrs:{value:"RedOr"}},[e._v("RedOr")]),t("option",{attrs:{value:"Reds"}},[e._v("Reds")]),t("option",{attrs:{value:"Sunset"}},[e._v("Sunset")]),t("option",{attrs:{value:"SunsetDark"}},[e._v("SunsetDark")]),t("option",{attrs:{value:"Teal"}},[e._v("Teal")]),t("option",{attrs:{value:"TealGrn"}},[e._v("TealGrn")]),t("option",{attrs:{value:"Viridis"}},[e._v("Viridis")]),t("option",{attrs:{value:"Warm"}},[e._v("Warm")]),t("option",{attrs:{value:"YlGn"}},[e._v("YlGn")]),t("option",{attrs:{value:"YlGnBu"}},[e._v("YlGnBu")]),t("option",{attrs:{value:"YlOrBr"}},[e._v("YlOrBr")]),t("option",{attrs:{value:"YlOrRd"}},[e._v("YlOrRd")])]),t("br"),t("b-checkbox",{staticClass:"tight",model:{value:e.vizDetails.animationEnabled,callback:function(n){e.$set(e.vizDetails,"animationEnabled",n)},expression:"vizDetails.animationEnabled"}},[t("p",[e._v("Animation")])]),t("br"),t("b-checkbox",{staticClass:"tight",model:{value:e.vizDetails.clustering,callback:function(n){e.$set(e.vizDetails,"clustering",n)},expression:"vizDetails.clustering"}},[t("p",[e._v("Clustering")])])],1)])},Qs=[],tr=ee(Ks,Js,Qs,!1,null,"dce897db");const Ir=tr.exports;export{Ir as default};
