import{d as w,g as n,m as S,n as b,R as m,S as h}from"./index-D_sw2g-2.js";import{G as C}from"./lil-gui.esm-D2cLj-mk.js";import{Y as f}from"./index-DFKcNkqO.js";import{w as k,p as T}from"./comlink-CPG-Ccvr.js";import{u as D,H as z}from"./HTTPFileSystem-ChhivMzi.js";import{C as M}from"./CollapsiblePanel-DSPRew5z.js";import{D as A}from"./DrawingTool-C9sJ7itr.js";import{L as E}from"./LegendBox-BmX6GIKz.js";import{L as $}from"./LegendStore-CGgeb9zL.js";import{T as I}from"./TimeSlider-BmkwW4Ri.js";import{I as L,C as B}from"./moving-icons-vehicles-layer-BE4Nsm9T.js";import{e as y,d as F}from"./threeDBuildings-eDgufgS4.js";import{M as _}from"./mapbox-overlay-HS93bZkL.js";import{D as j}from"./data-filter-extension-BJBYmUft.js";import{Z as R}from"./ZoomButtons-B4PrQ7mG.js";import{b as x,p as v}from"./turf.es-BzqbG201.js";import{D as O}from"./DashboardDataManager-mkjvCydQ.js";import"./fxp-DjoqftHf.js";import"./layer-T9N9JmIf.js";import"./geojson-layer-DvtTfj7b.js";import"./layer-extension-LbH36Bf-.js";import"./group-hI8ly2Wr.js";import"./index-_doEQLKC.js";const g="/simwrapper/",Y={vehicle:{x:0,y:0,width:256,height:256,mask:!1}},N=w({name:"EventDeckComponent",props:{breakpoints:{type:Array,required:!0},dark:{type:Boolean,required:!0},dotsize:{type:Number,required:!0},eventData:{type:Array,required:!0},mapIsIndependent:{type:Boolean,required:!0},projection:{type:String,required:!0},simulationTime:{type:Number,required:!0},tick:{type:Number,required:!0},viewId:{type:Number,required:!0},show3dBuildings:{type:Boolean,required:!1,default:!1}},data(){return{mymap:null,deckOverlay:null,globalState:n.state,dataFilter:new j({filterSize:1}),tooltipHTML:"",tooltipStyle:{position:"absolute",padding:"4px 8px",display:"block",top:0,left:0,color:this.dark?"#ccc":"#223",backgroundColor:this.dark?"#2a3c4f":"white",zIndex:2e4}}},watch:{layers(){this.deckOverlay&&this.deckOverlay.setProps({layers:this.layers})},dark(){let e;this.projection=="Atlantis"?e={version:8,sources:{},layers:[]}:e=`${g}map-styles/${this.globalState.isDarkMode?"dark":"positron"}.json`,this.mymap?.setStyle(e)},show3dBuildings(){!this.mymap||this.projection==="Atlantis"||(this.show3dBuildings?y(this.mymap):F(this.mymap))},"globalState.viewState"(){if(this.mapIsIndependent)return;const e=this.globalState.viewState,t=this.mymap?.getCenter();(e.longitude!==t.lng||e.latitude!==t.lat||e.zoom!==this.mymap?.getZoom()||e.pitch!==this.mymap?.getPitch()||e.bearing!==this.mymap?.getBearing())&&this.mymap?.jumpTo(Object.assign({center:{lng:e.longitude,lat:e.latitude}},e))}},computed:{latitudeCorrectionFactor(){const e=this.globalState.viewState,t=e.latitude||e.center&&e.center[1]||35;return Math.cos(t*Math.PI/180)},layers(){const e=[];return this.eventData.forEach((t,i)=>{const s=this.simulationTime<t.timeRange[0]-5||this.simulationTime>t.timeRange[1]+5;e.push(new L({data:{length:t.data.t0.length,attributes:{getTimeStart:t.data.t0,getTimeEnd:t.data.t1,getPathStart:t.data.p0,getPathEnd:t.data.p1,getColorCode:t.data.colors}},id:"vehicles"+i,iconMoving:"vehicle",iconStill:"vehicle",colorDepiction:B.REL_SPEED,getSize:this.dotsize,opacity:1,latitudeCorrectionFactor:this.latitudeCorrectionFactor,currentTime:this.simulationTime,shadowEnabled:!1,iconAtlas:`${g}images/veh-curvy5.png`,iconMapping:Y,sizeScale:1,billboard:!1,positionFormat:"XY",pickable:!1,autoHighlight:!1,highlightColor:[255,255,255,140],parameters:{depthTest:!1},visible:!s}))}),e}},mounted(){let e;this.projection=="Atlantis"?e={version:8,sources:{},layers:[]}:e=`${g}map-styles/${this.globalState.isDarkMode?"dark":"positron"}.json`,e=`https://tiles.stadiamaps.com/styles/alidade_satellite.json?api_key=${`21${this.$store.state.mapuuid}`}`;const i=`map-${this.viewId}`,s=this.globalState.viewState.center,o=this.globalState.viewState.zoom||8;this.mymap=new S.Map({container:i,style:e,center:s,zoom:o}),this.mymap.on("move",this.handleMove),this.mymap.on("style.load",()=>{this.projection!=="Atlantis"&&this.show3dBuildings&&this.mymap&&y(this.mymap),this.deckOverlay=new _({interleaved:!0,layers:this.layers,onClick:this.handleClick}),this.mymap?.addControl(this.deckOverlay)})},beforeDestroy(){this.deckOverlay&&this.mymap?.removeControl(this.deckOverlay),this.mymap?.remove()},methods:{handleMove(){if(this.mapIsIndependent)return;const e=this.mymap?.getCenter(),t={latitude:e.lat,longitude:e.lng,zoom:this.mymap?.getZoom(),bearing:this.mymap?.getBearing(),pitch:this.mymap?.getPitch(),jump:!0};n.commit("setMapCamera",t)},getTooltip(e){this.tooltipHTML=""},handleClick(e,t){this.tooltipStyle.display="none"}}});var P=function(){var t=this,i=t._self._c;return t._self._setupProxy,i("div",{staticClass:"deck-map flex-col"},[i("div",{staticClass:"map-container",attrs:{id:`map-${t.viewId}`}}),t.tooltipHTML?i("div",{staticClass:"deck-tooltip",style:t.tooltipStyle,attrs:{"v-html":t.tooltipHTML}}):t._e()])},q=[],W=b(N,P,q,!1,null,null);const V=W.exports;function H(e){return new Worker("/simwrapper/assets/WASMEventStreamer.worker-DWoX0gl5.js",{name:e?.name})}const G={messages:{en:{loading:"Loading data...",sorting:"Sorting into bins...",aggregate:"Summary",maxHeight:"3D Height",showDetails:"Show Details",selection:"Selection",areas:"Areas",count:"Count",promptCRS:`Enter the coordinate reference system, e.g. EPSG:25832

These coordinates are not in long/lat format. To fix this permanently, convert them to long/lat or add "# EPSG:xxxx" to your CSV header`},de:{loading:"Dateien laden...",sorting:"Sortieren...",aggregate:"Daten",maxHeight:"3-D Höhe",showDetails:"Details anzeigen",selection:"Ausgewählt",areas:"Orte",count:"Anzahl"}}},Z=w({name:"EventViewerPlugin",i18n:G,components:{CollapsiblePanel:M,DrawingTool:A,EventMap:V,LegendBox:E,TimeSlider:I,ZoomButtons:R},props:{root:{type:String,required:!0},subfolder:{type:String,required:!0},yamlConfig:String,config:Object,thumbnail:Boolean,datamanager:{type:Object}},data:()=>({tick:0,myDataManager:null,network:{source:new Float32Array,dest:new Float32Array,linkIds:[],projection:""},linkIdLookup:{},guiConfig:{speed:.01,size:24},viewId:Math.floor(1e12*Math.random()),configId:"gui-config-"+Math.floor(1e12*Math.random()),timeLabels:[0,1],startTime:0,isAnimating:!1,simTime:0,timeFilter:[0,3600],colors:[[128,128,128],[128,128,128]],breakpoints:[0],range:[1/0,-1/0],timeRange:[1/0,-1/0],legendStore:null,standaloneYAMLconfig:{title:"",description:"",file:"",projection:"",thumbnail:"",radius:250,maxHeight:0,center:null,zoom:9},YAMLrequirementsXY:{file:""},columnLookup:[],gzipWorker:null,vizDetails:{title:"",description:"",file:"",projection:"",thumbnail:"",center:null,zoom:9},show3dBuildings:!1,myState:{statusMessage:"",subfolder:"",yamlConfig:"",thumbnail:!1},eventData:[],isLoaded:!1,animator:null,guiController:null,resizer:null,thumbnailUrl:"url('assets/thumbnail.jpg') no-repeat;",animationElapsedTime:0,animationClockTime:0,prevBearing:0}),computed:{fileApi(){return new z(this.fileSystem,n)},fileSystem(){const e=this.$store.state.svnProjects.filter(t=>t.slug===this.root);if(e.length===0)throw console.log("no such project"),Error;return e[0]},urlThumbnail(){return this.thumbnailUrl},follow(){return this.$route.query?.follow??""},rotate(){return"rotate"in this.$route.query}},watch:{"$store.state.viewState"(){m[this.viewId]&&m[this.viewId]()}},methods:{setupGui(){this.guiController=new C({title:"VIEW SETTINGS",injectStyles:!0,width:200,container:document.getElementById(this.configId)||void 0});const e=this.guiController;e.add(this.guiConfig,"size",4,40,1).onChange(this.setConfig),e.add(this.guiConfig,"speed",[-2,-1,-.5,-.25,-.1,-.01,0,.01,.1,.25,.5,1,2],1).onChange(this.setConfig)},async solveProjection(){if(!this.thumbnail){console.log("WHAT PROJECTION:");try{const e=await this.fileApi.getFileText(this.myState.subfolder+"/"+this.myState.yamlConfig);this.vizDetails=f.parse(e)}catch(e){console.error(e),this.$emit("error",""+e)}}},async getVizDetails(){if(this.config){this.validateYAML(),this.vizDetails=Object.assign({},this.config),this.sync3dBuildingsSetting();return}new RegExp(".*(yml|yaml)$").test(this.myState.yamlConfig)?await this.loadStandaloneYAMLConfig():(console.log("NO YAML WTF"),this.setConfigForRawCSV()),this.sync3dBuildingsSetting()},setConfigForRawCSV(){let e="";this.vizDetails={title:"EVENTS: "+this.myState.yamlConfig,description:this.myState.yamlConfig,file:this.myState.yamlConfig,projection:e,center:this.vizDetails.center||void 0,zoom:this.vizDetails.zoom},this.$emit("title",this.vizDetails.title||this.vizDetails.file)},async loadStandaloneYAMLConfig(){if(this.fileApi)try{const e=this.myState.yamlConfig.indexOf("/")>-1?this.myState.yamlConfig:this.myState.subfolder+"/"+this.myState.yamlConfig,t=await this.fileApi.getFileText(e);this.standaloneYAMLconfig=Object.assign({},f.parse(t)),this.validateYAML(),this.setVizDetails()}catch{console.log("failed"),this.$emit("error",{type:h.ERROR,msg:"File not found",desc:`Could not find: ${this.myState.subfolder}/${this.myState.yamlConfig}`})}},validateYAML(){const e=new RegExp(".*(yml|yaml)$").test(this.myState.yamlConfig);let t;e?(console.log("has yaml"),t=this.standaloneYAMLconfig):(console.log("no yaml"),t=this.config);for(const i in this.YAMLrequirementsXY)i in t||this.$emit("error",{type:h.ERROR,msg:`EventViewer missing required key: ${i}`,desc:`Required keys: ${Object.keys(this.YAMLrequirementsXY)}`});t.radius==0&&this.$emit("error",{type:h.WARNING,msg:"Radius set to zero",desc:"Radius can not be zero, preset value used instead. "}),(t.zoom<5||t.zoom>20)&&this.$emit("error",{type:h.WARNING,msg:"Zoom is out of the recommended range ",desc:"Zoom levels should be between 5 and 20. "})},setVizDetails(){this.vizDetails=Object.assign({},this.vizDetails,this.standaloneYAMLconfig);const e=this.vizDetails.title?this.vizDetails.title:"EVENTS: "+this.vizDetails.file;this.$emit("title",e)},sync3dBuildingsSetting(){this.show3dBuildings=!!(this.vizDetails.buildings3d??this.vizDetails.show3dBuildings)},toggle3dBuildings(){this.show3dBuildings=!this.show3dBuildings},async buildThumbnail(){if(this.thumbnail&&this.vizDetails.thumbnail)try{const t=await(await this.fileApi.getFileBlob(this.myState.subfolder+"/"+this.vizDetails.thumbnail)).arrayBuffer(),i=D.arrayBufferToBase64(t);i&&(this.thumbnailUrl=`center / cover no-repeat url(data:image/png;base64,${i})`)}catch(e){console.error(e)}},async streamEventFile(e){this.myState.statusMessage="Loading events: "+e,this.gzipWorker&&this.gzipWorker.terminate(),this.gzipWorker=new H;const t=k(this.gzipWorker),i=Object.assign({},this.fileSystem),s=[{viewer:"vehicleViewer"}];t.startStream({filename:e,layers:s,network:this.network,fsConfig:i,follow:this.follow},T(this.receiveDataFromEventStreamer))},async receiveDataFromEventStreamer(e){this.eventData=[...this.eventData,e],this.tick=1,await this.$nextTick(),this.tick=0},setFirstZoom(e,t){const i=.5*(e[0]+e[t*2-2]),s=.5*(e[1]+e[t*2-1]);Number.isFinite(i)&&Number.isFinite(s)&&n.commit("setMapCamera",Object.assign({},n.state.viewState,{longitude:i,latitude:s,zoom:10}))},toggleAnimation(){this.isAnimating=!this.isAnimating,this.isAnimating&&(this.animationElapsedTime=this.timeFilter[0]-this.timeRange[0],this.startTime=Date.now()-this.animationElapsedTime/this.guiConfig.speed,this.animate())},setConfig(){},setLegend(e,t){this.range[1]-this.range[0]!==0&&(this.legendStore=new $,this.legendStore.setLegendSection({section:"Legend",column:"Legend",values:e.map((i,s)=>{const o=t[s==0?s:s-1];let a=""+Math.round(1e6*o)/1e6;return s==0&&(a="< "+a),s==e.length-1&&(a="> "+a),{label:a,value:i}})}))},async loadNetwork(){if(!this.myDataManager)throw Error("event viewer: no datamanager");const{files:e}=await this.fileApi.getDirectory(this.subfolder);let t="";e.indexOf("network.avro")>-1?t="network.avro":t=this.vizDetails.file.replace("events.xml","network.xml"),console.log(t);const i=await this.myDataManager.getRoadNetwork(t,this.myState.subfolder,Object.assign({},this.vizDetails),null,!0);return this.vizDetails.projection=""+i.projection,{network:i}},async loadFiles(){const{network:e}=await this.loadNetwork();if(this.network=e,!this.vizDetails.center){let i=0,s=0,o=0;for(let a=0;a<this.network.source.length;a+=4096)i+=this.network.source[a],s+=this.network.source[a+1],o+=1;this.vizDetails.center=[i/o,s/o],n.commit("setMapCamera",{center:this.vizDetails.center,zoom:9})}let t=`${this.myState.subfolder}/${this.vizDetails.file}`;await this.streamEventFile(t)},handleTimeSliderValues(e){this.animationElapsedTime=e[0],this.simTime=this.animationElapsedTime,this.animationClockTime=this.animationElapsedTime+this.timeRange[0],this.timeFilter=e,this.timeLabels=[this.convertSecondsToClockTimeMinutes(e[0]),this.convertSecondsToClockTimeMinutes(e[1])]},followVehicle(){for(const e of this.eventData)if(!(e.timeRange[1]<this.simTime)&&!(e.timeRange[0]>this.simTime))for(let t=0;t<e.data.vvt0.length;t++){const i=e.data.vvt0[t],s=e.data.vvt1[t];if(i<=this.simTime&&s>=this.simTime){const o=(this.simTime-i)/(s-i),a=[e.data.vvp0[t*2],e.data.vvp0[t*2+1]],d=[e.data.vvp1[t*2],e.data.vvp1[t*2+1]],u=a[0]+(d[0]-a[0])*o,p=a[1]+(d[1]-a[1])*o,r={longitude:u,latitude:p,center:[u,p],zoom:14,jump:!0};if(this.rotate){let l=x(v(a),v(d));const c=l-this.prevBearing;Math.abs(c)>1&&(l=this.prevBearing+2*c/Math.abs(c),this.prevBearing=l),r.bearing=l,r.pitch=45,r.zoom=15}n.commit("setMapCamera",r);break}}},animate(){if(!this.isAnimating)return;this.animationElapsedTime=this.guiConfig.speed*(Date.now()-this.startTime),this.animationClockTime=this.animationElapsedTime+this.timeRange[0],this.animationClockTime>this.timeRange[1]&&(this.startTime=Date.now(),this.animationElapsedTime=0);const e=3600;this.timeFilter=[this.animationClockTime,this.animationClockTime+e],this.simTime=this.animationClockTime,this.follow&&this.followVehicle(),this.animator=window.requestAnimationFrame(this.animate)},convertSecondsToClockTimeMinutes(e){const t=Math.floor(e/3600),i=Math.floor((e-t*3600)/60),s={h:`${t}`,m:`${i}`.padStart(2,"0")};return`${s.h}:${s.m}`}},async mounted(){this.$store.commit("setFullScreen",!this.thumbnail),this.myState.thumbnail=this.thumbnail,this.myState.yamlConfig=this.yamlConfig||"",this.myState.subfolder=this.subfolder,this.myDataManager=this.datamanager||new O(this.root,this.subfolder),await this.getVizDetails(),await this.buildThumbnail(),!this.thumbnail&&(this.setupGui(),this.myState.statusMessage=`${this.$i18n.t("loading")}`,this.isLoaded||await this.loadFiles(),this.isLoaded=!0,this.myState.statusMessage="",this.timeRange=[0,86400],this.toggleAnimation())},beforeDestroy(){this.resizer?.disconnect(),m[this.viewId]=void 0,delete m[this.viewId];try{this.gzipWorker&&(this.gzipWorker.postMessage({terminate:!0}),this.gzipWorker.terminate()),this.guiController&&this.guiController.destroy()}catch(e){console.warn(e)}this.animator&&window.cancelAnimationFrame(this.animator),this.$store.commit("setFullScreen",!1)}});var U=function(){var t=this,i=t._self._c;return t._self._setupProxy,i("div",{staticClass:"viz-plugin",attrs:{oncontextmenu:"return false",id:`id-${t.viewId}`}},[t.isLoaded&&!t.thumbnail?i("event-map",{staticClass:"map-layer",attrs:{viewId:t.viewId,eventData:t.eventData,network:t.network,linkIdLookup:t.linkIdLookup,dark:this.$store.state.isDarkMode,colors:this.colors,breakpoints:this.breakpoints,radius:this.guiConfig.radius,mapIsIndependent:!1,simulationTime:t.simTime,projection:t.vizDetails.projection,dotsize:t.guiConfig.size,tick:t.tick,show3dBuildings:t.show3dBuildings}}):t._e(),t.thumbnail?t._e():i("zoom-buttons",{attrs:{corner:"top-left",show3dToggle:!0,is3dBuildings:t.show3dBuildings,onToggle3dBuildings:t.toggle3dBuildings}}),i("div",{staticClass:"top-right"},[i("div",{staticClass:"gui-config",attrs:{id:t.configId}})]),i("div",{staticClass:"bottom-right"},[t.legendStore?i("div",{staticClass:"legend-area"},[i("legend-box",{attrs:{legendStore:t.legendStore}})],1):t._e()]),t.isLoaded?i("time-slider",{staticClass:"time-slider-area",attrs:{isPointInTime:!0,range:t.timeRange,activeTimeExtent:t.timeFilter,labels:t.timeLabels,isAnimating:t.isAnimating},on:{timeExtent:t.handleTimeSliderValues,toggleAnimation:t.toggleAnimation,drag:function(s){t.isAnimating=!1}}}):t._e(),!t.thumbnail&&t.myState.statusMessage?i("div",{staticClass:"message"},[i("p",{staticClass:"status-message"},[t._v(t._s(t.myState.statusMessage))])]):t._e()],1)},X=[],J=b(Z,U,X,!1,null,"b7076d1f");const St=J.exports;export{St as default};
