import{d as W,n as Y,g as R,R as Z,r as J,h as et,M as ut,q as pt,j as ft,a as mt,C as gt}from"./index-BSRT1qCd.js";import{l as yt,p as st,b as vt}from"./turf.es-DhhXp8l8.js";import{D as St,a as kt}from"./DashboardDataManager-C_pYT4V3.js";import{c as bt}from"./index-B9fw0f6a.js";import{d as Lt}from"./index-SKlkcK94.js";import{P as Ct}from"./papaparse.min-CHKAvxeS.js";import{Y as _t}from"./index-r3K0jT4B.js";import{H as wt,n as it,m as xt}from"./HTTPFileSystem-CM0ZTrcf.js";import{C as Tt}from"./CollapsiblePanel-CcdE1mNp.js";import{W as rt}from"./NewXmlFetcher.worker-CAkY0uO-.js";import{D as Ot}from"./DrawingTool-dnoO3ElB.js";import{Z as Dt}from"./ZoomButtons-Bbfm9hHZ.js";import{D as Rt,S as It,C as Pt}from"./set-rtl-text-plugin-FQQ7PIy4.js";import{L as zt,O as at}from"./LineOffsetLayer-CZiqHAZD.js";import{G as Et}from"./geojson-layer-DWgix4fB.js";import{S as Mt}from"./solid-polygon-layer-3uI3lo6D.js";import{c as lt}from"./color-DZRtpOAM.js";import{W as Ft}from"./GzipFetcher.worker-B2PtSWmS.js";import"./group-DobYzF2-.js";import"./index-_doEQLKC.js";import"./fxp-DXsl1rlp.js";import"./text-layer-MJiJIY2N.js";import"./line-layer-DgyDN9oA.js";import"./path-layer-BFwL_QuY.js";import"./cut-by-mercator-bounds-B9-kzb9K.js";const At=W({name:"LeftDataPanel",props:{title:String},data:()=>({isHidden:!1,isLeaving:!1}),methods:{toggleHidePanel(){this.isHidden?this.isHidden=!this.isHidden:(this.isLeaving=!0,setTimeout(()=>{this.isHidden=!0,this.isLeaving=!1},300))}}});var $t=function(){var t=this,s=t._self._c;return t._self._setupProxy,s("div",{attrs:{id:"datapanel"}},[s("div",{staticClass:"content-area",class:{"is-hidden":t.isHidden,bye:t.isLeaving}},[t.title?s("div",{staticClass:"info-header"},[s("h3",{staticStyle:{padding:"0.5rem 3rem","font-size":"1rem","font-weight":"normal",color:"white"}},[t._v(t._s(t.title))])]):t._e(),s("div",{staticClass:"top-area"},[t._t("default")],2)]),s("div",{staticClass:"restore-button",class:{"add-margin":!t.isHidden}},[s("button",{staticClass:"button is-small hide-button",on:{click:t.toggleHidePanel}},[t.isHidden?t._e():s("i",{staticClass:"fa fa-arrow-left"}),t.isHidden?s("i",{staticClass:"fa fa-arrow-right"}):t._e()])])])},jt=[],Ht=Y(At,$t,jt,!1,null,"51117d95");const Bt=Ht.exports;function ot(e){return new Worker("/simwrapper/assets/TransitSupplyHelper.worker-DAet-igA.js",{name:e?.name})}const Nt=(e,t)=>{const s=[];for(const h of e){const{center:c,radius:u,slices:d}=h,y=u*.05;let f=Math.PI/2,m=f;const S=48,L=Math.cos(c[1]*Math.PI/180),D=d.reduce((k,x)=>k+x.value,0);d.forEach(k=>{k.percent=k.value/D});const _=d.reduce((k,x)=>(k[x.label]=x.value,k),{}),w=[],z=y*1.02;for(let k=0;k<=S*2;k++)m=f+k/(S*2)*Math.PI*2,w.push([c[0]+z*Math.cos(m)/L,c[1]+z*Math.sin(m)]);const F=R.state.isDarkMode;s.push([{polygon:w,color:Q(F?"black":"white"),width:y+1e-5,values:_}]);const B=d.map(k=>{const x=[c];for(let E=0;E<=S;E++){const M=k.percent||0;m=f+E/S*M*Math.PI*2,x.push([c[0]+y*Math.cos(m)/L,c[1]+y*Math.sin(m)])}x.push(c),f=m;const A=Array.isArray(k.color)?k.color:Q(k.color);return{polygon:x,color:A,width:y,values:_}});s.push(B)}const o=s.flat();return o.sort((h,c)=>h.width<=c.width?1:-1),o},Q=e=>{try{const t=lt(e);return t?[t.r,t.g,t.b]:[0,0,0]}catch{return[0,0,0]}};function Xt({viewId:e=0,links:t={},selectedFeatures:s=[],transitLines:r={},stopMarkers:o=[],mapIsIndependent:h=!1,projection:c="EPSG:4326",handleClickEvent:u=null,pieSlider:d=20,widthSlider:y=50,vizDetails:f=null,isAtlantis:m=!1}){const S=R.state.isDarkMode,L=R.state.locale,D=1-(100-y)/100,_=.1,w=!m;Z[e]=()=>{F(R.state.viewState)};const[z,F]=J.useState(R.state.viewState),B=J.useMemo(()=>t.features.map(C=>({source:[...C.geometry.coordinates[0],C.properties.sort],target:[...C.geometry.coordinates[1],C.properties.sort],color:C.properties.currentColor,width:Math.pow(C.properties.width,D)})),[t,y]),k=J.useMemo(()=>{if(!f?.demand)return[];if(!o.length||o[0].boardings==null)return[];if(o.length>1e4)return[];const g=o.map(n=>{let a=0,i=0;const l=n.ptLines;return l&&Object.values(l).forEach(p=>{r[p.name]&&(a+=p.b,i+=p.a)}),{center:n.xy,radius:2e-5*d*Math.sqrt(a+i),slices:[{label:"boardings",color:"gold",value:a},{label:"alightings",color:"darkmagenta",value:i}]}});return Nt(g)},[o,d]);function x(g){u&&u(g)}function A(g){F(g),g.center=[g.longitude,g.latitude],h||R.commit("setMapCamera",g)}function E(g){const{object:C,index:n,layer:a}=g;if(n==-1||!C)return null;if(a.id.startsWith("stop-pie-charts-layer")){let l='<div class="map-popup">';const{boardings:p,alightings:v}=C.values;C.values.total=p+v;for(const[b,T]of Object.entries(C.values))l+=`
        <div style="display: flex">
          <div>${b}:&nbsp;&nbsp;</div>
          <b style="margin-left: auto; text-align: right">${T}</b>
        </div>`;return l+="</div>",{html:l,style:{fontSize:"0.8rem",color:S?"#ccc":"#223",backgroundColor:S?"#2a4f4f":"#f4fff4",margin:"2rem 0 0rem 0rem"}}}const i=[{field:"pax",name_en:"Passengers",name_de:"Passagiere"},{field:"departures",name_en:"Departures",name_de:"Abfahrten"},{field:"cap",name_en:"Capacity",name_de:"Kapazit√§t"},{field:"loadfac",name_en:"Load factor",name_de:"Load factor"}];try{let l='<div class="map-popup">';const p=t.features[n].properties;if(p.sort==0)return null;for(const v of i){let b=L=="de"?v.name_de:v.name_en;b=b.replaceAll(" ","&nbsp;"),Number.isFinite(p[v.field])&&(l+=`
            <div style="display: flex">
              <div>${b}:&nbsp;&nbsp;</div>
              <b style="margin-left: auto; text-align: right">${p[v.field]}</b>
            </div>`)}return l+="</div>",{html:l,style:{fontSize:"0.8rem",color:S?"#ccc":"#223",backgroundColor:S?"#2a3c4f":"white",margin:"2rem 0 0rem 0rem"}}}catch{return null}}const M=Pt.DEFAULT,O=[];return O.push(new zt({id:"linkLayer",data:B,getSourcePosition:g=>g.source,getTargetPosition:g=>g.target,getColor:g=>g.color,getWidth:g=>g.width,widthUnits:"pixels",widthScale:_,widthMinPixels:1,widthMaxPixels:100,pickable:!0,coordinateSystem:M,opacity:1,autoHighlight:!1,offsetDirection:at.RIGHT,parameters:{depthTest:!0},transitions:{getColor:200,getWidth:200}})),s.length&&O.push(new Et({id:"selected-links",data:s,getLineColor:Q(S?"#fbff66":"#ccff66"),getLineWidth:1,lineWidthUnits:"pixels",stroked:!0,filled:!1,pickable:!1,coordinateSystem:M,opacity:1,autoHighlight:!1,offsetDirection:at.RIGHT,parameters:{depthTest:!1}})),O.push(new Mt({id:`stop-pie-charts-layer-${d}-${o.length}`,data:k,getPolygon:g=>g.polygon,getFillColor:g=>g.color,stroked:!1,filled:!0,pickable:!0,extruded:!1,opacity:1,sizeScale:1,autoHighlight:!1,parameters:{depthTest:!1}})),et.createElement(Rt,{layers:O,viewState:z,controller:!0,pickingRadius:3,parameters:{blend:!1},getTooltip:E,getCursor:({isDragging:g,isHovering:C})=>g?"grabbing":C?"pointer":"grab",onClick:x,onViewStateChange:g=>A(g.viewState)},w&&et.createElement(It,{mapStyle:R.getters.mapStyle,mapboxApiAccessToken:ut}))}const qt=W({name:"LegendBox",props:{rows:{type:Array,required:!0}},methods:{handleClick(e){this.$emit("item-clicked",e)}}});var Wt=function(){var t=this,s=t._self._c;return t._self._setupProxy,s("div",{staticClass:"legend-container"},[s("p",{staticClass:"control-label"},[t._v("Legend")]),t._l(t.rows,function(r){return s("div",{key:r[0],staticClass:"legend-item",on:{click:function(o){return t.handleClick(r)}}},[s("div",{staticClass:"legend-col-1",style:{"background-color":r[0]}}),s("span",{staticClass:"legend-col-2"},[t._v(t._s(r[1]))])])})],2)},Yt=[],Kt=Y(qt,Wt,Yt,!1,null,"fbd46ee2");const Gt=Kt.exports,Vt=W({name:"RouteDropdown",components:{},props:{source:{type:Object,required:!0},index:{type:Number,required:!0},selectedRoutes:{type:Array,required:!0},searchTerm:{type:String,required:!0},activeTransitLines:{type:Object,required:!0},color:String,cbToggleLineOpen:{type:Function,required:!0},cbToggleLineChecked:{type:Function,required:!0},cbToggleRouteChecked:{type:Function,required:!0}},data(){return{lineCheck:0,isChecked:!1,isOpen:!1,isPartial:!1,checkStates:{},stats:{departures:0,pax:0,loadfac:0}}},mounted(){this.isPartial=!1,this.isChecked=this.line.checked,this.isOpen=this.line.isOpen,this.selectedRoutes.forEach(e=>this.checkStates[e]=!0);for(const e of this.line.transitRoutes)e.departures&&(this.stats.departures+=e.departures),e.pax&&(this.stats.pax+=e.pax),e.loadfac&&(this.stats.loadfac+=e.loadfac);this.stats.loadfac=.001*Math.round(1e3*this.stats.loadfac),this.setRouteCheckmarks()},computed:{lineCheckActive(){return this.lineCheck!==0},line(){return this.source}},watch:{activeTransitLines(){this.line.id in this.activeTransitLines&&(this.stats=this.activeTransitLines[this.line.id].stats)},selectedRoutes(){this.setRouteCheckmarks(),this.selectedRoutes.length||(this.isChecked=!1)}},methods:{setRouteCheckmarks(){let e=0;this.isPartial=!1,this.checkStates={},this.line.transitRoutes.forEach(t=>{this.selectedRoutes.indexOf(t.id)>-1&&(this.checkStates[t.id]=!0,e++)}),this.lineCheck=0,e&&e==this.line.transitRoutes.length&&(this.isChecked=!0,this.lineCheck=2),e&&e<this.line.transitRoutes.length&&(this.lineCheck=1,this.isPartial=!0)},toggleCheck(){this.isChecked=!this.isChecked,this.cbToggleLineChecked({offset:this.line.offset,isChecked:this.isChecked})},toggleOpen(){this.isOpen=!this.isOpen,this.setRouteCheckmarks(),this.cbToggleLineOpen({offset:this.line.offset,isOpen:this.isOpen})},toggleRoute(e){this.cbToggleRouteChecked({route:e,offset:this.line.offset,isChecked:this.checkStates[e]})}}});var Ut=function(){var t=this,s=t._self._c;return t._self._setupProxy,s("div",{staticClass:"route-dropdown flex-col",class:{"is-open":t.isOpen}},[s("div",{staticClass:"title-panel flex-row"},[s("div",{staticClass:"leftside flex-row flex1",on:{click:function(r){return r.preventDefault(),t.toggleCheck.apply(null,arguments)}}},[s("div",{staticClass:"mode-color-strip"}),s("b-checkbox",{staticClass:"fade",class:{faded:t.isPartial},attrs:{size:"is-small"},model:{value:t.lineCheckActive,callback:function(r){t.lineCheckActive=r},expression:"lineCheckActive"}}),s("div",{staticClass:"text-area flex-col"},[t.line.name?s("div",{staticClass:"line-title flex-row"},[t._v(t._s(t.line.name)),s("div",{staticClass:"span",staticStyle:{"font-weight":"normal"}},[t._v("¬†¬†/¬† "+t._s(t.line.id))])]):s("div",{staticClass:"line-title"},[t._v(t._s(t.line.id))]),s("div",{staticClass:"metrics flex-row"},[s("div",{staticClass:"stat"},[t._v(t._s(t.stats.departures)+" deps")]),t.stats.pax?s("div",{staticClass:"stat"},[t._v(t._s(t.stats.pax)+" pax")]):t._e(),t.stats.loadfac?s("div",{staticClass:"stat"},[t._v(t._s(t.stats.loadfac.toFixed(3))+" Lfac")]):t._e()])])],1),s("div",{staticClass:"rightside flex-row"},[s("a",{staticClass:"card-header-icon",on:{click:t.toggleOpen}},[s("b-icon",{staticClass:"icon-reveal",attrs:{size:"is-small",icon:t.isOpen?"menu-down":"menu-up"}})],1)])]),t.isOpen?s("div",{staticClass:"card-details flex-col"},t._l(this.line.transitRoutes,function(r){return s("div",{key:r.id,staticClass:"route flex-row"},[s("div",{staticClass:"stuff flex-col"},[s("b-checkbox",{staticClass:"route-checkbox",attrs:{size:"is-small"},on:{input:function(o){return t.toggleRoute(r.id)}},model:{value:t.checkStates[r.id],callback:function(o){t.$set(t.checkStates,r.id,o)},expression:"checkStates[route.id]"}},[s("div",{staticClass:"route-title"},[t._v(t._s(r.id))])]),s("div",{staticClass:"service-period"},[t._v(t._s(r.firstDeparture)+" ‚Äî "+t._s(r.lastDeparture))]),s("div",{staticClass:"detail flex-row"},[s("div",{staticClass:"deps"},[t._v("Deps: "+t._s(r.departures))]),r.pax?s("div",{staticClass:"deps clink"},[t._v("Pax: "+t._s(r.pax))]):t._e(),r.pax?s("div",{staticClass:"deps clink"},[t._v("Lfac: "+t._s(r.loadfac.toFixed(3)))]):t._e(),r.cap?s("div",{staticClass:"deps clink"},[t._v("Cap: "+t._s(r.cap))]):t._e()])],1)])}),0):t._e()])},Jt=[],Zt=Y(Vt,Ut,Jt,!1,null,"dea5530d");const G=Zt.exports;var ct={exports:{}};/*!
 * vue-virtual-scroll-list v2.3.4
 * open source under the MIT license
 * https://github.com/tangbc/vue-virtual-scroll-list#readme
 */(function(e,t){(function(s,r){e.exports=r(pt)})(ft,function(s){s=s&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s;function r(n,a){var i=Object.keys(n);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(n);a&&(l=l.filter(function(p){return Object.getOwnPropertyDescriptor(n,p).enumerable})),i.push.apply(i,l)}return i}function o(n){for(var a=1;a<arguments.length;a++){var i=arguments[a]!=null?arguments[a]:{};a%2?r(Object(i),!0).forEach(function(l){d(n,l,i[l])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(i)):r(Object(i)).forEach(function(l){Object.defineProperty(n,l,Object.getOwnPropertyDescriptor(i,l))})}return n}function h(n,a){if(!(n instanceof a))throw new TypeError("Cannot call a class as a function")}function c(n,a){for(var i=0;i<a.length;i++){var l=a[i];l.enumerable=l.enumerable||!1,l.configurable=!0,"value"in l&&(l.writable=!0),Object.defineProperty(n,l.key,l)}}function u(n,a,i){return a&&c(n.prototype,a),Object.defineProperty(n,"prototype",{writable:!1}),n}function d(n,a,i){return a in n?Object.defineProperty(n,a,{value:i,enumerable:!0,configurable:!0,writable:!0}):n[a]=i,n}function y(n){return f(n)||m(n)||S(n)||D()}function f(n){if(Array.isArray(n))return L(n)}function m(n){if(typeof Symbol<"u"&&n[Symbol.iterator]!=null||n["@@iterator"]!=null)return Array.from(n)}function S(n,a){if(n){if(typeof n=="string")return L(n,a);var i=Object.prototype.toString.call(n).slice(8,-1);if(i==="Object"&&n.constructor&&(i=n.constructor.name),i==="Map"||i==="Set")return Array.from(n);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return L(n,a)}}function L(n,a){(a==null||a>n.length)&&(a=n.length);for(var i=0,l=new Array(a);i<a;i++)l[i]=n[i];return l}function D(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var _={FRONT:"FRONT",BEHIND:"BEHIND"},w={INIT:"INIT",FIXED:"FIXED",DYNAMIC:"DYNAMIC"},z=0,F=function(){function n(a,i){h(this,n),this.init(a,i)}return u(n,[{key:"init",value:function(i,l){this.param=i,this.callUpdate=l,this.sizes=new Map,this.firstRangeTotalSize=0,this.firstRangeAverageSize=0,this.fixedSizeValue=0,this.calcType=w.INIT,this.offset=0,this.direction="",this.range=Object.create(null),i&&this.checkRange(0,i.keeps-1)}},{key:"destroy",value:function(){this.init(null,null)}},{key:"getRange",value:function(){var i=Object.create(null);return i.start=this.range.start,i.end=this.range.end,i.padFront=this.range.padFront,i.padBehind=this.range.padBehind,i}},{key:"isBehind",value:function(){return this.direction===_.BEHIND}},{key:"isFront",value:function(){return this.direction===_.FRONT}},{key:"getOffset",value:function(i){return(i<1?0:this.getIndexOffset(i))+this.param.slotHeaderSize}},{key:"updateParam",value:function(i,l){var p=this;this.param&&i in this.param&&(i==="uniqueIds"&&this.sizes.forEach(function(v,b){l.includes(b)||p.sizes.delete(b)}),this.param[i]=l)}},{key:"saveSize",value:function(i,l){this.sizes.set(i,l),this.calcType===w.INIT?(this.fixedSizeValue=l,this.calcType=w.FIXED):this.calcType===w.FIXED&&this.fixedSizeValue!==l&&(this.calcType=w.DYNAMIC,delete this.fixedSizeValue),this.calcType!==w.FIXED&&typeof this.firstRangeTotalSize<"u"&&(this.sizes.size<Math.min(this.param.keeps,this.param.uniqueIds.length)?(this.firstRangeTotalSize=y(this.sizes.values()).reduce(function(p,v){return p+v},0),this.firstRangeAverageSize=Math.round(this.firstRangeTotalSize/this.sizes.size)):delete this.firstRangeTotalSize)}},{key:"handleDataSourcesChange",value:function(){var i=this.range.start;this.isFront()?i=i-z:this.isBehind()&&(i=i+z),i=Math.max(i,0),this.updateRange(this.range.start,this.getEndByStart(i))}},{key:"handleSlotSizeChange",value:function(){this.handleDataSourcesChange()}},{key:"handleScroll",value:function(i){this.direction=i<this.offset||i===0?_.FRONT:_.BEHIND,this.offset=i,this.param&&(this.direction===_.FRONT?this.handleFront():this.direction===_.BEHIND&&this.handleBehind())}},{key:"handleFront",value:function(){var i=this.getScrollOvers();if(!(i>this.range.start)){var l=Math.max(i-this.param.buffer,0);this.checkRange(l,this.getEndByStart(l))}}},{key:"handleBehind",value:function(){var i=this.getScrollOvers();i<this.range.start+this.param.buffer||this.checkRange(i,this.getEndByStart(i))}},{key:"getScrollOvers",value:function(){var i=this.offset-this.param.slotHeaderSize;if(i<=0)return 0;if(this.isFixedType())return Math.floor(i/this.fixedSizeValue);for(var l=0,p=0,v=0,b=this.param.uniqueIds.length;l<=b;){if(p=l+Math.floor((b-l)/2),v=this.getIndexOffset(p),v===i)return p;v<i?l=p+1:v>i&&(b=p-1)}return l>0?--l:0}},{key:"getIndexOffset",value:function(i){if(!i)return 0;for(var l=0,p=0,v=0;v<i;v++)p=this.sizes.get(this.param.uniqueIds[v]),l=l+(typeof p=="number"?p:this.getEstimateSize());return l}},{key:"isFixedType",value:function(){return this.calcType===w.FIXED}},{key:"getLastIndex",value:function(){return this.param.uniqueIds.length-1}},{key:"checkRange",value:function(i,l){var p=this.param.keeps,v=this.param.uniqueIds.length;v<=p?(i=0,l=this.getLastIndex()):l-i<p-1&&(i=l-p+1),this.range.start!==i&&this.updateRange(i,l)}},{key:"updateRange",value:function(i,l){this.range.start=i,this.range.end=l,this.range.padFront=this.getPadFront(),this.range.padBehind=this.getPadBehind(),this.callUpdate(this.getRange())}},{key:"getEndByStart",value:function(i){var l=i+this.param.keeps-1,p=Math.min(l,this.getLastIndex());return p}},{key:"getPadFront",value:function(){return this.isFixedType()?this.fixedSizeValue*this.range.start:this.getIndexOffset(this.range.start)}},{key:"getPadBehind",value:function(){var i=this.range.end,l=this.getLastIndex();return this.isFixedType()?(l-i)*this.fixedSizeValue:(l-i)*this.getEstimateSize()}},{key:"getEstimateSize",value:function(){return this.isFixedType()?this.fixedSizeValue:this.firstRangeAverageSize||this.param.estimateSize}}]),n}(),B={dataKey:{type:[String,Function],required:!0},dataSources:{type:Array,required:!0},dataComponent:{type:[Object,Function],required:!0},keeps:{type:Number,default:30},extraProps:{type:Object},estimateSize:{type:Number,default:50},direction:{type:String,default:"vertical"},start:{type:Number,default:0},offset:{type:Number,default:0},topThreshold:{type:Number,default:0},bottomThreshold:{type:Number,default:0},pageMode:{type:Boolean,default:!1},rootTag:{type:String,default:"div"},wrapTag:{type:String,default:"div"},wrapClass:{type:String,default:""},wrapStyle:{type:Object},itemTag:{type:String,default:"div"},itemClass:{type:String,default:""},itemClassAdd:{type:Function},itemStyle:{type:Object},headerTag:{type:String,default:"div"},headerClass:{type:String,default:""},headerStyle:{type:Object},footerTag:{type:String,default:"div"},footerClass:{type:String,default:""},footerStyle:{type:Object},itemScopedSlots:{type:Object}},k={index:{type:Number},event:{type:String},tag:{type:String},horizontal:{type:Boolean},source:{type:Object},component:{type:[Object,Function]},slotComponent:{type:Function},uniqueKey:{type:[String,Number]},extraProps:{type:Object},scopedSlots:{type:Object}},x={event:{type:String},uniqueKey:{type:String},tag:{type:String},horizontal:{type:Boolean}},A={created:function(){this.shapeKey=this.horizontal?"offsetWidth":"offsetHeight"},mounted:function(){var a=this;typeof ResizeObserver<"u"&&(this.resizeObserver=new ResizeObserver(function(){a.dispatchSizeChange()}),this.resizeObserver.observe(this.$el))},updated:function(){this.resizeObserver.observe(this.$el)},beforeDestroy:function(){this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null)},methods:{getCurrentSize:function(){return this.$el?this.$el[this.shapeKey]:0},dispatchSizeChange:function(){this.$parent.$emit(this.event,this.uniqueKey,this.getCurrentSize(),this.hasInitial)}}},E=s.component("virtual-list-item",{mixins:[A],props:k,render:function(a){var i=this.tag,l=this.component,p=this.extraProps,v=p===void 0?{}:p,b=this.index,T=this.source,I=this.scopedSlots,N=I===void 0?{}:I,X=this.uniqueKey,$=this.slotComponent,j=o(o({},v),{},{source:T,index:b});return a(i,{key:X,attrs:{role:"listitem"}},[$?$({item:T,index:b,scope:j}):a(l,{props:j,scopedSlots:N})])}}),M=s.component("virtual-list-slot",{mixins:[A],props:x,render:function(a){var i=this.tag,l=this.uniqueKey;return a(i,{key:l,attrs:{role:l}},this.$slots.default)}}),O={ITEM:"item_resize",SLOT:"slot_resize"},g={HEADER:"thead",FOOTER:"tfoot"},C=s.component("virtual-list",{props:B,data:function(){return{range:null}},watch:{"dataSources.length":function(){this.virtual.updateParam("uniqueIds",this.getUniqueIdFromDataSources()),this.virtual.handleDataSourcesChange()},keeps:function(a){this.virtual.updateParam("keeps",a),this.virtual.handleSlotSizeChange()},start:function(a){this.scrollToIndex(a)},offset:function(a){this.scrollToOffset(a)}},created:function(){this.isHorizontal=this.direction==="horizontal",this.directionKey=this.isHorizontal?"scrollLeft":"scrollTop",this.installVirtual(),this.$on(O.ITEM,this.onItemResized),(this.$slots.header||this.$slots.footer)&&this.$on(O.SLOT,this.onSlotResized)},activated:function(){this.scrollToOffset(this.virtual.offset),this.pageMode&&document.addEventListener("scroll",this.onScroll,{passive:!1})},deactivated:function(){this.pageMode&&document.removeEventListener("scroll",this.onScroll)},mounted:function(){this.start?this.scrollToIndex(this.start):this.offset&&this.scrollToOffset(this.offset),this.pageMode&&(this.updatePageModeFront(),document.addEventListener("scroll",this.onScroll,{passive:!1}))},beforeDestroy:function(){this.virtual.destroy(),this.pageMode&&document.removeEventListener("scroll",this.onScroll)},methods:{getSize:function(a){return this.virtual.sizes.get(a)},getSizes:function(){return this.virtual.sizes.size},getOffset:function(){if(this.pageMode)return document.documentElement[this.directionKey]||document.body[this.directionKey];var a=this.$refs.root;return a?Math.ceil(a[this.directionKey]):0},getClientSize:function(){var a=this.isHorizontal?"clientWidth":"clientHeight";if(this.pageMode)return document.documentElement[a]||document.body[a];var i=this.$refs.root;return i?Math.ceil(i[a]):0},getScrollSize:function(){var a=this.isHorizontal?"scrollWidth":"scrollHeight";if(this.pageMode)return document.documentElement[a]||document.body[a];var i=this.$refs.root;return i?Math.ceil(i[a]):0},scrollToOffset:function(a){if(this.pageMode)document.body[this.directionKey]=a,document.documentElement[this.directionKey]=a;else{var i=this.$refs.root;i&&(i[this.directionKey]=a)}},scrollToIndex:function(a){if(a>=this.dataSources.length-1)this.scrollToBottom();else{var i=this.virtual.getOffset(a);this.scrollToOffset(i)}},scrollToBottom:function(){var a=this,i=this.$refs.shepherd;if(i){var l=i[this.isHorizontal?"offsetLeft":"offsetTop"];this.scrollToOffset(l),setTimeout(function(){a.getOffset()+a.getClientSize()+1<a.getScrollSize()&&a.scrollToBottom()},3)}},updatePageModeFront:function(){var a=this.$refs.root;if(a){var i=a.getBoundingClientRect(),l=a.ownerDocument.defaultView,p=this.isHorizontal?i.left+l.pageXOffset:i.top+l.pageYOffset;this.virtual.updateParam("slotHeaderSize",p)}},reset:function(){this.virtual.destroy(),this.scrollToOffset(0),this.installVirtual()},installVirtual:function(){this.virtual=new F({slotHeaderSize:0,slotFooterSize:0,keeps:this.keeps,estimateSize:this.estimateSize,buffer:Math.round(this.keeps/3),uniqueIds:this.getUniqueIdFromDataSources()},this.onRangeChanged),this.range=this.virtual.getRange()},getUniqueIdFromDataSources:function(){var a=this.dataKey;return this.dataSources.map(function(i){return typeof a=="function"?a(i):i[a]})},onItemResized:function(a,i){this.virtual.saveSize(a,i),this.$emit("resized",a,i)},onSlotResized:function(a,i,l){a===g.HEADER?this.virtual.updateParam("slotHeaderSize",i):a===g.FOOTER&&this.virtual.updateParam("slotFooterSize",i),l&&this.virtual.handleSlotSizeChange()},onRangeChanged:function(a){this.range=a},onScroll:function(a){var i=this.getOffset(),l=this.getClientSize(),p=this.getScrollSize();i<0||i+l>p+1||!p||(this.virtual.handleScroll(i),this.emitEvent(i,l,p,a))},emitEvent:function(a,i,l,p){this.$emit("scroll",p,this.virtual.getRange()),this.virtual.isFront()&&this.dataSources.length&&a-this.topThreshold<=0?this.$emit("totop"):this.virtual.isBehind()&&a+i+this.bottomThreshold>=l&&this.$emit("tobottom")},getRenderSlots:function(a){for(var i=[],l=this.range,p=l.start,v=l.end,b=this.dataSources,T=this.dataKey,I=this.itemClass,N=this.itemTag,X=this.itemStyle,$=this.isHorizontal,j=this.extraProps,K=this.dataComponent,V=this.itemScopedSlots,U=this.$scopedSlots&&this.$scopedSlots.item,P=p;P<=v;P++){var H=b[P];if(H){var q=typeof T=="function"?T(H):H[T];typeof q=="string"||typeof q=="number"?i.push(a(E,{props:{index:P,tag:N,event:O.ITEM,horizontal:$,uniqueKey:q,source:H,extraProps:j,component:K,slotComponent:U,scopedSlots:V},style:X,class:"".concat(I).concat(this.itemClassAdd?" "+this.itemClassAdd(P):"")})):console.warn("Cannot get the data-key '".concat(T,"' from data-sources."))}else console.warn("Cannot get the index '".concat(P,"' from data-sources."))}return i}},render:function(a){var i=this.$slots,l=i.header,p=i.footer,v=this.range,b=v.padFront,T=v.padBehind,I=this.isHorizontal,N=this.pageMode,X=this.rootTag,$=this.wrapTag,j=this.wrapClass,K=this.wrapStyle,V=this.headerTag,U=this.headerClass,P=this.headerStyle,H=this.footerTag,q=this.footerClass,ht=this.footerStyle,tt={padding:I?"0px ".concat(T,"px 0px ").concat(b,"px"):"".concat(b,"px 0px ").concat(T,"px")},dt=K?Object.assign({},K,tt):tt;return a(X,{ref:"root",on:{"&scroll":!N&&this.onScroll}},[l?a(M,{class:U,style:P,props:{tag:V,event:O.SLOT,uniqueKey:g.HEADER}},l):null,a($,{class:j,attrs:{role:"group"},style:dt},this.getRenderSlots(a)),p?a(M,{class:q,style:ht,props:{tag:H,event:O.SLOT,uniqueKey:g.FOOTER}},p):null,a("div",{ref:"shepherd",style:{width:I?"0px":"100%",height:I?"100%":"0px"}})])}});return C})})(ct);var Qt=ct.exports;const te=mt(Qt),ee=W({name:"RouteDropdown",components:{RouteDropDown:G,VirtualList:te},props:{highlightedTransitLines:{type:Array,required:!0},listProps:{type:Object,required:!0}},data(){return{listComponent:G}},watch:{"listProps.activeTransitLines"(){}},computed:{visibleLines(){return this.highlightedTransitLines.map((e,t)=>(e.offset=t,e)).filter(e=>e.show)}}});var se=function(){var t=this,s=t._self._c;return t._self._setupProxy,s("virtual-list",{staticClass:"my-list",attrs:{"data-sources":t.visibleLines,"data-key":"id","data-component":t.listComponent,keeps:48,"estimate-size":48,"extra-props":t.listProps}})},ie=[],re=Y(ee,se,ie,!1,null,"b40e4d1c");const ae=re.exports,oe="/simwrapper/assets/icon-pie-chart-BS7BHQ_l.png",ne="/simwrapper/assets/icon-blue-ramp-D1d4h-6x.png",le={messages:{en:{metrics:"Metrics",viewer:"Transit Network"},de:{metrics:"Metrics",viewer:"√ñV Netzwerk"}}},ce="EPSG:31468",nt=[{match:{gtfsRouteType:[3,700,701,702,703,704]},color:"#95276E",label:"Bus (GTFS)"},{match:{gtfsRouteType:[109]},color:"#408335",label:"S-Bahn (GTFS)"},{match:{gtfsRouteType:[401,402]},color:"#115D91",label:"U-Bahn (GTFS)"},{match:{gtfsRouteType:[0,3,900,901,902,903,904,905,906]},color:"#BE1414",label:"Tram (GTFS)"},{match:{gtfsRouteType:[4,1e3,1200]},color:"#0480c1",label:"Ferry (GTFS)"},{match:{transportMode:["rail","subway"],id:"U*"},color:"#115D91",label:"U-Bahn"},{match:{transportMode:"rail",id:"S*"},color:"#408335",label:"S-Bahn"},{match:{transportMode:"ferry"},color:"#0480c1",label:"Ferry"},{match:{transportMode:"tram"},color:"#9E1444",label:"Tram"},{match:{transportMode:"pt"},color:"#05c",label:"Public Transport"},{match:{transportMode:"rail"},color:"#EC0016 ",label:"Train"},{match:{transportMode:"train"},color:"#0a0",label:"Rail"},{match:{transportMode:"bus"},color:"#95276E",label:"Bus"},{match:{id:"**"},color:"#aae",label:"Other"}],he=W({name:"TransitViewer",i18n:le,components:{CollapsiblePanel:Tt,DrawingTool:Ot,LeftDataPanel:Bt,LegendBox:Gt,RouteDropDown:G,TransitLayers:Xt,ZoomButtons:Dt,LazyList:ae},props:{root:{type:String,required:!0},subfolder:{type:String,required:!0},yamlConfig:String,config:{type:Object},thumbnail:Boolean,datamanager:{type:Object}},data(){const e=[{field:"departures",name_en:"Departures",name_de:"Abfahrten"}];return{viewId:Math.floor(1e12*Math.random()),icons:{piechart:oe,blueramp:ne},loadProgress:0,loadSteps:0,totalLoadSteps:7,searchText:"",isAtlantis:!1,isDraggingDivider:0,dragStartWidth:250,legendSectionWidth:275,stopHTML:{html:"",x:0,y:0},buttonColors:["#5E8AAE","#BF7230","#269367","#9C439C"],metrics:e,activeMetric:e[0].field,activeRoutes:[],checkedTransitLines:[],vizDetails:{transitSchedule:"",network:"",demand:"",ptStop2stopFile:"",projection:"",title:"",description:"",colors:[]},myDataManager:this.datamanager||new St(this.root,this.subfolder),debounceHandleSearchText:{},myState:{subfolder:"",yamlConfig:"",thumbnail:!0},avroNetwork:null,isDarkMode:R.state.isDarkMode,isMapMoving:!1,isHighlightingLink:!1,loadingText:"MATSim Transit Inspector",networkOptions:[],projection:ce,routesOnLink:[],selectedLinkId:"",selectedRouteIds:[],selectedTransitLine:"",selectedFeatures:[],summaryStats:{departures:0,pax:0,loadfac:0},stopMarkers:[],_departures:{},_mapExtentXYXY:null,_maximum:-1/0,_network:{},transitLinks:{type:"FeatureCollection",features:[]},transitLinkOffset:{},routeData:{},_stopFacilities:{},transitLines:[],highlightedTransitLineIds:new Set,_roadFetcher:{},_transitFetcher:{},_transitHelper:{},pieSlider:20,widthSlider:20,resolvers:{},resolverId:0,xmlWorker:null,crossFilters:[],stopLevelDemand:{},routeColors:[],usedLabels:[],listComponent:G}},computed:{fileApi(){return new wt(this.fileSystem,R)},fileSystem(){const e=this.$store.state.svnProjects.filter(t=>t.slug===this.root);if(e.length===0)throw console.log("no such project"),Error;return e[0]},routeListProps(){return{activeTransitLines:this.activeTransitLines,selectedRoutes:this.selectedRouteIds,searchTerm:this.searchTermClean,color:"#06f",cbToggleLineChecked:this.toggleLineChecked,cbToggleLineOpen:this.toggleLineOpen,cbToggleRouteChecked:this.toggleRouteChecked}},searchTermClean(){return this.searchText.trim().toLocaleLowerCase()},highlightedTransitLines(){const e=!this.highlightedTransitLineIds.size;return this.transitLines.forEach(t=>{t.show=e||this.highlightedTransitLineIds.has(t.id)}),[...this.transitLines]},activeTransitLines(){const e={};this.routesOnLink.forEach(s=>{s.lineId in e||(e[s.lineId]={id:s.lineId,routes:[],isOpen:!1,stats:{departures:0,pax:0,cap:0}}),e[s.lineId].routes.push(s)});const t={};return this.crossFilters.forEach(s=>{s.cfDemandStop.filterAll(),s.cfDemandLink.filter(o=>o.indexOf(this.selectedLinkId)>-1);let r=s.cfDemand.allFiltered();r&&r.forEach(o=>{o.transitRoute in t||(t[o.transitRoute]=[]),t[o.transitRoute].push(o)})}),Object.values(e).forEach(s=>{s.routes.sort((r,o)=>it(r.id,o.id)),s.routes.forEach(r=>{r.pax=0,r.cap=0,s.stats.departures+=r.departures;const o=t[r.id];if(o){const h=o.reduce((u,d)=>u+d.passengersAtArrival,0);s.stats.pax+=h,r.pax+=h;const c=o.reduce((u,d)=>u+d.totalVehicleCapacity,0);s.stats.cap+=c,r.cap+=c}r.loadfac=r.pax/r.cap})}),e},legendRows(){return this.routeColors.filter(e=>this.usedLabels.includes(e.label)).map(e=>[e.color,e.label])}},watch:{"$store.state.viewState"(){Z[this.viewId]&&Z[this.viewId]()},"$store.state.colorScheme"(){this.isDarkMode=this.$store.state.colorScheme===gt.DarkMode,this.highlightAllAttachedRoutes()},selectedRouteIds(){this.showTransitRoutes(),this.showTransitStops(),this.updateSummaryStats()},searchText(){this.debounceHandleSearchText()}},methods:{async selectNetwork(e){console.log(e),this.vizDetails.network=e,this.networkOptions=[],await this.findInputFiles(),await this.loadEverything()},clickedLegend(e){console.log("boop!",e)},toggleRouteChecked(e){e.isChecked?this.routesOnLink.push(this.routeData[e.route]):this.routesOnLink=this.routesOnLink.filter(t=>t.id!==e.route),this.routesOnLink.length?this.highlightAllAttachedRoutes():(this.selectedLinkId="",this.resetLinkColors(),this.highlightedTransitLineIds=new Set,this.transitLinks={...this.transitLinks}),this.selectedRouteIds=this.routesOnLink.map(t=>t.id)},toggleLineOpen(e){const t=this.transitLines[e.offset];t.isOpen=e.isOpen},toggleLineChecked(e){const t=this.transitLines[e.offset],s=t.id.toLocaleLowerCase();t.check=e.isChecked;const r=Object.values(this.routeData).filter(o=>o.lineId.toLocaleLowerCase()==s);if(t.check)r.forEach(o=>{this.selectedRouteIds.includes(o.id)||this.routesOnLink.push(o)}),this.selectedTransitLine=t.id;else{const o=r.map(h=>h.id);this.routesOnLink=this.routesOnLink.filter(h=>!o.includes(h.id))}this.selectedRouteIds=this.routesOnLink.map(o=>o.id),this.routesOnLink.length?this.highlightAllAttachedRoutes():(this.selectedLinkId="",this.resetLinkColors(),this.highlightedTransitLineIds=new Set,this.transitLinks={...this.transitLinks})},updateSummaryStats(){this.summaryStats={departures:0,pax:0,loadfac:0};for(const e of this.selectedRouteIds){const t=this.routeData[e];t.departures&&(this.summaryStats.departures+=t.departures),t.pax&&(this.summaryStats.pax+=t.pax)}},handleMapClick(e){if(e.index>-1&&e.layer?.id==="linkLayer")this.clickedOnTransitLink(e.index);else{if(e.index>-1)return;this.handleEmptyClick(!0,!1)}},incrementLoadProgress(){this.loadSteps+=1,this.loadProgress=100*this.loadSteps/this.totalLoadSteps},handleSearchText(){this.handleEmptyClick(null,!0),this.selectedLinkId="";const e=this.searchText.trim().toLocaleLowerCase();if(!e){this.resetLinkColors();return}let t=[],s=[],r;if(e.startsWith("/")&&e.endsWith("/")){const o=this.searchText.slice(1,this.searchText.length-1);r=new RegExp(o,"gu")}r?(t=Object.keys(this.routeData).filter(o=>o.match(r)),s=this.transitLines.filter(o=>o.id.match(r)).map(o=>o.id)):(t=Object.keys(this.routeData).filter(o=>o.toLocaleLowerCase().indexOf(e)>-1),s=this.transitLines.filter(o=>o.id.toLocaleLowerCase().indexOf(e)>-1).map(o=>o.id)),this.routesOnLink=t.map(o=>this.routeData[o]),this.highlightAllAttachedRoutes(),this.highlightedTransitLineIds=new Set(s),this.selectedRouteIds=this.routesOnLink.map(o=>o.id)},hoverOverStop(e,t){this.stopHTML.html="";const s=[];e.name&&s.push(`<b>${e.name}</b>`);for(const r of["id","linkRefId"])e[r]&&s.push(`${r}: ${e[r]}`);this.stopHTML.html="<p>"+s.join("<br/>")+"</p>",this.stopHTML.x=e.xy.x+8,this.stopHTML.y=e.xy.y-36},dividerDragStart(e){console.log("dragstart"),this.isDraggingDivider=e.clientX,this.dragStartWidth=this.legendSectionWidth},dividerDragEnd(e){this.isDraggingDivider=0},dividerDragging(e){if(!this.isDraggingDivider)return;const t=this.isDraggingDivider-e.clientX;this.legendSectionWidth=Math.max(0,this.dragStartWidth+t)},async getVizDetails(){if(this.config)return this.vizDetails=Object.assign({},this.config),!0;if(this.myState.yamlConfig?.endsWith("yaml")||this.myState.yamlConfig?.endsWith("yml"))return this.loadYamlConfig();const e=this.myState.yamlConfig;return this.vizDetails={transitSchedule:this.myState.yamlConfig,network:"",title:e,description:"",demand:"",ptStop2stopFile:"",projection:"",colors:[]},this.$emit("title",e),!0},async findInputFiles(){const{files:e}=await this.fileApi.getDirectory(this.myState.subfolder);let t=this.vizDetails.network;if(!t){const r=e.filter(o=>o.toLocaleLowerCase().endsWith(".avro")).filter(o=>o.toLocaleLowerCase().indexOf("network")>-1);r.length&&(console.log("avro network found"),t=r[0]),r.length>1&&console.warn("MULTIPLE Avro files found - using first of ",r)}if(!t&&this.myState.yamlConfig.indexOf("transitSchedule")>-1&&(t=this.myState.yamlConfig.replaceAll("transitSchedule","network")),e.indexOf(t)==-1){const r=e.filter(h=>h.toLocaleLowerCase().match(/(\.xml|\.gz)$/)),o=[];if(await Promise.all(r.map(async h=>{const c=`${this.myState.subfolder}/${h}`;await this.fileApi.probeXmlFileType(c)==="network"&&o.push(h)})),console.log("all networks",o),o.length==1)t=o[0];else{this.loadingText="Choose network file:",t="",this.networkOptions=o;return}}let s=[];if(this.myState.yamlConfig.indexOf("output_transitSchedule")>-1)try{s=(await this.fileApi.getDirectory(`${this.myState.subfolder}/analysis/pt/`)).files.filter(o=>o.includes("pt_pax_volumes."))}catch{console.log("no transit demand file: pt_pax_volumes")}this.vizDetails.network=t,s.length&&(this.vizDetails.demand=`analysis/pt/${s[0]}`)},async guessProjection(e){if(this.vizDetails.projection)return this.vizDetails.projection;if(this.config?.projection)return this.config.projection;if(e?.roadXML?.crs)return e?.roadXML?.crs;if(e?.roadXML?.network?.attributes?.attribute?.name==="coordinateReferenceSystem")return e?.roadXML?.network?.attributes?.attribute["#text"];const t=/EPSG:.\d/,{files:s}=await this.fileApi.getDirectory(this.myState.subfolder),r=s.filter(c=>c.indexOf(".output_config.xml")>-1||c.indexOf(".output_config_reduced.xml")>-1);if(r.length&&this.fileSystem)for(const c of r)try{return(await this.fetchXML({worker:null,slug:this.fileSystem.slug,filePath:this.myState.subfolder+"/"+c})).config.module.filter(m=>m.$name==="global")[0].param.filter(m=>m.$name==="coordinateSystem")[0].$value}catch{console.warn("Failed parsing",c)}let o=prompt("Need coordinate EPSG number:","")||"";return o?Number.isNaN(parseInt(o,10))&&!t.test(o)?this.guessProjection(e):(o.startsWith("EPSG:")||(o="EPSG:"+o),o):""},async loadYamlConfig(){const e=this.myState.yamlConfig.indexOf("/")>-1?this.myState.yamlConfig:this.myState.subfolder+"/"+this.myState.yamlConfig;try{const s=await this.fileApi.getFileText(e);this.vizDetails=_t.parse(s)}catch(s){const r=s;if(this.fileSystem&&this.fileSystem.needPassword&&r.status===401)this.$store.commit("requestLogin",this.fileSystem.slug);else{const o="Could not load "+e;this.$emit("error",o),this.loadingText=o}return!1}const t=this.vizDetails.title?this.vizDetails.title:"Transit Ridership";return this.$emit("title",t),this.projection=this.vizDetails.projection,!0},isMobile(){const e=window,t=document,s=t.documentElement,r=t.getElementsByTagName("body")[0],o=e.innerWidth||s.clientWidth||r.clientWidth;return e.innerHeight||s.clientHeight||r.clientHeight,o<640},drawMetric(){this.transitLinks.features.forEach(e=>{let t=1;switch(this.activeMetric){case"departures":t=e.properties.departures;break;case"pax":t=e.properties.pax;break;case"loadfac":t=e.properties.loadfac*1e4;break}e.properties.width=t}),this.transitLinks={...this.transitLinks}},handleClickedMetric(e){console.log("metric:",e.field),this.activeMetric=e.field,this.drawMetric()},handleEmptyClick(e,t){if(!e&&this.isHighlightingLink){this.isHighlightingLink=!1;return}this.isHighlightingLink=!1,this.highlightedTransitLineIds=new Set,t||(this.searchText=""),!(this.searchText&&!t)&&(this.removeStopMarkers(),this.removeSelectedRoute(),this.resetLinkColors(),this.routesOnLink=[],this.stopHTML.html="",this.summaryStats={departures:0,pax:0,loadfac:0},this.transitLinks={...this.transitLinks})},async loadEverything(){const e=await this.loadNetworks();if(!e)return;const t=await this.guessProjection(e);this.projection=t,this.processInputs(e)},setupKeyListeners(){window.addEventListener("keyup",e=>{e.keyCode===27&&this.pressedEscape()}),window.addEventListener("keydown",e=>{e.keyCode===38&&this.pressedArrowKey(-1),e.keyCode===40&&this.pressedArrowKey(1)})},fetchXML(e){let t=e.worker;t.onmessage=o=>{const{resolve:h,reject:c}=this.resolvers[o.data.id];t.terminate(),o.data.error&&c(o.data.error),h(o.data.xml)};const s=this.resolverId++;return t.postMessage({id:s,fileSystem:this.fileSystem,filePath:e.filePath,options:e.options}),new Promise((o,h)=>{this.resolvers[s]={resolve:o,reject:h}})},async updateStatus(e){this.loadingText=e},async loadAvroRoadNetwork(){console.log("LOADING AVRO:",this.vizDetails.network);const e=`${this.subfolder}/${this.vizDetails.network}`,t=await this.fileApi.getFileBlob(e),s=await new Promise((r,o)=>{const h=[];kt.createBlobDecoder(t).on("metadata",c=>{}).on("data",c=>{h.push(c)}).on("end",()=>{r(h)})});return this.avroNetwork=s[0],s[0]},async loadNetworks(){try{if(!this.fileSystem||!this.vizDetails.network||!this.vizDetails.transitSchedule)return;this.loadingText="Loading networks...",this.incrementLoadProgress();const e=this.vizDetails.network,t=await this.myDataManager.getRoadNetwork(e,this.subfolder,this.vizDetails,this.updateStatus);this.isAtlantis=!!t.isAtlantis,this.avroNetwork=t;const s=this.fetchXML({worker:this._transitFetcher,slug:this.fileSystem.slug,filePath:this.myState.subfolder+"/"+this.vizDetails.transitSchedule,options:{attributeNamePrefix:"",alwaysArray:["transitSchedule.transitLine.transitRoute","transitSchedule.transitLine.transitRoute.departures.departure"]}}),r=await Promise.all([t,s]);return{roadXML:r[0],transitXML:r[1],ridership:[]}}catch(e){return console.error("TRANSIT:",e),this.loadingText="",this.$emit("error",""+e),null}},loadDemandData(e){return this.totalLoadSteps+=3,this.loadingText="Loading demand...",new Promise((s,r)=>{e||s([]),this.incrementLoadProgress();const o=new Ft;o.onmessage=h=>{if(this.loadingText="Processing demand...",this.incrementLoadProgress(),o.terminate(),h.data.error){this.$emit("error",h.data.error),this.loadingText="";return}const c=1e8;let u=0,d=new Uint8Array(h.data);const y=new TextDecoder("utf-8"),f=y.decode(d.subarray(0,1024)).split(`
`)[0];for(;u<h.data.byteLength;){let m=u+c,S=new Uint8Array(h.data).subarray(u,m),L=S.length;for(;S[L]!==10&&L>0;)L--;if(!L)break;S=new Uint8Array(h.data).subarray(u,u+L);let D=y.decode(S);u>0&&(D=f+D);const _=Ct.parse(D,{header:!0,skipEmptyLines:!0,dynamicTyping:!1});this.processDemand(_),u+=L}this.metrics=this.metrics.concat([{field:"pax",name_en:"Passengers",name_de:"Passagiere"},{field:"loadfac",name_en:"Load Factor",name_de:"Auslastung"}]),this.loadProgress=100,this.transitLinks.features.forEach(m=>{try{m.properties.loadfac=Math.round(1e3*m.properties.pax/m.properties.cap)/1e3}catch{m.properties.loadfac=0}}),s([])},o.postMessage({filePath:this.myState.subfolder+"/"+e,fileSystem:this.fileSystem})})},processDemand(e){this.loadingText="Summarizing demand data...",this.incrementLoadProgress();const t=["passengersAlighting","passengersAtArrival","passengersBoarding","stopSequence","totalVehicleCapacity"];e.data.forEach(c=>{for(const u of t)c[u]=parseFloat(c[u])});const s=bt(e.data);this.crossFilters.push({cfDemand:s,cfDemandLink:s.dimension(c=>c.linkIdsSincePreviousStop),cfDemandStop:s.dimension(c=>c.stop)});for(const c of e.data){const u=c.stop;this.stopLevelDemand[u]||(this.stopLevelDemand[u]={b:0,a:0,ptLines:{}}),this.stopLevelDemand[u].b+=c.passengersBoarding,this.stopLevelDemand[u].a+=c.passengersAlighting;const d=c.transitLine;this.stopLevelDemand[u].ptLines[d]||(this.stopLevelDemand[u].ptLines[d]={name:d,b:0,a:0}),this.stopLevelDemand[u].ptLines[d].a+=c.passengersAlighting,this.stopLevelDemand[u].ptLines[d].b+=c.passengersBoarding}console.log("---Calculating link-by-link pax/cap");const r={},o={};let h=",";e.data.length&&(h=e.data[0].linkIdsSincePreviousStop.indexOf(",")>-1?",":";");for(const c of e.data)if(c.linkIdsSincePreviousStop){const u=c.linkIdsSincePreviousStop.split(h);for(const d of u)r[d]||(r[d]=0),r[d]+=c.passengersAtArrival,o[d]||(o[d]=0),o[d]+=c.totalVehicleCapacity}for(const c of this.transitLinks.features)c.properties||(c.properties={pax:0,cap:0,loadfac:0}),c.properties.pax=(c.properties.pax||0)+(r[c.properties.id]||0),c.properties.cap=(c.properties.cap||0)+(o[c.properties.id]||0);return[]},async processInputs(e){this.loadingText="Examining networks...",this.incrementLoadProgress(),this._transitHelper=new ot,this._transitHelper.onmessage=s=>{this.receivedProcessedTransit(s)};let t=this.vizDetails.projection;if(!t)try{let s=e?.transitXML?.transitSchedule?.attributes?.attribute;s.length||(s=[s]),s=s.filter(r=>r.name==="coordinateReferenceSystem"),s.length?t=s[0]["#text"]:t=this.projection}catch{t=this.projection}console.log("Transit schedule using",t),this._transitHelper.postMessage({xml:e,projection:t})},async receivedProcessedTransit(e){if(e.data.status){this.loadingText=e.data.status,this.incrementLoadProgress();return}if(e.data.error){console.error(e.data.error),this.$emit("error",""+e.data.error),this.loadingText="";return}const{network:t,routeData:s,stopFacilities:r,transitLines:o,mapExtent:h}=e.data;this._network=t,this.routeData=s,this._stopFacilities=r,this.transitLines=Array.isArray(o)?o:[o],this._mapExtentXYXY=h,this._transitHelper.terminate(),this.loadingText="Summarizing departures...",this.incrementLoadProgress();const c=this.vizDetails.customRouteTypes||this.vizDetails.colors||null;c&&Array.isArray(c)&&c.length>0?this.routeColors=c:c&&!Array.isArray(c)?(this.$emit("error","YAML colors must be a list of rules, see docs"),this.routeColors=nt):this.routeColors=nt,await this.processDepartures();try{this.transitLinks=await this.constructDepartureFrequencyGeoJson()}catch(S){const L=""+S||"Failed processing departure links";this.$emit("error",L)}this._network={links:{},nodes:{}},this.transitLinkOffset={},this.transitLinks.features.forEach((S,L)=>{this.transitLinkOffset[S.properties.id]=L}),this.drawMetric(),this.handleClickedMetric({field:"departures"});const u=.5*(this._mapExtentXYXY[0]+this._mapExtentXYXY[2]),d=.5*(this._mapExtentXYXY[1]+this._mapExtentXYXY[3]),y=Math.abs(this._mapExtentXYXY[0]-this._mapExtentXYXY[2]),f=y?Math.floor(Math.log2(360/y)):9;this.$store.commit("setMapCamera",{longitude:u,latitude:d,zoom:f,bearing:0,pitch:0,initial:!0}),localStorage.setItem(this.$route.fullPath+"-bounds",JSON.stringify(this._mapExtentXYXY));const m=this.vizDetails.demand||this.vizDetails.ptStop2stopFile;m&&await this.loadDemandData(m),this.loadingText=""},async processDepartures(){this.loadingText="Processing departures...",this.incrementLoadProgress();for(const e of this.transitLines){e.transitRoutes.sort((t,s)=>it(t.id,s.id));for(const t of e.transitRoutes)for(const s of t.route)s in this._departures||(this._departures[s]={total:0,routes:new Set}),this._departures[s].total+=t.departures,this._departures[s].routes.add(t.id)}Object.values(this._departures).forEach(e=>this._maximum=Math.max(this._maximum,e.total))},async constructDepartureFrequencyGeoJson(){const e=[];this.usedLabels=[];const t=this.avroNetwork?.nodeCoordinates;for(const s in this._departures)if(this._departures.hasOwnProperty(s)){const r=this._network.links[s];if(r==null)continue;let o;try{if(this.avroNetwork){const f=2*this.avroNetwork.from[r],m=2*this.avroNetwork.to[r];o=[[t[f],t[1+f]],[t[m],t[1+m]]]}else o=[[this._network.nodes[r.from].x,this._network.nodes[r.from].y],[this._network.nodes[r.to].x,this._network.nodes[r.to].y]]}catch(f){console.warn(""+f);continue}const h=this._departures[s].total,u=[...this._departures[s].routes][0],{color:d,hideThisLine:y}=this.determineRouteColor(u);if(!y){let f={type:"Feature",geometry:{type:"LineString",coordinates:o},properties:{...this.$props,color:d,departures:h,id:s,from:r.from,to:r.to,currentColor:d}};f=this.offsetLineByMeters(f,5),e.push(f)}}if(!e.length)throw Error("No links found. Does the network contain PT links?");return{type:"FeatureCollection",features:e}},determineRouteColor(e){let t="#888",s=!1;const r=this.routeData[e];for(const h of this.routeColors){s=!1,h.hide&&(s=!0);let c=!0,u=h.match;try{if(Array.isArray(u)){const d={};for(const y of u){const[f,m]=Object.entries(y)[0];d[f]=m}u=d}}catch{console.warn("Match rules malformed",u)}for(const[d,y]of Object.entries(u)){const f=r[d];if(!f){c=!1;break}if(d==="gtfsRouteType"){if(Array.isArray(y)){if(!y.includes(f)){c=!1;break}}else if(f!==y){c=!1;break}}else if(!xt.isMatch(f,y)){c=!1;break}}if(c){t=h.color,!this.usedLabels.includes(h.label)&&!s&&this.usedLabels.push(h.label);break}}t=="#888"&&console.log("OHE NOES",e);const o=Array.isArray(t)?t:this.colorToRGB(t);return r.color=o,{color:o,hideThisLine:s}},colorToRGB(e){try{const t=lt(e);return t?[t.r,t.g,t.b]:[0,0,0]}catch{return[0,0,0]}},offsetLineByMeters(e,t){try{return yt(e,t,{units:"meters"})}catch{}return e},removeStopMarkers(){this.stopMarkers=[],this.stopHTML.html=""},XXtoggleTransitLine(e){e.isOpen=!e.isOpen,e.isOpen?(this.selectedTransitLine=e.id,this.selectAllRoutesInLine(e)):(this.selectedTransitLine="",this.removeStopMarkers(),this.removeSelectedRoute()),this.$forceUpdate()},selectAllRoutesInLine(e){const t=e.routes.map(s=>s.id);this.selectedRouteIds=t,this.showTransitRoutes(),this.showTransitStops()},showRouteDetails(e,t){if(t>1&&this.selectedRouteIds.length==t)this.selectedRouteIds=[e];else{const s=new Set(this.selectedRouteIds);s.has(e)?s.delete(e):s.add(e),this.selectedRouteIds=[...s]}this.showTransitRoutes(),this.showTransitStops()},showTransitStops(){const e={};this.selectedRouteIds.forEach(t=>{const s=this.routeData[t],r=s.routeProfile,o=r.length;let h;for(const[c,u]of r.entries()){const d=this._stopFacilities[u.refId],y=st([d.x,d.y]);if(c<o-1){const m=this._stopFacilities[s.routeProfile[c+1].refId],S=st([m.x,m.y]);h=vt(y,S)}const f={i:c,bearing:h,xy:[d.x,d.y],name:d.name||"",id:u.refId||"",linkRefId:d.linkRefId||""};if(this.stopLevelDemand){const m=this.stopLevelDemand[u.refId];m&&(f.boardings=m.b,f.alightings=m.a,f.ptLines=m.ptLines)}f.id in e?(e[f.id].boardings=f.boardings,e[f.id].alightings=f.alightings):e[f.id]=f}}),this.stopMarkers=Object.values(e)},showTransitRoutes(){this.stopHTML.html="";const e=[];this.selectedRouteIds.forEach(t=>{const s=this.routeData[t];e.push(s.geojson)}),this.selectedFeatures=e},removeSelectedRoute(){this.selectedFeatures=[],this.selectedRouteIds=[]},clickedOnTransitLink(e){this.isHighlightingLink=!0,this.removeStopMarkers(),this.removeSelectedRoute();const t=this.transitLinks.features[e].properties;this.selectedLinkId=t.id;const s=this._departures[t.id].routes;let r={departures:0,pax:0,loadfac:0};const o=this.transitLinks[this.transitLinkOffset[t.id]];this.summaryStats=o?o.properties:r;const h=[],c=new Set;for(const u of s){const d=this.routeData[u];d.color=t.color,d.currentColor=t.color,h.push(d),c.add(d.lineId)}this.routesOnLink=h,this.highlightAllAttachedRoutes(),this.selectedRouteIds=this.routesOnLink.map(u=>u.id),this.highlightedTransitLineIds=c},resetLinkColors(e){if(e)for(const t of this.transitLinks.features)t.properties.currentColor=e,t.properties.sort=0;else for(const t of this.transitLinks.features)t.properties.currentColor=t.properties.color,t.properties.sort=1},highlightAllAttachedRoutes(){if(this.transitLinks){if(this.routesOnLink.length){const e=this.colorToRGB(this.isDarkMode?"#333344":"#ccccdd");this.resetLinkColors(e)}else this.resetLinkColors();for(const e of this.routesOnLink)for(const t of e.route){const s=this.transitLinkOffset[t],r=this.transitLinks.features[s];r.properties.currentColor=e.color||r.properties.color,r.properties.sort=5}if(this.selectedLinkId){const e=this.transitLinks.features[this.transitLinkOffset[this.selectedLinkId]];e.properties.currentColor=this.colorToRGB("#f4f"),e.properties.sort=5}this.transitLinks={...this.transitLinks}}},pressedEscape(){console.log("ESC"),this.removeSelectedRoute(),this.removeStopMarkers(),this.resetLinkColors(),this.routesOnLink=[]},pressedArrowKey(e){},clearData(){this._departures={},this._mapExtentXYXY=[180,90,-180,-90],this._maximum=0,this._network={nodes:{},links:{}},this.routeData={},this._stopFacilities={},this.transitLinks={type:"FeatureCollection",features:[]},this.transitLines=[],this.selectedRouteIds=[],this.resolvers={},this.routesOnLink=[],this.stopMarkers=[],this.searchText="",this.crossFilters.forEach(e=>{e.cfDemandLink.dispose(),e.cfDemandStop.dispose(),e.cfDemand=null})}},async mounted(){this.$store.commit("setFullScreen",!this.thumbnail),this.debounceHandleSearchText=Lt.debounce(this.handleSearchText,350),this.clearData(),this._roadFetcher=new rt,this._transitFetcher=new rt,this._transitHelper=new ot,this.myState.subfolder=this.subfolder,this.myState.yamlConfig=this.yamlConfig??"",this.myState.thumbnail=this.thumbnail,await this.getVizDetails()&&(this.thumbnail||(this.vizDetails.network||await this.findInputFiles(),this.loadEverything()))},beforeDestroy(){this.clearData(),this.xmlWorker&&this.xmlWorker.terminate(),this._roadFetcher&&this._roadFetcher.terminate(),this._transitFetcher&&this._transitFetcher.terminate(),this._transitHelper&&this._transitHelper.terminate(),this.$store.commit("setFullScreen",!1)}});var de=function(){var t=this,s=t._self._c;return t._self._setupProxy,s("div",{staticClass:"transit-viz",class:{"hide-thumbnail":!t.thumbnail},attrs:{id:"transit-viz"}},[t.thumbnail?t._e():s("div",{staticClass:"main-layout",on:{mousemove:t.dividerDragging,mouseup:t.dividerDragEnd}},[s("div",{staticClass:"dragger",on:{mousedown:t.dividerDragStart,mouseup:t.dividerDragEnd,mousemove:function(r){return r.stopPropagation(),t.dividerDragging.apply(null,arguments)}}}),s("div",{staticClass:"map-container",class:{"hide-thumbnail":!t.thumbnail},attrs:{oncontextmenu:"return false"}},[t.transitLinks?.features.length?s("transit-layers",{staticClass:"map-styles",attrs:{viewId:t.viewId,links:t.transitLinks,selectedFeatures:t.selectedFeatures,stopMarkers:t.stopMarkers,handleClickEvent:t.handleMapClick,pieSlider:t.pieSlider,widthSlider:t.widthSlider,transitLines:t.activeTransitLines,vizDetails:t.vizDetails,isAtlantis:t.isAtlantis}}):t._e(),t.transitLines.length?s("div",{staticClass:"width-sliders flex-row",style:{backgroundColor:t.isDarkMode?"#00000099":"#ffffffaa"}},[s("img",{staticClass:"icon-blue-ramp",attrs:{src:t.icons.blueramp}}),s("b-slider",{staticClass:"pie-slider",attrs:{type:"is-success",tooltip:!1,size:"is-small"},model:{value:t.widthSlider,callback:function(r){t.widthSlider=r},expression:"widthSlider"}}),t.crossFilters.length?s("img",{staticClass:"icon-pie-slider",attrs:{src:t.icons.piechart}}):t._e(),t.crossFilters.length?s("b-slider",{staticClass:"pie-slider",attrs:{type:"is-success",tooltip:!1,size:"is-small"},model:{value:t.pieSlider,callback:function(r){t.pieSlider=r},expression:"pieSlider"}}):t._e()],1):t._e(),s("zoom-buttons"),t.loadingText?s("div",{staticClass:"status-corner flex-col",style:{height:t.networkOptions.length?"15rem":"5rem"}},[s("p",[t._v(t._s(t.loadingText))]),t.loadProgress>0?s("b-progress",{staticClass:"load-progress",attrs:{value:t.loadProgress,rounded:!1,type:"is-success"}}):t._e(),t.networkOptions.length?s("div",{staticClass:"network-options flex-col"},t._l(t.networkOptions,function(r){return s("b-button",{key:r,staticClass:"xbutton is-small center",attrs:{expanded:""},on:{click:function(o){return t.selectNetwork(r)}}},[t._v(" "+t._s(r))])}),1):t._e()],1):t._e()],1),s("div",{staticClass:"right-panel-holder",style:{width:`${t.legendSectionWidth}px`}},[s("div",{staticClass:"right-side-column"},[t._m(0),t.metrics.length>1?s("div",{staticClass:"panel-item"},[s("div",{staticClass:"metric-buttons"},t._l(t.metrics,function(r,o){return s("button",{key:r.field,staticClass:"button is-small metric-button",style:{color:t.activeMetric===r.field?"white":t.buttonColors[o],border:`1px solid ${t.buttonColors[o]}`,"background-color":t.activeMetric===r.field?t.buttonColors[o]:t.isDarkMode?"#333":"white"},on:{click:function(h){return t.handleClickedMetric(r)}}},[t._v(t._s(t.$i18n.locale==="de"?r.name_de:r.name_en))])}),0)]):t._e(),t.transitLines.length?s("b-input",{staticClass:"searchbox",staticStyle:{padding:"0rem 0.5rem 0.75rem 0"},attrs:{size:"is-small",placeholder:"Search line ID or /regex/"},model:{value:t.searchText,callback:function(r){t.searchText=r},expression:"searchText"}}):t._e(),s("div",{staticClass:"transit-lines flex-col flex1"},[s("lazy-list",{staticClass:"flex1",attrs:{highlightedTransitLines:t.highlightedTransitLines,listProps:t.routeListProps}})],1),s("div",{staticClass:"summary-stats flex-col"},[t._m(1),s("p",{style:{visibility:t.selectedRouteIds.length?"visible":"hidden"}},[s("b",[t._v(t._s(t.selectedRouteIds.length))]),t._v("¬† selected route"+t._s(t.selectedRouteIds.length!=1?"s":""))]),s("div",{staticClass:"flex-row",style:{visibility:t.selectedRouteIds.length?"visible":"hidden",gap:"0.5rem"}},[s("div",{staticClass:"aa"},[s("b",[t._v(t._s(t.summaryStats.departures))]),t._v("¬†Departures")]),t.crossFilters.length?s("div",{staticClass:"aa"},[s("b",[t._v(t._s(t.summaryStats.pax))]),t._v("¬†Passengers")]):t._e()])]),t.thumbnail?t._e():s("legend-box",{staticClass:"legend",attrs:{rows:t.legendRows},on:{click:t.clickedLegend}})],1)])])])},ue=[function(){var e=this,t=e._self._c;return e._self._setupProxy,t("p",{staticStyle:{"margin-top":"0.25rem"}},[t("b",[e._v("TRANSIT INSPECTOR")])])},function(){var e=this,t=e._self._c;return e._self._setupProxy,t("div",{staticClass:"sum-stat-title"},[t("b",[e._v("SUMMARY STATISTICS")])])}],pe=Y(he,de,ue,!1,null,"f5e55557");const je=pe.exports;export{je as default};
