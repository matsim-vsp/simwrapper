import{d as k,n as w,g as d,m as A,C as g,L as D}from"./index-D_sw2g-2.js";import{d as $}from"./index-CVL_6l40.js";import{r as I}from"./index-CwaVpBWb.js";import{Y as B}from"./index-DFKcNkqO.js";import{c as b}from"./index-B9fw0f6a.js";import{C as F}from"./CollapsiblePanel-DSPRew5z.js";import{P as M,a as x,b as z}from"./PathTraceLayer-BVrzUM5a.js";import{Z as P}from"./ZoomButtons-B4PrQ7mG.js";import{H as q,g as O,a as N}from"./HTTPFileSystem-ChhivMzi.js";import{D as j}from"./DashboardDataManager-mkjvCydQ.js";import{W as H}from"./GzipFetcher.worker-BhGsThTA.js";import{A as V}from"./arc-layer-utQsdbjp.js";import{I as W,C as G}from"./moving-icons-vehicles-layer-BE4Nsm9T.js";import{e as L,d as U}from"./threeDBuildings-eDgufgS4.js";import{M as Y}from"./mapbox-overlay-HS93bZkL.js";import{L as X,A as J}from"./layer-T9N9JmIf.js";import"./index-wQTTPj7C.js";import"./line-layer-BJTc6V-8.js";import"./fxp-DjoqftHf.js";import"./group-hI8ly2Wr.js";import"./index-_doEQLKC.js";const Z=k({name:"LegendColors",props:{title:String,description:String,values:{type:Array},items:{type:Array}}});var K=function(){var t=this,s=t._self._c;return t._self._setupProxy,s("div",{staticClass:"legend-colors flex-col"},[s("h4",[t._v(t._s(t.title))]),s("p",[t._v(t._s(t.description))]),s("ul",{staticClass:"list-items"},t._l(t.items,function(i){return s("li",{key:i.value+i.value[0],staticClass:"legend-row"},[i.label?s("div",{staticClass:"item-label"},[t._v(t._s(i.label))]):t._e(),s("div",{staticClass:"item-swatch",style:`backgroundColor: rgb(${i.color})`})])}),0)])},Q=[],tt=w(Z,K,Q,!1,null,null);const et=tt.exports,st={messages:{en:{requests:"DRT&nbsp;Requests",passengers:"Passengers",search:"Search",showhide:"Show/Hide",vehicles:"DRT Vehicles",routes:"Routes",speed:"Speed",backgroundTraffic:"All Traffic"},de:{requests:"DRT&nbsp;Anfragen",passengers:"Passagiere",search:"Suche",showhide:"Ein-/Ausblenden",vehicles:"DRT Fahrzeuge",routes:"Routen",speed:"Geschwindigkeit",backgroundTraffic:"Alle Fahrzeuge"}}},it=k({name:"XmasSettingsPanel",i18n:st,components:{ToggleButton:$.ToggleButton},props:{items:{type:Object,required:!0}}});var at=function(){var t=this,s=t._self._c;return t._self._setupProxy,s("div",{staticClass:"settings-panel-content"},[s("h4",[t._v(t._s(t.$t("showhide")))]),s("div",{staticClass:"items"},t._l(Object.keys(t.items),function(i){return s("div",{key:i,staticClass:"row"},[s("toggle-button",{staticClass:"toggle",attrs:{width:40,value:t.items[i],labels:!1,color:{checked:"#4b7cc4",unchecked:"#222"}},on:{change:function(a){return t.$emit("click",i)}}}),s("label",{domProps:{innerHTML:t._s(t.$t(i))}})],1)}),0)])},ot=[],rt=w(it,at,ot,!1,null,"d492d368");const nt=rt.exports;function lt(e){return new Worker("/simwrapper/assets/MATSimEventStreamer.worker-BOE9mVsi.js",{name:e?.name})}class ht{fileApi;linkIdLookup={};network;eventWorker;eventLayers=[];range=[1/0,-1/0];timeRange=[1/0,-1/0];$emit=()=>{};boundBox=[];params;constructor(t){this.params={...t},this.fileApi=new q(t.fileSystem),t.$emit&&(this.$emit=t.$emit),t.boundBox&&(this.boundBox=t.boundBox)}async loadFiles(){const{network:t,linkIdLookup:s}=await this.loadNetwork();this.network=t,this.linkIdLookup=s;try{let i=`${this.params.subfolder}/${this.params.vizDetails.events}`;return await this.streamEventFile(i)}catch(i){throw console.error(i),Error(""+i)}return[]}async loadNetwork(){let t=this.params.vizDetails.events.replace("events.xml","network.xml");const s=await this.params.dataManager.getRoadNetwork(t,this.params.subfolder,Object.assign({projection:"25833"},this.params.vizDetails)),i={};return s.linkIds.forEach((a,l)=>{i[`${a}`]=l}),{network:s,linkIdLookup:i}}streamEventFile(t){return new Promise((i,a)=>{const l=(c,m)=>{console.log("FINAL time",this.timeRange),this.$emit("finished"),this.eventWorker.terminate(),console.log("DONE: layers",this.eventLayers.length),console.log("ALL DONE",{totalRows:c,data:m.range,time:this.timeRange}),this.range=m.range,i(this.eventLayers)};this.$emit("status","Loading file...");let r=0;this.range=[1/0,-1/0],this.timeRange=[1/0,-1/0],this.eventWorker&&this.eventWorker.terminate(),this.eventLayers=[],this.eventWorker=new lt;const n=Intl.NumberFormat();this.eventWorker.onmessage=async c=>{const m=c.data;if(m.status)this.$emit("status",m.status);else{if(m.error)throw Error(m.error);if(m.finished){l(r,m);return}else{const S=m.events;console.log(S.length),r+=S.length,this.$emit("status","Loading "+n.format(r)+" events..."),this.timeRange=[Math.min(this.timeRange[0],S[0].time),Math.max(this.timeRange[1],S[S.length-1].time)],this.timeRange=[Math.min(this.timeRange[0],m.vehicleTrips[0].t0),Math.max(this.timeRange[1],m.vehicleTrips[m.vehicleTrips.length-1].t1)];let T=m.vehicleTrips;if(console.log("ROIGINAL LENGHT",T.length),this.boundBox.length){const o=this.network.source,u=this.network.dest;T=m.vehicleTrips.filter(y=>{const p=2*this.linkIdLookup[y.link];return o[p]>this.boundBox[0][0]&&o[p]<this.boundBox[1][0]&&o[p+1]>this.boundBox[0][1]&&o[p+1]<this.boundBox[1][1]&&u[p]>this.boundBox[0][0]&&u[p]<this.boundBox[1][0]&&u[p+1]>this.boundBox[0][1]&&u[p+1]<this.boundBox[1][1]}),console.log("FILTERED LENGTH:",T.length)}const f=T.length,h={locO:new Float32Array(2*f).fill(NaN),locD:new Float32Array(2*f).fill(NaN),t0:new Float32Array(f).fill(NaN),t1:new Float32Array(f).fill(NaN)};for(let o=0;o<f;o++){const u=T[o],y=2*this.linkIdLookup[u.link];h.locO[o*2+0]=this.network.source[0+y],h.locO[o*2+1]=this.network.source[1+y],h.locD[o*2+0]=this.network.dest[0+y],h.locD[o*2+1]=this.network.dest[1+y],o==0?(h.locO[o*2+0]=.5*(h.locO[o*2+0]+h.locD[o*2+0]),h.locO[o*2+1]=.5*(h.locO[o*2+1]+h.locD[o*2+1])):o==f-1&&(h.locD[o*2+0]=.5*(h.locO[o*2+0]+h.locD[o*2+0]),h.locD[o*2+1]=.5*(h.locO[o*2+1]+h.locD[o*2+1])),h.t0[o]=u.t0,h.t1[o]=u.t1}this.eventLayers.push({vehicles:h})}}},this.eventWorker.postMessage({filePath:t,fileSystem:this.params.fileSystem,projection:this.params.vizDetails.projection,boundBox:this.boundBox})})}}const ct={currentTime:{type:"number",value:0,min:0},getTimeStart:{type:"accessor",value:null},getTimeEnd:{type:"accessor",value:null},searchFlag:{type:"number",value:0}},R=`uniform udataUniforms {
  float currentTime;
  float searchFlag;
} udata;
`,mt={name:"udata",vs:R,fs:R,uniformTypes:{currentTime:"f32",searchFlag:"f32"}};class E extends V{getShaders(){const t=super.getShaders();return t.modules=[...t.modules,mt],t.inject={"vs:#decl":`        in float timeStart;
        in float timeEnd;
        out float vTime;
      `,"vs:#main-start":`        if (udata.searchFlag == 1.0) {
          vTime = 999.0;
        } else if (timeEnd == -1.0 || timeStart > udata.currentTime || timeEnd < udata.currentTime ) {
          vTime = -1.0;
          return;
        } else {
          float nearBeginning = udata.currentTime - timeStart;
          float nearEnd = timeEnd - udata.currentTime;
          vTime = min(nearBeginning, nearEnd);
        }
      `,"fs:#decl":`        in float vTime;
      `,"fs:#main-start":`      if (udata.searchFlag == 0.0 && vTime == -1.0 ) discard;
      `,"fs:DECKGL_FILTER_COLOR":`        if (vTime <= 10.0) color.a *= (vTime / 10.0);
      `},t}initializeState(){super.initializeState(),this.getAttributeManager()?.addInstanced({timeStart:{size:1,accessor:"getTimeStart"},timeEnd:{size:1,accessor:"getTimeEnd"}})}updateState(t){const{props:s,oldProps:i,changeFlags:a}=t;super.updateState(t);const l={currentTime:s.currentTime,searchFlag:s.searchFlag};for(const r of this.getModels())r.shaderInputs.setProps({udata:l})}}E.layerName="DrtRequestArcLayer";E.defaultProps=ct;const C="/simwrapper/",dt={circle:{x:0,y:0,width:256,height:256,mask:!0},vehicle:{x:256,y:0,width:256,height:256,mask:!0}},ut=new J({color:[255,255,255],intensity:1}),pt=new x({color:[255,255,255],intensity:2,position:[-74.05,40.7,8e3]}),_=new X({ambientLight:ut,pointLight:pt}),gt={dark:{vehicleColor:[200,130,250],trailColor0:[235,235,25],trailColor1:[23,184,190],effects:[_]},light:{vehicleColor:[200,130,250],trailColor0:[235,235,25],trailColor1:[23,184,190],effects:[_]}},v={time:0,fromX:1,fromY:2,toX:3,toY:4,arrival:6},ft=k({name:"VehicleAnimationDeckComponent",props:{colors:{type:Object,required:!0},dark:{type:Boolean,required:!0},drtRequests:{type:Array,required:!0},leftside:{type:Boolean,required:!0},mapIsIndependent:{type:Boolean,required:!0},onClick:{type:Function},paths:{type:Array,required:!0},searchEnabled:{type:Boolean,required:!0},settingsShowLayers:{type:Object,required:!0},simulationTime:{type:Number,required:!0},traces:{type:Array,required:!0},vehicleLookup:{type:Array,required:!0},viewId:{type:Number,required:!0},show3dBuildings:{type:Boolean,required:!1,default:!1}},data(){return{mymap:null,deckOverlay:null,globalState:d.state,tooltipHTML:"",tooltipStyle:{position:"absolute",padding:"4px 8px",display:"block",top:0,left:0,color:this.dark?"#ccc":"#223",backgroundColor:this.dark?"#2a3c4f":"white",zIndex:2e4}}},computed:{locale(){return this.globalState.locale},theme(){return gt[this.dark?"dark":"light"]},iconAtlas(){const e=this.leftside?"-leftside":"";return`${C}images/icon-atlas-vehicles${e}.png`},layers(){const e=[];return this.settingsShowLayers.routes&&e.push(new M({id:"Routen",data:this.traces,currentTime:this.simulationTime,getSourcePosition:t=>t.p0,getTargetPosition:t=>t.p1,getTimeStart:t=>t.t0,getTimeEnd:t=>t.t1,getColor:t=>this.colors[t.occ],getWidth:1,opacity:.7,widthMinPixels:1,rounded:!1,shadowEnabled:!1,searchFlag:this.searchEnabled?1:0,pickable:!0,autoHighlight:!0,highlightColor:[255,0,255]})),this.settingsShowLayers.vehicles&&e.push(new W({autoHighlight:!1,id:"Vehicles",billboard:!1,colorDepiction:G.VEH_OCCUPANCY,currentTime:this.simulationTime,data:this.paths,getPathStart:t=>t.p0,getPathEnd:t=>t.p1,getTimeStart:t=>t.t0,getTimeEnd:t=>t.t1,getColorCode:t=>t.occ,getBIconFrames:[256,0,256,256],getSize:this.searchEnabled?36:16,highlightColor:[255,0,255,255],iconAtlas:this.iconAtlas,iconMapping:dt,latitudeCorrectionFactor:this.latitudeCorrectionFactor,iconMoving:"vehicle",iconStill:"circle",noAlloc:!0,opacity:1,parameters:{depthTest:!1},pickable:!0,positionFormat:"XY",shadowEnabled:!1,sizeScale:1})),this.settingsShowLayers.requests&&e.push(new E({id:"DRT Requests",data:this.drtRequests,currentTime:this.simulationTime,getSourcePosition:t=>[t[v.fromX],t[v.fromY]],getTargetPosition:t=>[t[v.toX],t[v.toY]],getTimeStart:t=>t[v.time],getTimeEnd:t=>t[v.arrival],getSourceColor:[255,0,255],getTargetColor:[200,255,255],getWidth:1,opacity:.5,searchFlag:this.searchEnabled?1:0})),e},latitudeCorrectionFactor(){const e=this.globalState.viewState.latitude||this.globalState.viewState.center&&this.globalState.viewState.center[1]||35;return Math.cos(e*Math.PI/180)}},watch:{layers(){this.deckOverlay?.setProps({layers:this.layers})},dark(){const e=`${C}map-styles/${this.dark?"dark":"positron"}.json`;this.mymap?.setStyle(e)},show3dBuildings(){this.mymap&&(this.show3dBuildings?L(this.mymap):U(this.mymap))},"globalState.viewState"(){if(this.mapIsIndependent)return;const e=this.globalState.viewState,t=this.mymap?.getCenter();(e.longitude!==t.lng||e.latitude!==t.lat||e.zoom!==this.mymap?.getZoom()||e.pitch!==this.mymap?.getPitch()||e.bearing!==this.mymap?.getBearing())&&this.mymap?.jumpTo(Object.assign({center:{lng:e.longitude,lat:e.latitude}},e))}},mounted(){const e=`${C}map-styles/${this.dark?"dark":"positron"}.json`,t=`map-${this.viewId}`,s=this.globalState.viewState.center,i=this.globalState.viewState.zoom||8;this.mymap=new A.Map({container:t,style:e,center:s,zoom:i}),this.mymap.on("move",this.handleMove),this.mymap.on("style.load",()=>{this.show3dBuildings&&this.mymap&&L(this.mymap),this.deckOverlay=new Y({interleaved:!0,layers:this.layers,onClick:this.handleClick,getCursor:a=>a.isHovering?"pointer":"grab"}),this.mymap?.addControl(this.deckOverlay)})},beforeDestroy(){this.deckOverlay&&this.mymap?.removeControl(this.deckOverlay),this.mymap?.remove()},methods:{handleMove(){if(this.mapIsIndependent)return;const e=this.mymap?.getCenter(),t={latitude:e.lat,longitude:e.lng,zoom:this.mymap?.getZoom(),bearing:this.mymap?.getBearing(),pitch:this.mymap?.getPitch(),jump:!0};d.commit("setMapCamera",t)},getTooltip(e){const{x:t,y:s,object:i}=e;if(!i||!i.position||!i.position.length){this.tooltipHTML="";return}let a="";const l=this.vehicleLookup[i?.v];l&&(a+=`          <big><b>${l}</b></big><br/>
          <div>${this.locale!=="en"?"Passagiere":"Pasengers"}
        `),this.tooltipStyle.top=`${s+12}px`,this.tooltipStyle.left=`${t+12}px`,this.tooltipHTML=a},handleClick(e){this.tooltipStyle.display="none",this.onClick&&this.onClick(e?.object?.v)}}});var yt=function(){var t=this,s=t._self._c;return t._self._setupProxy,s("div",{staticClass:"deck-map flex-col"},[s("div",{staticClass:"map-container",attrs:{id:`map-${t.viewId}`}}),t.tooltipHTML?s("div",{staticClass:"deck-tooltip",style:t.tooltipStyle,domProps:{innerHTML:t._s(t.tooltipHTML)}}):t._e()])},bt=[],vt=w(ft,yt,bt,!1,null,null);const St=vt.exports,Tt={messages:{en:{requests:"DRT Requests",passengers:"Passengers",search:"Search",showhide:"Show/Hide",vehicles:"Vehicles",routes:"Routes",speed:"Speed"},de:{requests:"DRT Anfragen",passengers:"Passagiere",search:"Suche",showhide:"Ein-/Ausblenden",vehicles:"DRT Fahrzeuge",routes:"DRT Routen",speed:"Geschwindigkeit"}}},kt=k({name:"XmasVehicleAnimation",i18n:Tt,components:{CollapsiblePanel:F,SettingsPanel:nt,LegendColors:et,DeckMap:St,PlaybackControls:z,ToggleButton:$.ToggleButton,ZoomButtons:P},props:{root:{type:String,required:!0},subfolder:{type:String,required:!0},yamlConfig:String,config:Object,thumbnail:Boolean},computed:{fileApi(){return new q(this.fileSystem,d)},fileSystem(){const e=this.$store.state.svnProjects.filter(t=>t.slug===this.root);if(e.length===0)throw console.log("no such project"),Error;return e[0]},urlThumbnail(){return this.thumbnailUrl},textColor(){const e={text:"#3498db",bg:"#eeeef480"},t={text:"white",bg:"#181518aa"};return this.myState.colorScheme===g.DarkMode?t:e}},data:()=>{const e={0:[140,140,160],1:[20,224,224],2:[240,240,40],3:[240,110,30]};return{viewId:Math.floor(1e12*Math.random()),COLOR_OCCUPANCY:e,SETTINGS:{vehicles:!0,backgroundTraffic:!0,routes:!0,requests:!0},legendItems:Object.keys(e).map(t=>({type:D.line,color:e[t],value:t,label:t})),legendRequests:[{type:D.line,color:[255,0,255],value:0,label:""}],vizDetails:{network:"",drtTrips:"",projection:"",title:"",description:"",thumbnail:"",center:[13.45,52.5],zoom:12,bearing:0,pitch:20,mapIsIndependent:!1,events:"",eventBlobs:[],theme:""},show3dBuildings:!1,myState:{statusMessage:"",clock:"00:00",colorScheme:g.DarkMode,isRunning:!1,isShowingHelp:!1,subfolder:"",yamlConfig:"",thumbnail:!1,data:[]},timeStart:0,timeEnd:86400,traces:b([]),traceStart:null,traceEnd:null,traceVehicle:null,paths:b([]),pathStart:null,pathEnd:null,pathVehicle:null,requests:b([]),requestStart:null,requestEnd:null,requestVehicle:null,simulationTime:6*3600,timeElapsedSinceLastFrame:0,searchTerm:"",searchEnabled:!1,globalState:d.state,isDarkMode:d.state.colorScheme===g.DarkMode,isLoaded:!1,showHelp:!1,speedStops:[-10,-5,-2,-1,-.5,-.25,0,.25,.5,1,2,5,10],speed:1,trafficLayers:[],legendBits:[],isEmbedded:!1,thumbnailUrl:"url('assets/thumbnail.jpg') no-repeat;",vehicleLookup:[],vehicleLookupString:{},isPausedDueToHiding:!1}},watch:{async"globalState.authAttempts"(){console.log("AUTH CHANGED - Reload"),this.yamlConfig||this.buildRouteFromUrl(),await this.getVizDetails()},"globalState.colorScheme"(){this.isDarkMode=this.globalState.colorScheme===g.DarkMode,this.updateLegendColors()},searchTerm(){const e=this.vehicleLookupString[this.searchTerm];e>-1?(console.log("vehicle",e),this.pathVehicle?.filterExact(e),this.traceVehicle?.filterExact(e),this.requestVehicle?.filterExact(e),this.requestStart?.filterAll(),this.requestEnd?.filterAll(),this.searchEnabled=!0):(console.log("nope"),this.pathVehicle?.filterAll(),this.traceVehicle?.filterAll(),this.requestVehicle?.filterAll(),this.searchEnabled=!1),this.updateDatasetFilters()}},async mounted(){if(d.commit("setFullScreen",!this.thumbnail),this.myState.thumbnail=this.thumbnail,this.myState.yamlConfig=this.yamlConfig||"",this.myState.subfolder=this.subfolder,this.setEmbeddedMode(),await this.getVizDetails(),this.thumbnail)return;this.showHelp=!1,this.updateLegendColors(),this.setWallClock(),this.myState.statusMessage="/ Dateien laden...",console.log("loading files");const{trips:e,drtRequests:t}=await this.loadFiles();console.log("parsing vehicle motion"),this.myState.statusMessage=`${this.$t("vehicles")}...`,this.paths=this.parseVehicles(e),this.pathStart=this.paths.dimension(s=>s.t0),this.pathEnd=this.paths.dimension(s=>s.t1),this.pathVehicle=this.paths.dimension(s=>s.v),console.log("Routes..."),this.myState.statusMessage=`${this.$t("routes")}...`,this.traces=await this.parseRouteTraces(e),this.traceStart=this.traces.dimension(s=>s.t0),this.traceEnd=this.traces.dimension(s=>s.t1),this.traceVehicle=this.traces.dimension(s=>s.v),console.log("Requests..."),this.myState.statusMessage=`${this.$t("requests")}...`,this.requests=await this.parseDrtRequests(t),this.requestStart=this.requests.dimension(s=>s[0]),this.requestEnd=this.requests.dimension(s=>s[6]),this.requestVehicle=this.requests.dimension(s=>s[5]),this.loadBackgroundTraffic(),console.log("GO!"),this.myState.statusMessage="",document.addEventListener("visibilitychange",this.handleVisibilityChange,!1),this.myState.isRunning=!0,this.timeElapsedSinceLastFrame=Date.now(),this.animate()},beforeDestroy(){document.removeEventListener("visibilityChange",this.handleVisibilityChange),d.commit("setFullScreen",!1),this.$store.commit("setFullScreen",!1),this.myState.isRunning=!1},methods:{handleClick(e){if(e===null){this.searchTerm="";return}const t=this.vehicleLookup[e];console.log(t),this.searchTerm===t?this.searchTerm="":this.searchTerm=t},updateLegendColors(){},setWallClock(){const e=Math.floor(this.simulationTime/3600),t=Math.floor(this.simulationTime/60)%60;this.myState.clock=`${e<10?"0":""}${e}${t<10?":0":":"}${t}`},setTime(e){this.simulationTime=e,this.setWallClock(),this.traceStart&&this.pathStart&&this.requestStart&&(this.pathStart.filter([0,this.simulationTime]),this.pathEnd?.filter([this.simulationTime,1/0]),this.searchEnabled||(this.traceStart.filter([0,this.simulationTime]),this.traceEnd?.filter([this.simulationTime,1/0]),this.requestStart.filter([0,this.simulationTime]),this.requestEnd?.filter([this.simulationTime,1/0]))),this.$options.paths=this.paths.allFiltered(),this.$options.traces=this.traces.allFiltered(),this.$options.drtRequests=this.requests.allFiltered()},toggleSimulation(){console.log("CLICK !!!"),this.myState.isRunning=!this.myState.isRunning,this.timeElapsedSinceLastFrame=Date.now(),this.myState.isRunning&&this.speed===0&&(this.speed=1),this.myState.isRunning&&this.animate()},async loadBackgroundTraffic(){if(this.vizDetails.eventBlobs)for(const e of this.vizDetails.eventBlobs){const t=await this.loadBackgroundChunk(e);this.trafficLayers.push(t)}else if(this.vizDetails.events){const t=await new ht({fileSystem:this.fileSystem,dataManager:new j(this.root,this.subfolder),vizDetails:this.vizDetails,subfolder:this.subfolder}).loadFiles();this.trafficLayers=t,this.exportJSON(t)}},async loadBackgroundChunk(e){return new Promise((t,s)=>{console.log("load chunk:",e);const i=new H;i.onmessage=a=>{const r=new Float32Array(a.data.buffer).length/6,n=4,c={vehicles:{locO:new Float32Array(a.data.buffer,0,r*2),locD:new Float32Array(a.data.buffer,n*r*2,r*2),t0:new Float32Array(a.data.buffer,n*r*4,r),t1:new Float32Array(a.data.buffer,n*r*5,r)}};t(c)},i.postMessage({filePath:this.myState.subfolder+"/"+e,fileSystem:this.fileSystem})})},exportJSON(e){for(const t of e){const s=new Blob([t.vehicles.locO,t.vehicles.locD,t.vehicles.t0,t.vehicles.t1],{type:"octet/stream"}),i=URL.createObjectURL(s);let a=document.createElement("a");a.setAttribute("href",i),a.setAttribute("download","events.blob"),a.style.display="none",document.body.appendChild(a),a.click(),document.body.removeChild(a)}},setEmbeddedMode(){"embed"in this.$route.query&&(console.log("EMBEDDED MODE"),this.isEmbedded=!0,this.$store.commit("setShowLeftBar",!1),this.$store.commit("setFullWidth",!0))},async handleSettingChange(e){console.log(e),this.SETTINGS[e]=!this.SETTINGS[e],this.updateDatasetFilters(),this.simulationTime+=1},buildRouteFromUrl(){const e=this.$route.params;if(!e.project||!e.pathMatch){console.log("I CANT EVEN: NO PROJECT/PARHMATCH");return}const t=1+e.pathMatch.lastIndexOf("/"),s=e.pathMatch.substring(0,t),i=e.pathMatch.substring(t);this.myState.subfolder=s,this.myState.yamlConfig=i},async getVizDetails(){try{const s=this.myState.yamlConfig.indexOf("/")>-1?this.myState.yamlConfig:this.myState.subfolder+"/"+this.myState.yamlConfig,i=await this.fileApi.getFileText(s);this.vizDetails=B.parse(i)}catch(s){console.log("failed");const i=s;this.fileSystem.needPassword&&i.status===401&&d.commit("requestLogin",this.fileSystem.slug)}this.sync3dBuildingsSetting(),this.vizDetails.theme&&this.$store.commit("setTheme",this.vizDetails.theme);let e=this.vizDetails.center;if(e){try{typeof e=="string"&&(e=e.split(",").map(Number)),this.vizDetails.center=e}catch{this.$emit("error",'center must be "long,lat"'),e=[13.45,52.5],this.vizDetails.zoom=3}this.$store.commit("setMapCamera",{center:e,zoom:this.vizDetails.zoom||9,pitch:0,bearing:0,jump:!0})}const t=this.vizDetails.title?this.vizDetails.title:"Agent Animation";this.$emit("title",t),await this.buildThumbnail(),this.isLoaded=!0},sync3dBuildingsSetting(){this.show3dBuildings=!!(this.vizDetails.buildings3d??this.vizDetails.show3dBuildings)},toggle3dBuildings(){this.show3dBuildings=!this.show3dBuildings},async buildThumbnail(){if(this.thumbnail&&this.vizDetails.thumbnail)try{const e=await this.fileApi.getFileBlob(this.myState.subfolder+"/"+this.vizDetails.thumbnail),t=await I.arraybuffer(e),s=N(t);s&&(this.thumbnailUrl=`center / cover no-repeat url(data:image/png;base64,${s})`)}catch(e){console.error(e)}},async parseDrtRequests(e){if(this.vehicleLookup.length)for(const t of e)try{t[5]=this.vehicleLookupString[t[5]]}catch{}return b(e)},parseVehicles(e){const t=[];let s=-1,i=[0,0];for(const a of e){const l=a.path,r=a.timestamps,n=a.passengers;i[0]+=l[0][0],i[1]+=l[0][1],s++,this.vehicleLookup[s]=a.id,this.vehicleLookupString[a.id]=s;for(let c=0;c<a.path.length-1;c++)t.push({t0:r[c],t1:r[c+1],p0:l[c],p1:l[c+1],v:s,occ:n[c]})}return this.vizDetails.center||(i[0]/=e.length,i[1]/=e.length,this.vizDetails.center=i,d.commit("setMapCamera",{center:i,zoom:9,pitch:0,bearing:0,jump:!0})),b(t)},updateDatasetFilters(){!this.traceStart||!this.pathStart||!this.requestStart||(this.SETTINGS.routes&&(this.searchEnabled?(this.traceStart.filterAll(),this.traceEnd?.filterAll()):(this.traceStart.filter([0,this.simulationTime]),this.traceEnd?.filter([this.simulationTime,1/0])),this.$options.traces=this.traces.allFiltered()),this.SETTINGS.vehicles&&(this.pathStart.filter([0,this.simulationTime]),this.pathEnd?.filter([this.simulationTime,1/0]),this.$options.paths=this.paths.allFiltered()),this.SETTINGS.requests&&(this.searchEnabled?(this.requestStart.filterAll(),this.requestEnd?.filterAll()):(this.requestStart.filter([0,this.simulationTime]),this.requestEnd?.filter([this.simulationTime,1/0])),this.$options.drtRequests=this.requests.allFiltered()))},animate(){if(this.myState.isRunning){const e=Date.now()-this.timeElapsedSinceLastFrame;this.timeElapsedSinceLastFrame+=e,this.simulationTime+=e*this.speed*.05,this.updateDatasetFilters(),this.setWallClock(),window.requestAnimationFrame(this.animate)}},handleVisibilityChange(){this.isPausedDueToHiding&&!document.hidden?(console.log("unpausing"),this.isPausedDueToHiding=!1,this.toggleSimulation()):this.myState.isRunning&&document.hidden&&(console.log("pausing"),this.isPausedDueToHiding=!0,this.toggleSimulation())},async parseRouteTraces(e){let t=-1;const s=[];for(const i of e){t++;let a=i.timestamps[0],l=i.timestamps[0],r=[];for(let n=1;n<i.path.length;n++)l=i.timestamps[n],i.path[n][0]===i.path[n-1][0]&&i.path[n][1]===i.path[n-1][1]?(r.forEach(c=>{c.t1=i.timestamps[n-1]}),s.push(...r),r=[],a=l):r.push({t0:a,p0:i.path[n-1],p1:i.path[n],v:t,occ:i.passengers[n-1]});r.forEach(n=>{n.t1=l}),s.push(...r)}return b(s)},async loadFiles(){if(!this.fileApi)return{trips:[],drtRequests:{}};let e=[],t=[];try{if(this.vizDetails.drtTrips.endsWith("json")){const s=await this.fileApi.getFileJson(this.myState.subfolder+"/"+this.vizDetails.drtTrips);e=s.trips,t=s.drtRequests}else if(this.vizDetails.drtTrips.endsWith("gz")){const i=await(await this.fileApi.getFileBlob(this.myState.subfolder+"/"+this.vizDetails.drtTrips)).arrayBuffer(),a=await O(i),l=new TextDecoder("utf-8").decode(a),r=JSON.parse(l);e=r.trips,t=r.drtRequests}}catch(s){console.error(s),this.myState.statusMessage=""+s}return{trips:e,drtRequests:t}},toggleLoaded(e){this.isLoaded=e},rotateColors(){this.myState.colorScheme=this.myState.colorScheme===g.DarkMode?g.LightMode:g.DarkMode,localStorage.setItem("plugin/agent-animation/colorscheme",this.myState.colorScheme)}}});var wt=function(){var t=this,s=t._self._c;return t._self._setupProxy,s("div",{staticClass:"gl-app",class:{"hide-thumbnail":!t.thumbnail},style:{background:t.urlThumbnail},attrs:{oncontextmenu:"return false"}},[!t.thumbnail&&t.isLoaded?s("deck-map",{staticClass:"anim",attrs:{colors:t.COLOR_OCCUPANCY,drtRequests:t.$options.drtRequests||[],dark:t.globalState.isDarkMode,leftside:t.vizDetails.leftside||!1,mapIsIndependent:!1,paths:t.$options.paths,settingsShowLayers:t.SETTINGS,searchEnabled:t.searchEnabled,simulationTime:t.simulationTime,traces:t.$options.traces||[],vehicleLookup:t.vehicleLookup,viewId:t.viewId,trafficLayers:t.trafficLayers,onClick:t.handleClick,show3dBuildings:t.show3dBuildings}}):t._e(),t.thumbnail?t._e():s("zoom-buttons",{attrs:{show3dToggle:!0,is3dBuildings:t.show3dBuildings,onToggle3dBuildings:t.toggle3dBuildings}}),s("div",{staticClass:"bottom-controls-mobile"},[s("div",{staticClass:"big clock"},[s("p",[t._v(t._s(t.myState.clock))])]),t.legendItems.length?s("legend-colors",{staticClass:"legend-block",attrs:{mobile:!0,title:`${t.$t("passengers")}:`,items:t.legendItems}}):t._e(),s("settings-panel",{staticClass:"settings-area",attrs:{items:t.SETTINGS},on:{click:t.handleSettingChange}})],1),t.isLoaded&&!t.thumbnail?s("div",{staticClass:"right-side"},[s("collapsible-panel",{attrs:{direction:"right"}},[s("div",{staticClass:"big clock"},[s("p",[t._v(t._s(t.myState.clock))])]),s("div",{staticClass:"panel-items"},[t.legendItems.length?s("legend-colors",{staticClass:"legend-block",attrs:{title:`${t.$t("passengers")}:`,items:t.legendItems}}):t._e(),s("legend-colors",{staticClass:"legend-block",attrs:{title:`${t.$t("requests")}:`,items:t.legendRequests,mobile:!1}}),s("settings-panel",{staticClass:"settings-area",attrs:{items:t.SETTINGS},on:{click:t.handleSettingChange}}),s("div",{staticClass:"speed-block"},[s("p",{staticClass:"speed-label"},[t._v(t._s(t.$t("speed"))+":"),s("br"),t._v(t._s(t.speed)+"x")]),s("b-slider",{staticClass:"speed-slider",attrs:{min:t.speedStops[0],max:t.speedStops[t.speedStops.length-1],duration:0,dotSize:20,tooltip:!0,"tooltip-placement":"bottom","tooltip-formatter":i=>i+"x"},model:{value:t.speed,callback:function(i){t.speed=i},expression:"speed"}},[t._l(t.speedStops,function(i){return[s("b-slider-tick",{key:i,attrs:{value:i}})]})],2)],1)],1)])],1):t._e(),!t.thumbnail&&t.isLoaded?s("playback-controls",{staticClass:"bottom-area",attrs:{timeStart:t.timeStart,timeEnd:t.timeEnd,isRunning:t.myState.isRunning,currentTime:t.simulationTime},on:{click:t.toggleSimulation,time:t.setTime}}):t._e()],1)},Ct=[],Et=w(kt,wt,Ct,!1,null,"8ccfa7a7");const Ut=Et.exports;export{Ut as default};
